<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.189">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>My Awesome Introductory Machine Learning Blog – training</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>
    .quarto-title-block .quarto-title-banner {
      color: white;
background-image: url(../../../img/landscape.png);
background-size: cover;
    }
    </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">My Awesome Introductory Machine Learning Blog</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html">About</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/trongdle"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/duc-trong-le-5a2654224/"><i class="bi bi-linkedin" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">



<p><a href="https://colab.research.google.com/github/kennyerss/csci451-project/blob/main/code/CS451.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a></p>
<div class="cell" data-outputid="25fa6003-adee-4b8c-ea26-2d1f5aca5dac" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">--</span>upgrade efficientnet<span class="op">-</span>pytorch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Looking in indexes: https://pypi.org/simple, https://us-python.pkg.dev/colab-wheels/public/simple/
Collecting efficientnet-pytorch
  Downloading efficientnet_pytorch-0.7.1.tar.gz (21 kB)
  Preparing metadata (setup.py) ... done
Requirement already satisfied: torch in /usr/local/lib/python3.10/dist-packages (from efficientnet-pytorch) (2.0.1+cu118)
Requirement already satisfied: filelock in /usr/local/lib/python3.10/dist-packages (from torch-&gt;efficientnet-pytorch) (3.12.0)
Requirement already satisfied: typing-extensions in /usr/local/lib/python3.10/dist-packages (from torch-&gt;efficientnet-pytorch) (4.5.0)
Requirement already satisfied: sympy in /usr/local/lib/python3.10/dist-packages (from torch-&gt;efficientnet-pytorch) (1.11.1)
Requirement already satisfied: networkx in /usr/local/lib/python3.10/dist-packages (from torch-&gt;efficientnet-pytorch) (3.1)
Requirement already satisfied: jinja2 in /usr/local/lib/python3.10/dist-packages (from torch-&gt;efficientnet-pytorch) (3.1.2)
Requirement already satisfied: triton==2.0.0 in /usr/local/lib/python3.10/dist-packages (from torch-&gt;efficientnet-pytorch) (2.0.0)
Requirement already satisfied: cmake in /usr/local/lib/python3.10/dist-packages (from triton==2.0.0-&gt;torch-&gt;efficientnet-pytorch) (3.25.2)
Requirement already satisfied: lit in /usr/local/lib/python3.10/dist-packages (from triton==2.0.0-&gt;torch-&gt;efficientnet-pytorch) (16.0.5)
Requirement already satisfied: MarkupSafe&gt;=2.0 in /usr/local/lib/python3.10/dist-packages (from jinja2-&gt;torch-&gt;efficientnet-pytorch) (2.1.2)
Requirement already satisfied: mpmath&gt;=0.19 in /usr/local/lib/python3.10/dist-packages (from sympy-&gt;torch-&gt;efficientnet-pytorch) (1.3.0)
Building wheels for collected packages: efficientnet-pytorch
  Building wheel for efficientnet-pytorch (setup.py) ... done
  Created wheel for efficientnet-pytorch: filename=efficientnet_pytorch-0.7.1-py3-none-any.whl size=16427 sha256=37f5691b17c5e0006886256485235c29a705f62f40f678998c7c982e58d03385
  Stored in directory: /root/.cache/pip/wheels/03/3f/e9/911b1bc46869644912bda90a56bcf7b960f20b5187feea3baf
Successfully built efficientnet-pytorch
Installing collected packages: efficientnet-pytorch
Successfully installed efficientnet-pytorch-0.7.1</code></pre>
</div>
</div>
<div class="cell" data-outputid="65ac2a3f-a9ed-42fe-853f-6967ef87d304" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#need to import Drive</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.colab <span class="im">import</span> drive</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>drive.mount(<span class="st">'/content/drive'</span>, force_remount<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mounted at /content/drive</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Set your working directory to a folder in your Google Drive. This way, if your notebook times out,</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># your files will be saved in your Google Drive!</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># the base Google Drive directory</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>root_dir <span class="op">=</span> <span class="st">"/content/drive/Shareddrives/"</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># choose where you want your project files to be saved</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>project_folder <span class="op">=</span> <span class="st">"CheXpert-v1.0-small/"</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_and_set_working_directory(project_folder):</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># check if your project folder exists. if not, it will be created.</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> os.path.isdir(root_dir <span class="op">+</span> project_folder) <span class="op">==</span> <span class="va">False</span>:</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    os.mkdir(root_dir <span class="op">+</span> project_folder)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(root_dir <span class="op">+</span> project_folder <span class="op">+</span> <span class="st">' did not exist but was created.'</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># change the OS to use your project folder as the working directory</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  os.chdir(root_dir <span class="op">+</span> project_folder)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create a test file to make sure it shows up in the right place</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>create_and_set_working_directory(project_folder)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="image-visualization" class="level2">
<h2 class="anchored" data-anchor-id="image-visualization">Image Visualization</h2>
<div class="cell" data-outputid="2b7cd291-9909-48f6-cd95-e437d5c8d244" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#This just will show the images</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> cv2.imread(<span class="st">'/content/drive/Shareddrives/CheXpert-v1.0-small/train/patient00142/study3/view1_frontal.jpg'</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">#img = cv2.imread('/content/drive/MyDrive/chexpert_small/train/patient00974/study1/view1_frontal.jpg')</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>plt.imshow(img)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">"off"</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-5-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="data-analysis" class="level2">
<h2 class="anchored" data-anchor-id="data-analysis">Data Analysis</h2>
<p>We have a few different dataframes to work on. The first is what we define as df_race, which gives the patients race and ethnicity based on their ID. Here we define a sorted version so the patients will be in order by their ID.</p>
<div class="cell" data-outputid="ee6ff2c0-648b-49e5-8507-496322b1913a" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import our race data set and load as a dataframe</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>df_race <span class="op">=</span> pd.read_excel(<span class="st">'/content/drive/Shareddrives/CheXpert-v1.0-small/chexpert_race.xlsx'</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>df_race_sorted <span class="op">=</span> df_race.sort_values(by<span class="op">=</span>[<span class="st">'PATIENT'</span>],ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>df_race_sorted <span class="op">=</span> df_race_sorted.dropna()</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>df_race_sorted</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">


  <div id="df-fa4bb08c-c3e6-4d0c-be4b-904084647e8b">
    <div class="colab-df-container">
      <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>PATIENT</th>
      <th>GENDER</th>
      <th>AGE_AT_CXR</th>
      <th>PRIMARY_RACE</th>
      <th>ETHNICITY</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>patient00001</td>
      <td>Female</td>
      <td>68</td>
      <td>Other</td>
      <td>Non-Hispanic/Non-Latino</td>
    </tr>
    <tr>
      <th>1</th>
      <td>patient00002</td>
      <td>Female</td>
      <td>87</td>
      <td>White, non-Hispanic</td>
      <td>Non-Hispanic/Non-Latino</td>
    </tr>
    <tr>
      <th>2</th>
      <td>patient00003</td>
      <td>Male</td>
      <td>41</td>
      <td>White, non-Hispanic</td>
      <td>Non-Hispanic/Non-Latino</td>
    </tr>
    <tr>
      <th>3</th>
      <td>patient00004</td>
      <td>Female</td>
      <td>20</td>
      <td>Black or African American</td>
      <td>Non-Hispanic/Non-Latino</td>
    </tr>
    <tr>
      <th>4</th>
      <td>patient00005</td>
      <td>Male</td>
      <td>33</td>
      <td>White</td>
      <td>Non-Hispanic/Non-Latino</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>65396</th>
      <td>patient65731</td>
      <td>Female</td>
      <td>64</td>
      <td>White</td>
      <td>Non-Hispanic/Non-Latino</td>
    </tr>
    <tr>
      <th>65397</th>
      <td>patient65732</td>
      <td>Female</td>
      <td>0</td>
      <td>Asian</td>
      <td>Non-Hispanic/Non-Latino</td>
    </tr>
    <tr>
      <th>65398</th>
      <td>patient65735</td>
      <td>Female</td>
      <td>1</td>
      <td>White</td>
      <td>Non-Hispanic/Non-Latino</td>
    </tr>
    <tr>
      <th>65399</th>
      <td>patient65739</td>
      <td>Female</td>
      <td>44</td>
      <td>Unknown</td>
      <td>Non-Hispanic/Non-Latino</td>
    </tr>
    <tr>
      <th>65400</th>
      <td>patient65740</td>
      <td>Female</td>
      <td>75</td>
      <td>Asian</td>
      <td>Non-Hispanic/Non-Latino</td>
    </tr>
  </tbody>
</table>
<p>64855 rows × 5 columns</p>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-fa4bb08c-c3e6-4d0c-be4b-904084647e8b')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-fa4bb08c-c3e6-4d0c-be4b-904084647e8b button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-fa4bb08c-c3e6-4d0c-be4b-904084647e8b');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<div class="cell" data-outputid="ee918674-63fd-4dc4-fce3-fe7c4c05c20e" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># print the unique labels for race - we need to make some determinations here</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_race_sorted[<span class="st">'PRIMARY_RACE'</span>].unique())</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>white_no <span class="op">=</span> (df_race_sorted[<span class="st">'PRIMARY_RACE'</span>].<span class="bu">str</span>.contains(<span class="st">'White'</span>)).<span class="bu">sum</span>()</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>black_no <span class="op">=</span> (df_race_sorted[<span class="st">'PRIMARY_RACE'</span>].<span class="bu">str</span>.contains(<span class="st">'Black'</span>)).<span class="bu">sum</span>()</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>asian_no <span class="op">=</span> (df_race_sorted[<span class="st">'PRIMARY_RACE'</span>].<span class="bu">str</span>.contains(<span class="st">'Asian'</span>)).<span class="bu">sum</span>()</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>native_no <span class="op">=</span> (df_race_sorted[<span class="st">'PRIMARY_RACE'</span>].<span class="bu">str</span>.contains(<span class="st">'Native American'</span>)).<span class="bu">sum</span>()</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>native_no <span class="op">+=</span> (df_race_sorted[<span class="st">'PRIMARY_RACE'</span>].<span class="bu">str</span>.contains(<span class="st">'Indian'</span>)).<span class="bu">sum</span>()</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>islander_no <span class="op">=</span> (df_race_sorted[<span class="st">'PRIMARY_RACE'</span>].<span class="bu">str</span>.contains(<span class="st">'Pacific'</span>)).<span class="bu">sum</span>()</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>rest_no <span class="op">=</span> <span class="bu">len</span>(df_race_sorted) <span class="op">-</span> white_no <span class="op">-</span> black_no <span class="op">-</span> asian_no <span class="op">-</span> native_no <span class="op">-</span> islander_no</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'White: '</span> <span class="op">+</span> <span class="bu">str</span>(white_no) <span class="op">+</span> <span class="st">'</span><span class="ch">\n</span><span class="st"> Asian: '</span> <span class="op">+</span> <span class="bu">str</span>(asian_no) <span class="op">+</span> <span class="st">'</span><span class="ch">\n</span><span class="st"> Black: '</span> <span class="op">+</span> <span class="bu">str</span>(black_no) <span class="op">+</span> <span class="st">'</span><span class="ch">\n</span><span class="st"> Native American: '</span> <span class="op">+</span> <span class="bu">str</span>(native_no) <span class="op">+</span> <span class="st">'</span><span class="ch">\n</span><span class="st"> Pacific Islander: '</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="op">+</span> <span class="bu">str</span>(islander_no) <span class="op">+</span> <span class="st">'</span><span class="ch">\n</span><span class="st"> Other/Unknown: '</span> <span class="op">+</span> <span class="bu">str</span>(rest_no))</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> [<span class="st">'White'</span>, <span class="st">'Asian'</span>, <span class="st">'Black'</span>]</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>sizes <span class="op">=</span> [white_no, asian_no, black_no]</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>plt.pie(sizes, labels <span class="op">=</span> labels, autopct<span class="op">=</span><span class="st">'</span><span class="sc">%1.1f%%</span><span class="st">'</span>,</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>       pctdistance<span class="op">=</span><span class="fl">1.25</span>, labeldistance<span class="op">=</span><span class="fl">1.6</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Demographic Distribution in Original Training Dataset'</span>)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['Other' 'White, non-Hispanic' 'Black or African American' 'White'
 'Native Hawaiian or Other Pacific Islander' 'Asian' 'Asian, non-Hispanic'
 'Unknown' 'Native American, non-Hispanic' 'Race and Ethnicity Unknown'
 'White, Hispanic' 'Other, Hispanic' 'Black, non-Hispanic'
 'American Indian or Alaska Native' 'Patient Refused'
 'Other, non-Hispanic' 'Pacific Islander, Hispanic' 'Black, Hispanic'
 'Pacific Islander, non-Hispanic' 'White or Caucasian' 'Asian, Hispanic'
 'Native American, Hispanic' 'Asian - Historical Conv']
White: 36768
 Asian: 7061
 Black: 3147
 Native American: 181
 Pacific Islander: 881
 Other/Unknown: 16817</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-7-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="c05966f7-ca91-4dd9-e867-51243ed9bb20" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>df_race.groupby([<span class="st">'GENDER'</span>, <span class="st">'PRIMARY_RACE'</span>]).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>FutureWarning: The default value of numeric_only in DataFrameGroupBy.mean is deprecated. In a future version, numeric_only will default to False. Either specify numeric_only or select only columns which should be valid for the function.
  df_race.groupby(['GENDER', 'PRIMARY_RACE']).mean()</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="8">


  <div id="df-606a4811-041b-4ded-91e4-520eb2d5eb8c">
    <div class="colab-df-container">
      <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th>AGE_AT_CXR</th>
    </tr>
    <tr>
      <th>GENDER</th>
      <th>PRIMARY_RACE</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="23" valign="top">Female</th>
      <th>American Indian or Alaska Native</th>
      <td>56.855422</td>
    </tr>
    <tr>
      <th>Asian</th>
      <td>61.089804</td>
    </tr>
    <tr>
      <th>Asian - Historical Conv</th>
      <td>25.000000</td>
    </tr>
    <tr>
      <th>Asian, Hispanic</th>
      <td>60.000000</td>
    </tr>
    <tr>
      <th>Asian, non-Hispanic</th>
      <td>63.362667</td>
    </tr>
    <tr>
      <th>Black or African American</th>
      <td>55.641553</td>
    </tr>
    <tr>
      <th>Black, Hispanic</th>
      <td>54.545455</td>
    </tr>
    <tr>
      <th>Black, non-Hispanic</th>
      <td>60.887029</td>
    </tr>
    <tr>
      <th>Native American, Hispanic</th>
      <td>71.250000</td>
    </tr>
    <tr>
      <th>Native American, non-Hispanic</th>
      <td>55.818182</td>
    </tr>
    <tr>
      <th>Native Hawaiian or Other Pacific Islander</th>
      <td>50.019465</td>
    </tr>
    <tr>
      <th>Other</th>
      <td>55.001051</td>
    </tr>
    <tr>
      <th>Other, Hispanic</th>
      <td>57.885922</td>
    </tr>
    <tr>
      <th>Other, non-Hispanic</th>
      <td>56.272727</td>
    </tr>
    <tr>
      <th>Pacific Islander, Hispanic</th>
      <td>57.000000</td>
    </tr>
    <tr>
      <th>Pacific Islander, non-Hispanic</th>
      <td>60.844444</td>
    </tr>
    <tr>
      <th>Patient Refused</th>
      <td>54.409091</td>
    </tr>
    <tr>
      <th>Race and Ethnicity Unknown</th>
      <td>60.310212</td>
    </tr>
    <tr>
      <th>Unknown</th>
      <td>59.574136</td>
    </tr>
    <tr>
      <th>White</th>
      <td>64.096811</td>
    </tr>
    <tr>
      <th>White or Caucasian</th>
      <td>37.333333</td>
    </tr>
    <tr>
      <th>White, Hispanic</th>
      <td>59.041322</td>
    </tr>
    <tr>
      <th>White, non-Hispanic</th>
      <td>67.988264</td>
    </tr>
    <tr>
      <th rowspan="22" valign="top">Male</th>
      <th>American Indian or Alaska Native</th>
      <td>54.546875</td>
    </tr>
    <tr>
      <th>Asian</th>
      <td>60.323556</td>
    </tr>
    <tr>
      <th>Asian, Hispanic</th>
      <td>73.250000</td>
    </tr>
    <tr>
      <th>Asian, non-Hispanic</th>
      <td>62.407240</td>
    </tr>
    <tr>
      <th>Black or African American</th>
      <td>54.075443</td>
    </tr>
    <tr>
      <th>Black, Hispanic</th>
      <td>55.000000</td>
    </tr>
    <tr>
      <th>Black, non-Hispanic</th>
      <td>53.776978</td>
    </tr>
    <tr>
      <th>Native American, Hispanic</th>
      <td>45.111111</td>
    </tr>
    <tr>
      <th>Native American, non-Hispanic</th>
      <td>49.300000</td>
    </tr>
    <tr>
      <th>Native Hawaiian or Other Pacific Islander</th>
      <td>54.032258</td>
    </tr>
    <tr>
      <th>Other</th>
      <td>52.828869</td>
    </tr>
    <tr>
      <th>Other, Hispanic</th>
      <td>49.538240</td>
    </tr>
    <tr>
      <th>Other, non-Hispanic</th>
      <td>59.725664</td>
    </tr>
    <tr>
      <th>Pacific Islander, Hispanic</th>
      <td>47.000000</td>
    </tr>
    <tr>
      <th>Pacific Islander, non-Hispanic</th>
      <td>52.877551</td>
    </tr>
    <tr>
      <th>Patient Refused</th>
      <td>54.325581</td>
    </tr>
    <tr>
      <th>Race and Ethnicity Unknown</th>
      <td>57.626587</td>
    </tr>
    <tr>
      <th>Unknown</th>
      <td>57.316144</td>
    </tr>
    <tr>
      <th>White</th>
      <td>62.296407</td>
    </tr>
    <tr>
      <th>White or Caucasian</th>
      <td>29.500000</td>
    </tr>
    <tr>
      <th>White, Hispanic</th>
      <td>50.898396</td>
    </tr>
    <tr>
      <th>White, non-Hispanic</th>
      <td>63.368680</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-606a4811-041b-4ded-91e4-520eb2d5eb8c')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-606a4811-041b-4ded-91e4-520eb2d5eb8c button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-606a4811-041b-4ded-91e4-520eb2d5eb8c');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<p>Looking at the ethnicities, we can see the main groups are Hispanic/Latino and Non-Hispanic/Non-Latino (along with Not Hispanic which is a bit confusing). The Unknown or Patient Refused Categories also exist of course.</p>
<div class="cell" data-outputid="2298aa15-4a66-4ffb-e343-456988795a86" data-execution_count="9">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#print the unique labels for ethnicity</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_race[<span class="st">'ETHNICITY'</span>].unique())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['Non-Hispanic/Non-Latino' 'Hispanic/Latino' 'Unknown' nan
 'Patient Refused' 'Hispanic' 'Not Hispanic']</code></pre>
</div>
</div>
<div class="cell" data-outputid="ee7064e2-809d-4e45-93b7-3dcb44411045" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#subset data by the "Other" listed for Race</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>df_race[df_race[<span class="st">'PRIMARY_RACE'</span>] <span class="op">==</span> <span class="st">'Other'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">


  <div id="df-145e8d51-ba29-4c95-bcf3-683cebec05a6">
    <div class="colab-df-container">
      <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>PATIENT</th>
      <th>GENDER</th>
      <th>AGE_AT_CXR</th>
      <th>PRIMARY_RACE</th>
      <th>ETHNICITY</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>patient48289</td>
      <td>Female</td>
      <td>39</td>
      <td>Other</td>
      <td>Hispanic/Latino</td>
    </tr>
    <tr>
      <th>13</th>
      <td>patient51575</td>
      <td>Male</td>
      <td>68</td>
      <td>Other</td>
      <td>Hispanic/Latino</td>
    </tr>
    <tr>
      <th>32</th>
      <td>patient28670</td>
      <td>Male</td>
      <td>63</td>
      <td>Other</td>
      <td>Hispanic/Latino</td>
    </tr>
    <tr>
      <th>53</th>
      <td>patient65275</td>
      <td>Female</td>
      <td>59</td>
      <td>Other</td>
      <td>Non-Hispanic/Non-Latino</td>
    </tr>
    <tr>
      <th>61</th>
      <td>patient54887</td>
      <td>Male</td>
      <td>74</td>
      <td>Other</td>
      <td>Hispanic/Latino</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>65386</th>
      <td>patient33297</td>
      <td>Female</td>
      <td>40</td>
      <td>Other</td>
      <td>Hispanic/Latino</td>
    </tr>
    <tr>
      <th>65390</th>
      <td>patient15562</td>
      <td>Female</td>
      <td>50</td>
      <td>Other</td>
      <td>Hispanic/Latino</td>
    </tr>
    <tr>
      <th>65395</th>
      <td>patient32620</td>
      <td>Female</td>
      <td>21</td>
      <td>Other</td>
      <td>Hispanic/Latino</td>
    </tr>
    <tr>
      <th>65396</th>
      <td>patient65702</td>
      <td>Male</td>
      <td>1</td>
      <td>Other</td>
      <td>Hispanic/Latino</td>
    </tr>
    <tr>
      <th>65397</th>
      <td>patient04979</td>
      <td>Female</td>
      <td>27</td>
      <td>Other</td>
      <td>Hispanic/Latino</td>
    </tr>
  </tbody>
</table>
<p>8510 rows × 5 columns</p>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-145e8d51-ba29-4c95-bcf3-683cebec05a6')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-145e8d51-ba29-4c95-bcf3-683cebec05a6 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-145e8d51-ba29-4c95-bcf3-683cebec05a6');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<p>Our next important dataframe is df_patients, which holds a csv of image links with the sex, age, and other features of the patients related to their hospitalization. Notice that the patient ID is included inside the text for the links. Also, notice that one patient can have multiple images from different visiting times. Images are in two categories frontal and lateral (front of body vs.&nbsp;side of body).</p>
<div class="cell" data-outputid="2ccefd90-b153-422e-c05a-325326b54f59" data-execution_count="11">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>df_patients <span class="op">=</span> pd.read_csv(<span class="st">'/content/drive/Shareddrives/CheXpert-v1.0-small/train.csv'</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>df_patients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">


  <div id="df-e4e3106b-f41d-446b-8880-10a995617402">
    <div class="colab-df-container">
      <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Path</th>
      <th>Sex</th>
      <th>Age</th>
      <th>Frontal/Lateral</th>
      <th>AP/PA</th>
      <th>No Finding</th>
      <th>Enlarged Cardiomediastinum</th>
      <th>Cardiomegaly</th>
      <th>Lung Opacity</th>
      <th>Lung Lesion</th>
      <th>Edema</th>
      <th>Consolidation</th>
      <th>Pneumonia</th>
      <th>Atelectasis</th>
      <th>Pneumothorax</th>
      <th>Pleural Effusion</th>
      <th>Pleural Other</th>
      <th>Fracture</th>
      <th>Support Devices</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>CheXpert-v1.0-small/train/patient00001/study1/...</td>
      <td>Female</td>
      <td>68</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>CheXpert-v1.0-small/train/patient00002/study2/...</td>
      <td>Female</td>
      <td>87</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>-1.0</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>CheXpert-v1.0-small/train/patient00002/study1/...</td>
      <td>Female</td>
      <td>83</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>CheXpert-v1.0-small/train/patient00002/study1/...</td>
      <td>Female</td>
      <td>83</td>
      <td>Lateral</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>CheXpert-v1.0-small/train/patient00003/study1/...</td>
      <td>Male</td>
      <td>41</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>223409</th>
      <td>CheXpert-v1.0-small/train/patient64537/study2/...</td>
      <td>Male</td>
      <td>59</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>223410</th>
      <td>CheXpert-v1.0-small/train/patient64537/study1/...</td>
      <td>Male</td>
      <td>59</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>-1.0</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>223411</th>
      <td>CheXpert-v1.0-small/train/patient64538/study1/...</td>
      <td>Female</td>
      <td>0</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>223412</th>
      <td>CheXpert-v1.0-small/train/patient64539/study1/...</td>
      <td>Female</td>
      <td>0</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>223413</th>
      <td>CheXpert-v1.0-small/train/patient64540/study1/...</td>
      <td>Female</td>
      <td>0</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>223414 rows × 19 columns</p>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-e4e3106b-f41d-446b-8880-10a995617402')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-e4e3106b-f41d-446b-8880-10a995617402 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-e4e3106b-f41d-446b-8880-10a995617402');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<p>We do some basic data cleaning by adding a column for the patient ID (extracted from the image links). We also turn race into numeric categories: 0 - White, 1 - Black, 2 - Asian, 3 - Other. Notice that the first three groups, any race identification containing White, for example, whether ‘White, Hispanic’ or ‘White, Caucasian’ will be classified as white.</p>
<div class="cell" data-outputid="373d90d7-5a27-4f0e-ae98-77405771de1b" data-execution_count="12">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#again, df_patients['PATIENT'] holds links for the file directory, here I split so instead I can have the patient ID</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>df_patients[<span class="st">'PATIENT'</span>] <span class="op">=</span> [df_patients[<span class="st">'Path'</span>][i].split(<span class="st">"/"</span>)[<span class="dv">2</span>] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(df_patients.shape[<span class="dv">0</span>])]</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">#I then merge the patient race with df_race_sorted, which will give me the patient ID - race</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>df_patients_race <span class="op">=</span> pd.merge(df_patients,df_race_sorted,on<span class="op">=</span><span class="st">'PATIENT'</span>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">#check</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co">for index, row in df_patients_race[206949:].iterrows():</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co">  race_sorted_index = df_race_sorted.index[df_race_sorted["PATIENT"] == row["PATIENT"]].tolist()</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co">  if (len(race_sorted_index) != 1):</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co">    print("error!")</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co">    break</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co">  i = race_sorted_index[0]</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co">  if not (row['PATIENT'] in row['Path']):</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co">    print(row,"patient error!")</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co">    break</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co">  if not (row['ETHNICITY'] == df_race_sorted["ETHNICITY"][i]):</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="co">    print(row,"ethnicity error!",row['ETHNICITY'],df_race_sorted["ETHNICITY"][i])</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="co">    break</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="co">  if not (row['PRIMARY_RACE'] == df_race_sorted["PRIMARY_RACE"][i]):</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="co">    print(row,"race error!")</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="co">    break</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="co">  if not (row['Sex'] == df_race_sorted["GENDER"][i]):</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="co">    print(row,"sex error!")</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="co">    break</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="co">#there is a gender error for patient 51668, index 202352</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a><span class="co"># gender error for patient 54170, index 206312</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="co"># gender error for patient 54565, index 206948</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> race_to_num(string):</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="st">'White'</span> <span class="kw">in</span> string:</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">elif</span> <span class="st">'Black'</span> <span class="kw">in</span> string:</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">elif</span> <span class="st">'Asian'</span> <span class="kw">in</span> string:</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">2</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>:</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">3</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>df_patients_race[<span class="st">"RACE_NUM"</span>] <span class="op">=</span> [race_to_num(df_patients_race[<span class="st">"PRIMARY_RACE"</span>][i]) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(df_patients_race))]</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>df_patients_race</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">


  <div id="df-58212ca5-d0e1-4b5d-9e35-c7d233781e8b">
    <div class="colab-df-container">
      <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Path</th>
      <th>Sex</th>
      <th>Age</th>
      <th>Frontal/Lateral</th>
      <th>AP/PA</th>
      <th>No Finding</th>
      <th>Enlarged Cardiomediastinum</th>
      <th>Cardiomegaly</th>
      <th>Lung Opacity</th>
      <th>Lung Lesion</th>
      <th>...</th>
      <th>Pleural Effusion</th>
      <th>Pleural Other</th>
      <th>Fracture</th>
      <th>Support Devices</th>
      <th>PATIENT</th>
      <th>GENDER</th>
      <th>AGE_AT_CXR</th>
      <th>PRIMARY_RACE</th>
      <th>ETHNICITY</th>
      <th>RACE_NUM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>CheXpert-v1.0-small/train/patient00001/study1/...</td>
      <td>Female</td>
      <td>68</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>patient00001</td>
      <td>Female</td>
      <td>68</td>
      <td>Other</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>3</td>
    </tr>
    <tr>
      <th>1</th>
      <td>CheXpert-v1.0-small/train/patient00002/study2/...</td>
      <td>Female</td>
      <td>87</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>-1.0</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>patient00002</td>
      <td>Female</td>
      <td>87</td>
      <td>White, non-Hispanic</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>CheXpert-v1.0-small/train/patient00002/study1/...</td>
      <td>Female</td>
      <td>83</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>patient00002</td>
      <td>Female</td>
      <td>87</td>
      <td>White, non-Hispanic</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>CheXpert-v1.0-small/train/patient00002/study1/...</td>
      <td>Female</td>
      <td>83</td>
      <td>Lateral</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>patient00002</td>
      <td>Female</td>
      <td>87</td>
      <td>White, non-Hispanic</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>CheXpert-v1.0-small/train/patient00003/study1/...</td>
      <td>Male</td>
      <td>41</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient00003</td>
      <td>Male</td>
      <td>41</td>
      <td>White, non-Hispanic</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>220992</th>
      <td>CheXpert-v1.0-small/train/patient64535/study1/...</td>
      <td>Male</td>
      <td>60</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient64535</td>
      <td>Male</td>
      <td>60</td>
      <td>Black or African American</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>1</td>
    </tr>
    <tr>
      <th>220993</th>
      <td>CheXpert-v1.0-small/train/patient64536/study2/...</td>
      <td>Female</td>
      <td>61</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient64536</td>
      <td>Female</td>
      <td>61</td>
      <td>Other</td>
      <td>Hispanic/Latino</td>
      <td>3</td>
    </tr>
    <tr>
      <th>220994</th>
      <td>CheXpert-v1.0-small/train/patient64536/study1/...</td>
      <td>Female</td>
      <td>61</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>patient64536</td>
      <td>Female</td>
      <td>61</td>
      <td>Other</td>
      <td>Hispanic/Latino</td>
      <td>3</td>
    </tr>
    <tr>
      <th>220995</th>
      <td>CheXpert-v1.0-small/train/patient64537/study2/...</td>
      <td>Male</td>
      <td>59</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient64537</td>
      <td>Male</td>
      <td>59</td>
      <td>Black or African American</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>1</td>
    </tr>
    <tr>
      <th>220996</th>
      <td>CheXpert-v1.0-small/train/patient64537/study1/...</td>
      <td>Male</td>
      <td>59</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>-1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient64537</td>
      <td>Male</td>
      <td>59</td>
      <td>Black or African American</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
<p>220997 rows × 25 columns</p>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-58212ca5-d0e1-4b5d-9e35-c7d233781e8b')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-58212ca5-d0e1-4b5d-9e35-c7d233781e8b button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-58212ca5-d0e1-4b5d-9e35-c7d233781e8b');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<div class="cell" data-outputid="bb701503-aab9-432c-dbab-5d9c8fc29b01" data-execution_count="13">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization of the presence of each 'merged' race</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>bars <span class="op">=</span> (<span class="st">'White'</span>, <span class="st">'Other'</span>, <span class="st">'Asian'</span>, <span class="st">'Black'</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>x_pos <span class="op">=</span> np.arange(<span class="bu">len</span>(bars))</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>height <span class="op">=</span> df_patients_race[<span class="st">'RACE_NUM'</span>].value_counts()</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>plt.bar(bars, height)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Add title and axis names</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Distribution of Race across Merged Dataset'</span>)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Race'</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Count'</span>)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Create names on the x axis</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>plt.xticks(x_pos, bars)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-13-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We wanted to recreate the results of the paper, and they focused only on White, Black, and Asian groups. We will therefore subset our data only by these populations.</p>
<div class="cell" data-outputid="31f7c698-8339-4446-8d9b-59c36efa8b9c" data-execution_count="14">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>df_patients_bwa <span class="op">=</span> df_patients_race[df_patients_race[<span class="st">'PRIMARY_RACE'</span>].<span class="bu">str</span>.contains(<span class="st">'White|Black|Asian'</span>)<span class="op">==</span><span class="va">True</span>]</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>df_patients_bwa</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">


  <div id="df-407f83ac-d461-44ce-8d97-3a2622e7a570">
    <div class="colab-df-container">
      <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Path</th>
      <th>Sex</th>
      <th>Age</th>
      <th>Frontal/Lateral</th>
      <th>AP/PA</th>
      <th>No Finding</th>
      <th>Enlarged Cardiomediastinum</th>
      <th>Cardiomegaly</th>
      <th>Lung Opacity</th>
      <th>Lung Lesion</th>
      <th>...</th>
      <th>Pleural Effusion</th>
      <th>Pleural Other</th>
      <th>Fracture</th>
      <th>Support Devices</th>
      <th>PATIENT</th>
      <th>GENDER</th>
      <th>AGE_AT_CXR</th>
      <th>PRIMARY_RACE</th>
      <th>ETHNICITY</th>
      <th>RACE_NUM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>CheXpert-v1.0-small/train/patient00002/study2/...</td>
      <td>Female</td>
      <td>87</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>-1.0</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>patient00002</td>
      <td>Female</td>
      <td>87</td>
      <td>White, non-Hispanic</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>CheXpert-v1.0-small/train/patient00002/study1/...</td>
      <td>Female</td>
      <td>83</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>patient00002</td>
      <td>Female</td>
      <td>87</td>
      <td>White, non-Hispanic</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>CheXpert-v1.0-small/train/patient00002/study1/...</td>
      <td>Female</td>
      <td>83</td>
      <td>Lateral</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>patient00002</td>
      <td>Female</td>
      <td>87</td>
      <td>White, non-Hispanic</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>CheXpert-v1.0-small/train/patient00003/study1/...</td>
      <td>Male</td>
      <td>41</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient00003</td>
      <td>Male</td>
      <td>41</td>
      <td>White, non-Hispanic</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>CheXpert-v1.0-small/train/patient00004/study1/...</td>
      <td>Female</td>
      <td>20</td>
      <td>Frontal</td>
      <td>PA</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient00004</td>
      <td>Female</td>
      <td>20</td>
      <td>Black or African American</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>220990</th>
      <td>CheXpert-v1.0-small/train/patient64533/study2/...</td>
      <td>Male</td>
      <td>75</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient64533</td>
      <td>Male</td>
      <td>75</td>
      <td>White</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>0</td>
    </tr>
    <tr>
      <th>220991</th>
      <td>CheXpert-v1.0-small/train/patient64534/study1/...</td>
      <td>Male</td>
      <td>63</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient64534</td>
      <td>Male</td>
      <td>63</td>
      <td>White</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>0</td>
    </tr>
    <tr>
      <th>220992</th>
      <td>CheXpert-v1.0-small/train/patient64535/study1/...</td>
      <td>Male</td>
      <td>60</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient64535</td>
      <td>Male</td>
      <td>60</td>
      <td>Black or African American</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>1</td>
    </tr>
    <tr>
      <th>220995</th>
      <td>CheXpert-v1.0-small/train/patient64537/study2/...</td>
      <td>Male</td>
      <td>59</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient64537</td>
      <td>Male</td>
      <td>59</td>
      <td>Black or African American</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>1</td>
    </tr>
    <tr>
      <th>220996</th>
      <td>CheXpert-v1.0-small/train/patient64537/study1/...</td>
      <td>Male</td>
      <td>59</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>-1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient64537</td>
      <td>Male</td>
      <td>59</td>
      <td>Black or African American</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
<p>160716 rows × 25 columns</p>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-407f83ac-d461-44ce-8d97-3a2622e7a570')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-407f83ac-d461-44ce-8d97-3a2622e7a570 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-407f83ac-d461-44ce-8d97-3a2622e7a570');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<p>So df_patients_bwa is df_patients_race but with the “Other” category dropped - just Black, White, and Asian. The csv train_bwa is the first 72000 images of df_patients_bwa. The csv valid_bwa is the 72000-90000 images.</p>
<p>Then I have created the csv train_bwa_equal, which took the first 6000 images from each group of train_bwa and shuffled them. I chose 6000, because there are 6146 Black people in train_bwa (which is the smallest group). The csv valid_bwa_equal takes 1000 images from each group of valid_bwa and shuffled them. I chose 1000 because there are 1281 images belonging to Black patients in valid_bwa.</p>
<div class="cell" data-outputid="4d218d08-acf6-4f20-e560-3633ae7f5d9d" data-execution_count="15">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_patients_bwa[<span class="st">'PRIMARY_RACE'</span>].unique())</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_patients_bwa[<span class="st">'RACE_NUM'</span>].unique())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['White, non-Hispanic' 'Black or African American' 'White' 'Asian'
 'Asian, non-Hispanic' 'White, Hispanic' 'Black, non-Hispanic'
 'Black, Hispanic' 'White or Caucasian' 'Asian, Hispanic'
 'Asian - Historical Conv']
[0 1 2]</code></pre>
</div>
</div>
<div class="cell" data-outputid="83b7679f-75d6-4bec-e088-39805f8df728" data-execution_count="16">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>df_patients_race.groupby(<span class="st">"RACE_NUM"</span>).size()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>RACE_NUM
0    125483
1     11961
2     23272
3     60281
dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-outputid="1bb4c82c-0d6b-4b40-c209-44c6b040fba9" data-execution_count="17">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>df_patients_bwa[:<span class="dv">72000</span>].groupby(<span class="st">"RACE_NUM"</span>).size()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>RACE_NUM
0    55314
1     6146
2    10540
dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-outputid="f03eb3ab-aabb-42cd-d900-42473f7c72e8" data-execution_count="18">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>df_patients_bwa[<span class="dv">72000</span>:<span class="dv">90000</span>].groupby(<span class="st">"RACE_NUM"</span>).size()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>RACE_NUM
0    14203
1     1281
2     2516
dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-outputid="4b107c84-b617-4ae3-ca93-ba258340bcae" data-execution_count="19">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>df_train_bwa <span class="op">=</span> pd.read_csv(<span class="st">'/content/drive/Shareddrives/CheXpert-v1.0-small/train_bwa.csv'</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>df_test_bwa <span class="op">=</span> pd.read_csv(<span class="st">'/content/drive/Shareddrives/CheXpert-v1.0-small/test_bwa.csv'</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>df_train_bwa_equal <span class="op">=</span> pd.read_csv(<span class="st">'/content/drive/Shareddrives/CheXpert-v1.0-small/train_bwa_equal.csv'</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>df_test_bwa_equal <span class="op">=</span> pd.read_csv(<span class="st">'/content/drive/Shareddrives/CheXpert-v1.0-small/test_bwa_equal.csv'</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>df_train_bwa_frontal <span class="op">=</span> df_train_bwa[df_train_bwa[<span class="st">'Path'</span>].<span class="bu">str</span>.contains(<span class="st">'frontal'</span>)<span class="op">==</span><span class="va">True</span>]</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>df_test_bwa_frontal <span class="op">=</span> df_test_bwa[df_test_bwa[<span class="st">'Path'</span>].<span class="bu">str</span>.contains(<span class="st">'frontal'</span>)<span class="op">==</span><span class="va">True</span>]</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>df_train_bwa_equal_frontal <span class="op">=</span> df_train_bwa_equal[df_train_bwa_equal[<span class="st">'Path'</span>].<span class="bu">str</span>.contains(<span class="st">'frontal'</span>)<span class="op">==</span><span class="va">True</span>]</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>df_test_bwa_equal_frontal <span class="op">=</span> df_test_bwa_equal[df_test_bwa_equal[<span class="st">'Path'</span>].<span class="bu">str</span>.contains(<span class="st">'frontal'</span>)<span class="op">==</span><span class="va">True</span>]</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="co">#Test if sets have any patients in common</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">set</span>(df_train_bwa[<span class="st">'Path'</span>].unique().tolist()) <span class="op">&amp;</span> <span class="bu">set</span>(df_test_bwa[<span class="st">'Path'</span>].unique().tolist()))</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">set</span>(df_train_bwa_equal[<span class="st">'Path'</span>].unique().tolist()) <span class="op">&amp;</span> <span class="bu">set</span>(df_test_bwa_equal[<span class="st">'Path'</span>].unique().tolist()))</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">set</span>(df_train_bwa_equal[<span class="st">'Path'</span>].unique().tolist()) <span class="op">&amp;</span> <span class="bu">set</span>(df_test_bwa[<span class="st">'Path'</span>].unique().tolist()))</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">set</span>(df_train_bwa[<span class="st">'Path'</span>].unique().tolist()) <span class="op">&amp;</span> <span class="bu">set</span>(df_test_bwa_equal[<span class="st">'Path'</span>].unique().tolist()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>set()
set()
set()
set()</code></pre>
</div>
</div>
<div class="cell" data-outputid="a54f361d-b384-4c09-f784-01ff92a26bd9" data-execution_count="20">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>df_train_bwa_equal_frontal.groupby(<span class="st">"RACE_NUM"</span>).size()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>RACE_NUM
0    4776
1    4819
2    4641
dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-outputid="47320a00-fa3f-4d0f-93fb-c1e333deb4aa" data-execution_count="21">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>df_test_bwa_equal_frontal.groupby(<span class="st">"RACE_NUM"</span>).size()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>RACE_NUM
0    817
1    759
2    775
dtype: int64</code></pre>
</div>
</div>
<p>TODO: Should do analysis on number of patients in each subset, etc.</p>
<div class="cell" data-outputid="2a0f806d-9bec-45e0-d5d6-fa9535427961" data-execution_count="22">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>df_train_bwa</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">


  <div id="df-005da57f-7f4a-47a7-b19b-f0cee011f4da">
    <div class="colab-df-container">
      <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Unnamed: 0</th>
      <th>Path</th>
      <th>Sex</th>
      <th>Age</th>
      <th>Frontal/Lateral</th>
      <th>AP/PA</th>
      <th>No Finding</th>
      <th>Enlarged Cardiomediastinum</th>
      <th>Cardiomegaly</th>
      <th>Lung Opacity</th>
      <th>...</th>
      <th>Pleural Effusion</th>
      <th>Pleural Other</th>
      <th>Fracture</th>
      <th>Support Devices</th>
      <th>PATIENT</th>
      <th>GENDER</th>
      <th>AGE_AT_CXR</th>
      <th>PRIMARY_RACE</th>
      <th>ETHNICITY</th>
      <th>RACE_NUM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>CheXpert-v1.0-small/train/patient00002/study2/...</td>
      <td>Female</td>
      <td>87</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>-1.0</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>patient00002</td>
      <td>Female</td>
      <td>87</td>
      <td>White, non-Hispanic</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>CheXpert-v1.0-small/train/patient00002/study1/...</td>
      <td>Female</td>
      <td>83</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>patient00002</td>
      <td>Female</td>
      <td>87</td>
      <td>White, non-Hispanic</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>CheXpert-v1.0-small/train/patient00002/study1/...</td>
      <td>Female</td>
      <td>83</td>
      <td>Lateral</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>patient00002</td>
      <td>Female</td>
      <td>87</td>
      <td>White, non-Hispanic</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>CheXpert-v1.0-small/train/patient00003/study1/...</td>
      <td>Male</td>
      <td>41</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient00003</td>
      <td>Male</td>
      <td>41</td>
      <td>White, non-Hispanic</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>CheXpert-v1.0-small/train/patient00004/study1/...</td>
      <td>Female</td>
      <td>20</td>
      <td>Frontal</td>
      <td>PA</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient00004</td>
      <td>Female</td>
      <td>20</td>
      <td>Black or African American</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>71995</th>
      <td>98819</td>
      <td>CheXpert-v1.0-small/train/patient24018/study1/...</td>
      <td>Male</td>
      <td>88</td>
      <td>Frontal</td>
      <td>PA</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient24018</td>
      <td>Male</td>
      <td>88</td>
      <td>White</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>0</td>
    </tr>
    <tr>
      <th>71996</th>
      <td>98820</td>
      <td>CheXpert-v1.0-small/train/patient24018/study1/...</td>
      <td>Male</td>
      <td>88</td>
      <td>Lateral</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient24018</td>
      <td>Male</td>
      <td>88</td>
      <td>White</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>0</td>
    </tr>
    <tr>
      <th>71997</th>
      <td>98821</td>
      <td>CheXpert-v1.0-small/train/patient24018/study5/...</td>
      <td>Male</td>
      <td>88</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>patient24018</td>
      <td>Male</td>
      <td>88</td>
      <td>White</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>0</td>
    </tr>
    <tr>
      <th>71998</th>
      <td>98822</td>
      <td>CheXpert-v1.0-small/train/patient24018/study2/...</td>
      <td>Male</td>
      <td>88</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>patient24018</td>
      <td>Male</td>
      <td>88</td>
      <td>White</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>0</td>
    </tr>
    <tr>
      <th>71999</th>
      <td>98823</td>
      <td>CheXpert-v1.0-small/train/patient24018/study4/...</td>
      <td>Male</td>
      <td>88</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>patient24018</td>
      <td>Male</td>
      <td>88</td>
      <td>White</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>72000 rows × 26 columns</p>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-005da57f-7f4a-47a7-b19b-f0cee011f4da')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-005da57f-7f4a-47a7-b19b-f0cee011f4da button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-005da57f-7f4a-47a7-b19b-f0cee011f4da');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<p>This last bit of code was to check that all the images linked to our loaded data actually exist.</p>
<div class="cell" data-outputid="4453fa5f-dbe1-42cf-fd90-b64346fb67a4" data-execution_count="23">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>i <span class="op">=</span> <span class="dv">124000</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co">#ran already, found anomaly only with patient 11019</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co">for index, row in df_patients_race[124000:125000].iterrows():</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="co">    row_path_list = row['Path'].split("/")</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="co">    row_path = os.path.join("/content/drive/Shareddrives/CheXpert-v1.0-small/train",row_path_list[2],row_path_list[3],row_path_list[4])</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="co">    dir_path = os.path.join("/content/drive/Shareddrives/CheXpert-v1.0-small/train",row_path_list[2],row_path_list[3])</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="co">    os.chdir(dir_path)</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="co">    if (i % 1000 == 0):</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="co">      print(i, row_path_list[2])</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a><span class="co">    if not os.path.isfile(row_path_list[4]):</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a><span class="co">      print(row_path)</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a><span class="co">    #print(row_path)</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a><span class="co">    #print(i)</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a><span class="co">    #if not os.path.isfile(row_path):</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a><span class="co">    #  print(row_path)</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a><span class="co">    i += 1</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>'\nfor index, row in df_patients_race[124000:125000].iterrows():\n    row_path_list = row[\'Path\'].split("/")\n    row_path = os.path.join("/content/drive/Shareddrives/CheXpert-v1.0-small/train",row_path_list[2],row_path_list[3],row_path_list[4])\n    \n    dir_path = os.path.join("/content/drive/Shareddrives/CheXpert-v1.0-small/train",row_path_list[2],row_path_list[3])\n    os.chdir(dir_path)\n\n    if (i % 1000 == 0):\n      print(i, row_path_list[2])\n\n    if not os.path.isfile(row_path_list[4]):\n      print(row_path)\n\n    #print(row_path)\n\n    #print(i)\n    \n    \n    #if not os.path.isfile(row_path):\n    #  print(row_path)\n    i += 1\n'</code></pre>
</div>
</div>
<div class="cell" data-outputid="3edcc133-9080-408e-e9ff-f81e92367bd4" data-execution_count="24">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>df_patients_bwa.groupby(<span class="st">"RACE_NUM"</span>).size()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>RACE_NUM
0    125483
1     11961
2     23272
dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-outputid="e2b6cf51-7ad7-4cf2-c4c6-7749d3ebdc71" data-execution_count="25">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>white_patients_size <span class="op">=</span> (df_race_sorted[<span class="st">'PRIMARY_RACE'</span>].<span class="bu">str</span>.contains(<span class="st">'White'</span>)<span class="op">==</span><span class="va">True</span>).<span class="bu">sum</span>()</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>black_patients_size <span class="op">=</span> (df_race_sorted[<span class="st">'PRIMARY_RACE'</span>].<span class="bu">str</span>.contains(<span class="st">'Black'</span>)<span class="op">==</span><span class="va">True</span>).<span class="bu">sum</span>()</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>asian_patients_size <span class="op">=</span> (df_race_sorted[<span class="st">'PRIMARY_RACE'</span>].<span class="bu">str</span>.contains(<span class="st">'Asian'</span>)<span class="op">==</span><span class="va">True</span>).<span class="bu">sum</span>()</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Average photos: "</span>,<span class="dv">125483</span><span class="op">/</span>white_patients_size)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Average photos: "</span>,<span class="dv">11961</span><span class="op">/</span>black_patients_size)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Average photos: "</span>,<span class="dv">23272</span><span class="op">/</span>asian_patients_size)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Average photos:  3.4128318102698
Average photos:  3.8007626310772165
Average photos:  3.2958504461124485</code></pre>
</div>
</div>
</section>
<section id="data-preparation-and-loading" class="level2">
<h2 class="anchored" data-anchor-id="data-preparation-and-loading">Data Preparation and Loading</h2>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> roc_auc_score</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> optim</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision.transforms <span class="im">as</span> transforms</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastprogress <span class="im">import</span> master_bar, progress_bar</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>IMAGENET_MEAN <span class="op">=</span> [<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>]         <span class="co"># Mean of ImageNet dataset (used for normalization)</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>IMAGENET_STD <span class="op">=</span> [<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>]          <span class="co"># Std of ImageNet dataset (used for normalization)</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a><span class="co">#I used a lot of code from https://www.kaggle.com/code/hmchuong/chexpert-pytorch-densenet121?scriptVersionId=18314696&amp;cellId=15</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ChestXrayDataset(Dataset):</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,folder_dir,dataframe,image_size,normalization):</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">#a lot of this function is </span></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># folder_dir is the directory path to the data</span></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dataframe holds patient info and labels</span></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># it takes in our image labels</span></span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.image_paths<span class="op">=</span>[]</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.image_labels<span class="op">=</span>[]</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">#This transforms our image, I think we would also need normalization</span></span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># #original paper has random zoom, we did not implement that</span></span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>    image_transformation <span class="op">=</span> [</span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">#transforms.Grayscale(num_output_channels=1), #ONLY USE FOR PYTORCH XRAY</span></span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>        transforms.Resize((image_size,image_size)),</span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>        transforms.ToTensor(),</span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a>        transforms.RandomHorizontalFlip(),</span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>        transforms.RandomRotation(<span class="dv">15</span>)]</span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">#this normalizes using some constants from imagenet</span></span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> normalization:</span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">#  #ONLY COMMENT OUT FOR PYTORCH XRAY</span></span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a>      image_transformation.append(transforms.Normalize(IMAGENET_MEAN,IMAGENET_STD))</span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">#  #image_transformation.append(transforms.Normalize([0.485],[0.229]))</span></span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.image_transformation <span class="op">=</span> transforms.Compose(image_transformation)</span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">#this will index through all the patients from 000001, so forth, adding images from study1</span></span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> index, row <span class="kw">in</span> dataframe.iterrows():</span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb40-59"><a href="#cb40-59" aria-hidden="true" tabindex="-1"></a>      <span class="co">#image_path = os.path.join(folder_dir,Path(row['PATIENT']),Path('study1'),Path('view1_frontal.jpg'))</span></span>
<span id="cb40-60"><a href="#cb40-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-61"><a href="#cb40-61" aria-hidden="true" tabindex="-1"></a>      <span class="co">#here I use lateral and frontal images</span></span>
<span id="cb40-62"><a href="#cb40-62" aria-hidden="true" tabindex="-1"></a>      <span class="co">#OLD CODE</span></span>
<span id="cb40-63"><a href="#cb40-63" aria-hidden="true" tabindex="-1"></a>      <span class="co">#row_path_list = row['Path'].split("/")</span></span>
<span id="cb40-64"><a href="#cb40-64" aria-hidden="true" tabindex="-1"></a>      <span class="co">#image_path = os.path.join(folder_dir,row_path_list[2],row_path_list[3],row_path_list[4])</span></span>
<span id="cb40-65"><a href="#cb40-65" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb40-66"><a href="#cb40-66" aria-hidden="true" tabindex="-1"></a>      image_path <span class="op">=</span> os.path.join(folder_dir,row[<span class="st">'Path'</span>])</span>
<span id="cb40-67"><a href="#cb40-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-68"><a href="#cb40-68" aria-hidden="true" tabindex="-1"></a>      <span class="co">#if (os.path.isfile(image_path)):</span></span>
<span id="cb40-69"><a href="#cb40-69" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.image_paths.append(image_path)</span>
<span id="cb40-70"><a href="#cb40-70" aria-hidden="true" tabindex="-1"></a>      <span class="co">#else:</span></span>
<span id="cb40-71"><a href="#cb40-71" aria-hidden="true" tabindex="-1"></a>      <span class="co">#  continue</span></span>
<span id="cb40-72"><a href="#cb40-72" aria-hidden="true" tabindex="-1"></a>      <span class="co">#in this case I've hard-coded the image_labels to be if the patient is Black or not</span></span>
<span id="cb40-73"><a href="#cb40-73" aria-hidden="true" tabindex="-1"></a>      <span class="co">#NOTICE that I'm append a list to a list here</span></span>
<span id="cb40-74"><a href="#cb40-74" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb40-75"><a href="#cb40-75" aria-hidden="true" tabindex="-1"></a>      image_label <span class="op">=</span> []</span>
<span id="cb40-76"><a href="#cb40-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-77"><a href="#cb40-77" aria-hidden="true" tabindex="-1"></a>      image_label.append(<span class="bu">int</span>(row[<span class="st">"RACE_NUM"</span>]))</span>
<span id="cb40-78"><a href="#cb40-78" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb40-79"><a href="#cb40-79" aria-hidden="true" tabindex="-1"></a>      <span class="co">"""</span></span>
<span id="cb40-80"><a href="#cb40-80" aria-hidden="true" tabindex="-1"></a><span class="co">      if ( row["PRIMARY_RACE"] ==  'White' or row["PRIMARY_RACE"] == 'White, non-Hispanic' or row["PRIMARY_RACE"] == 'White or Caucasian'):</span></span>
<span id="cb40-81"><a href="#cb40-81" aria-hidden="true" tabindex="-1"></a><span class="co">        image_label.append(1)</span></span>
<span id="cb40-82"><a href="#cb40-82" aria-hidden="true" tabindex="-1"></a><span class="co">      #else:</span></span>
<span id="cb40-83"><a href="#cb40-83" aria-hidden="true" tabindex="-1"></a><span class="co">      #  image_label.append(0)</span></span>
<span id="cb40-84"><a href="#cb40-84" aria-hidden="true" tabindex="-1"></a><span class="co">      elif ( row["PRIMARY_RACE"] ==  'Black or African American' or row["PRIMARY_RACE"] == 'Black, non-Hispanic'):</span></span>
<span id="cb40-85"><a href="#cb40-85" aria-hidden="true" tabindex="-1"></a><span class="co">        image_label.append(2)</span></span>
<span id="cb40-86"><a href="#cb40-86" aria-hidden="true" tabindex="-1"></a><span class="co">      #else:</span></span>
<span id="cb40-87"><a href="#cb40-87" aria-hidden="true" tabindex="-1"></a><span class="co">      #  image_label.append(0)</span></span>
<span id="cb40-88"><a href="#cb40-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-89"><a href="#cb40-89" aria-hidden="true" tabindex="-1"></a><span class="co">      elif ( row["PRIMARY_RACE"] ==  'Asian' or row["PRIMARY_RACE"] == 'Asian, non-Hispanic' or row["PRIMARY_RACE"] == 'Asian - Historical Conv' or row['PRIMARY_RACE'] == 'Asian - Historical Conv'):</span></span>
<span id="cb40-90"><a href="#cb40-90" aria-hidden="true" tabindex="-1"></a><span class="co">        image_label.append(3)</span></span>
<span id="cb40-91"><a href="#cb40-91" aria-hidden="true" tabindex="-1"></a><span class="co">      else:</span></span>
<span id="cb40-92"><a href="#cb40-92" aria-hidden="true" tabindex="-1"></a><span class="co">        image_label.append(0)</span></span>
<span id="cb40-93"><a href="#cb40-93" aria-hidden="true" tabindex="-1"></a><span class="co">      """</span></span>
<span id="cb40-94"><a href="#cb40-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-95"><a href="#cb40-95" aria-hidden="true" tabindex="-1"></a>      <span class="co">#DELETE THIS IF NOT USING TORCH XRAY</span></span>
<span id="cb40-96"><a href="#cb40-96" aria-hidden="true" tabindex="-1"></a>      <span class="co">#for i in range(17):</span></span>
<span id="cb40-97"><a href="#cb40-97" aria-hidden="true" tabindex="-1"></a>      <span class="co">#  image_label.append(5)</span></span>
<span id="cb40-98"><a href="#cb40-98" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb40-99"><a href="#cb40-99" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.image_labels.append(image_label)</span>
<span id="cb40-100"><a href="#cb40-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-101"><a href="#cb40-101" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb40-102"><a href="#cb40-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.image_paths)</span>
<span id="cb40-103"><a href="#cb40-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-104"><a href="#cb40-104" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>,index):</span>
<span id="cb40-105"><a href="#cb40-105" aria-hidden="true" tabindex="-1"></a>    <span class="co">#This is also just necessary for other parts</span></span>
<span id="cb40-106"><a href="#cb40-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-107"><a href="#cb40-107" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read image</span></span>
<span id="cb40-108"><a href="#cb40-108" aria-hidden="true" tabindex="-1"></a>    image_path <span class="op">=</span> <span class="va">self</span>.image_paths[index]</span>
<span id="cb40-109"><a href="#cb40-109" aria-hidden="true" tabindex="-1"></a>    <span class="co">#ONLY COMMENT OUT FOR PYTORCH XRAY</span></span>
<span id="cb40-110"><a href="#cb40-110" aria-hidden="true" tabindex="-1"></a>    image_data <span class="op">=</span> Image.<span class="bu">open</span>(image_path).convert(<span class="st">"RGB"</span>)</span>
<span id="cb40-111"><a href="#cb40-111" aria-hidden="true" tabindex="-1"></a>    image_data <span class="op">=</span> <span class="va">self</span>.image_transformation(image_data)</span>
<span id="cb40-112"><a href="#cb40-112" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb40-113"><a href="#cb40-113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> image_data, torch.FloatTensor(<span class="va">self</span>.image_labels[index])</span>
<span id="cb40-114"><a href="#cb40-114" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>IMAGE_SIZE <span class="op">=</span> <span class="dv">224</span>                              <span class="co"># Image size (224x224)</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">50</span>                        </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co"># BATCH_SIZE = 1728 #ONLY FOR PYTORCH XRAY VISION</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>LEARNING_RATE <span class="op">=</span> <span class="fl">0.001</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>LEARNING_RATE_SCHEDULE_FACTOR <span class="op">=</span> <span class="fl">0.1</span>           <span class="co"># Parameter used for reducing learning rate</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>LEARNING_RATE_SCHEDULE_PATIENCE <span class="op">=</span> <span class="dv">5</span>           <span class="co"># Parameter used for reducing learning rate</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>MAX_EPOCHS <span class="op">=</span> <span class="dv">2</span>                              <span class="co"># Maximum number of training epochs</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define the dataset object here</p>
<div class="cell" data-outputid="85ab89ae-5e35-4a4f-f26b-af1f09c02a35">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">#train_dataset = ChestXrayDataset("/content/drive/Shareddrives/CheXpert-v1.0-small/train", df_train_race_mod, race_is_white, IMAGE_SIZE, True)</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="co">#train the dataset with the first 2000 images, this includes frontal and lateral images</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>train_dataset <span class="op">=</span> ChestXrayDataset(<span class="st">"/content/drive/Shareddrives/"</span>, df_train_bwa_equal[:<span class="dv">6000</span>], IMAGE_SIZE, <span class="va">True</span>)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(train_dataset.image_labels[:<span class="dv">10</span>])</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(train_dataset.image_paths[:<span class="dv">10</span>])</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"dataset length: "</span>, <span class="bu">len</span>(train_dataset))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[2], [2], [2], [1], [1], [0], [1], [1], [1], [0]]
['/content/drive/Shareddrives/CheXpert-v1.0-small/train/patient00078/study3/view1_frontal.jpg', '/content/drive/Shareddrives/CheXpert-v1.0-small/train/patient01622/study3/view1_frontal.jpg', '/content/drive/Shareddrives/CheXpert-v1.0-small/train/patient02945/study1/view1_frontal.jpg', '/content/drive/Shareddrives/CheXpert-v1.0-small/train/patient16701/study1/view1_frontal.jpg', '/content/drive/Shareddrives/CheXpert-v1.0-small/train/patient05235/study3/view2_lateral.jpg', '/content/drive/Shareddrives/CheXpert-v1.0-small/train/patient01538/study3/view1_frontal.jpg', '/content/drive/Shareddrives/CheXpert-v1.0-small/train/patient04830/study3/view1_frontal.jpg', '/content/drive/Shareddrives/CheXpert-v1.0-small/train/patient11839/study6/view1_frontal.jpg', '/content/drive/Shareddrives/CheXpert-v1.0-small/train/patient04499/study1/view2_lateral.jpg', '/content/drive/Shareddrives/CheXpert-v1.0-small/train/patient02462/study12/view2_lateral.jpg']
dataset length:  6000</code></pre>
</div>
</div>
<p>Create the loader for the dataset here - basically it is nice to have this so we can load the data in batches when we need instead of loading the entire dataset onto RAM, which is costly and slow.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>train_dataloader <span class="op">=</span> DataLoader(dataset<span class="op">=</span>train_dataset, batch_size<span class="op">=</span>BATCH_SIZE, num_workers<span class="op">=</span><span class="dv">2</span>, shuffle<span class="op">=</span><span class="va">True</span>, pin_memory<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="e61d8430-ab4f-4d7d-a236-d53115293c37">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">#I believe that this functions as a test - if this block returns an error, there is a problem with dataloading</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> data, label <span class="kw">in</span> train_dataloader:</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(data.size())</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(label.size())</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>torch.Size([20, 3, 224, 224])
torch.Size([20, 1])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">'cuda:0'</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">'cpu'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Defining some functions now to train our model:</p>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.optim <span class="im">as</span> optim</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train(model, trainloader, optimizer, k_epochs <span class="op">=</span> <span class="dv">1</span>, print_every <span class="op">=</span> <span class="dv">2000</span>, loss_fn <span class="op">=</span> nn.CrossEntropyLoss()):</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    begin <span class="op">=</span> time.time()</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">#if using pretrained model</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    model.train()</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(k_epochs): </span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>        running_loss <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, data <span class="kw">in</span> <span class="bu">enumerate</span>(trainloader, <span class="dv">0</span>):</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>            X, y <span class="op">=</span> data</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>            X <span class="op">=</span> X.to(device)</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>            <span class="co">#need to flatten y - this holds labels for each image in the batch, but as a list of a list</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> torch.flatten(y)</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> y.to(torch.<span class="bu">long</span>)</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> y.to(device)</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>            y_hat <span class="op">=</span> model(X)</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> loss_fn(y_hat, y)</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>            optimizer.step()</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>            running_loss <span class="op">+=</span> loss.item()</span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>            <span class="co"># print the epoch, number of batches processed, and running loss </span></span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>            <span class="co"># in regular intervals</span></span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="op">%</span> print_every <span class="op">==</span> print_every <span class="op">-</span> <span class="dv">1</span>:    </span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f'[epoch: </span><span class="sc">{</span>epoch <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">, batches: </span><span class="sc">{</span>i <span class="op">+</span> <span class="dv">1</span><span class="sc">:5d}</span><span class="ss">], loss: </span><span class="sc">{</span>running_loss <span class="op">/</span> print_every<span class="sc">:.3f}</span><span class="ss">'</span>)</span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>                running_loss <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>    end <span class="op">=</span> time.time()</span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Finished training in </span><span class="sc">{</span><span class="bu">round</span>(end <span class="op">-</span> begin)<span class="sc">}</span><span class="ss">s'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test(model, testloader):</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    correct <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    total <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    y_true <span class="op">=</span> []</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> []</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#if model is pretrained</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> data, label <span class="kw">in</span> testloader:</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>            X <span class="op">=</span> data</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> label</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>            X <span class="op">=</span> X.to(device)</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> torch.flatten(label)</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> y.to(torch.<span class="bu">long</span>)</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> y.to(device)</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(y)</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>            <span class="co"># run all the images through the model</span></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>            y_hat <span class="op">=</span> model(X)</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>            <span class="co">#print(y_hat)</span></span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>            <span class="co"># the class with the largest model output is the prediction</span></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>            _, predicted <span class="op">=</span> torch.<span class="bu">max</span>(y_hat.data, <span class="dv">1</span>)</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"predicted: "</span>,predicted)</span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>            y_pred.extend(predicted.data.cpu().numpy()) </span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>            y_true.extend(y.data.cpu().numpy())</span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a>            <span class="co"># compute the accuracy</span></span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>            total <span class="op">+=</span> y.size(<span class="dv">0</span>)</span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>            correct <span class="op">+=</span> (predicted <span class="op">==</span> y).<span class="bu">sum</span>().item()</span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>            <span class="co">#print(total,correct)</span></span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Test accuracy: </span><span class="sc">{</span><span class="dv">100</span> <span class="op">*</span> correct <span class="op">//</span> total<span class="sc">}</span><span class="ss"> %'</span>)</span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> y_pred, y_true</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Resnet 18 Self-Implementation</p>
<div class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co">#references https://arxiv.org/pdf/1512.03385.pdf, original resnet paper</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="co"># and https://blog.paperspace.com/writing-resnet-from-scratch-in-pytorch/ for pointers on code</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/microsoft/nni/blob/master/examples/trials/cifar10_pytorch/models/resnet.py</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Resnet18(nn.Module):</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">"""</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="co">  for now I'm doing the 34 version</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="co">  """</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, num_classes):</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">super</span>(Resnet18,<span class="va">self</span>).<span class="fu">__init__</span>() <span class="co">#is (Resnet,self) necessary?</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">#want to take matrix 224*224 to 112*112, padding 3 ensures that each kernel </span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># centered on pixel in matrix, stride =2 makes it every other pixel, hence dimension is half</span></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.conv1 <span class="op">=</span> nn.Sequential(</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>      nn.Conv2d(in_channels <span class="op">=</span> <span class="dv">3</span>, out_channels <span class="op">=</span> <span class="dv">64</span>, kernel_size <span class="op">=</span> <span class="dv">7</span>, stride <span class="op">=</span> <span class="dv">2</span>, padding<span class="op">=</span><span class="dv">3</span>), </span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>      nn.BatchNorm2d(num_features <span class="op">=</span> <span class="dv">64</span>),</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>      nn.ReLU()</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">#now do 3 by 3 max pool, similarly need padding 1 to make sure kernel</span></span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># centered on each pixel, stride=2 make it other pixel, dimension 56*56</span></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.maxpool <span class="op">=</span> nn.MaxPool2d(kernel_size <span class="op">=</span> <span class="dv">3</span>,stride<span class="op">=</span><span class="dv">2</span>,padding<span class="op">=</span><span class="dv">1</span>) <span class="co">#not sure why there is padding</span></span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">#each time we reduce the size of the matrix by half, hence stride of 2 (for conv2_x, maxpool reduced dimension)</span></span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.conv2_x <span class="op">=</span> <span class="va">self</span>.make_conv_layer(<span class="dv">64</span>,<span class="dv">64</span>,kernel_size <span class="op">=</span> <span class="dv">3</span>, stride <span class="op">=</span> <span class="dv">1</span>, num_layers <span class="op">=</span> <span class="dv">2</span>)</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.conv3_x <span class="op">=</span> <span class="va">self</span>.make_conv_layer(<span class="dv">64</span>,<span class="dv">128</span>,kernel_size <span class="op">=</span> <span class="dv">3</span>, stride <span class="op">=</span> <span class="dv">2</span>, num_layers <span class="op">=</span> <span class="dv">2</span>)</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.conv4_x <span class="op">=</span> <span class="va">self</span>.make_conv_layer(<span class="dv">128</span>,<span class="dv">256</span>,kernel_size <span class="op">=</span> <span class="dv">3</span>, stride <span class="op">=</span> <span class="dv">2</span>, num_layers <span class="op">=</span> <span class="dv">2</span>)</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.conv5_x <span class="op">=</span> <span class="va">self</span>.make_conv_layer(<span class="dv">256</span>,<span class="dv">512</span>,kernel_size <span class="op">=</span> <span class="dv">3</span>, stride <span class="op">=</span> <span class="dv">2</span>, num_layers <span class="op">=</span> <span class="dv">2</span>)</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">#size is now [512,7,7], want it to be [512,1,1] so kernel size 7</span></span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">#self.avgpool = nn.AvgPool2d(kernel_size = 7,stride = 1) #no idea why this is 7</span></span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.avgpool <span class="op">=</span> nn.AdaptiveAvgPool2d((<span class="dv">1</span>,<span class="dv">1</span>)) <span class="co">#this is what preloaded resnet34 has</span></span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.fc <span class="op">=</span> nn.Linear(<span class="dv">512</span>,num_classes)</span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>  <span class="co">#this is specific to resnet 34</span></span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> make_conv_layer(<span class="va">self</span>,in_channels, out_channels, kernel_size, stride, num_layers):</span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">#conv 1 - 64 out, conv2 - 64 in 64 out, 64 in 64 out, 64 in 64 out, conv3 - 64 in 128 out, 128 in 128 out</span></span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a>    layer_list <span class="op">=</span> []</span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a>    in_ch <span class="op">=</span> in_channels</span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># first block is input stride, reset are stride of 1</span></span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a>    layer_list.append(ResidualBlock(in_ch,out_channels,kernel_size,stride))</span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a>    in_ch <span class="op">=</span> out_channels</span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>,num_layers):</span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a>      layer_list.append(ResidualBlock(in_ch,out_channels,kernel_size,stride<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb50-54"><a href="#cb50-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-55"><a href="#cb50-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> nn.Sequential(<span class="op">*</span>layer_list)</span>
<span id="cb50-56"><a href="#cb50-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-57"><a href="#cb50-57" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> forward(<span class="va">self</span>,x):</span>
<span id="cb50-58"><a href="#cb50-58" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.conv1(x)</span>
<span id="cb50-59"><a href="#cb50-59" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.maxpool(x)</span>
<span id="cb50-60"><a href="#cb50-60" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.conv2_x(x)</span>
<span id="cb50-61"><a href="#cb50-61" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.conv3_x(x)</span>
<span id="cb50-62"><a href="#cb50-62" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.conv4_x(x)</span>
<span id="cb50-63"><a href="#cb50-63" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.conv5_x(x)</span>
<span id="cb50-64"><a href="#cb50-64" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.avgpool(x)</span>
<span id="cb50-65"><a href="#cb50-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-66"><a href="#cb50-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">#x = torch.flatten(x)</span></span>
<span id="cb50-67"><a href="#cb50-67" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> x.view(x.size(<span class="dv">0</span>), <span class="op">-</span><span class="dv">1</span>) <span class="co">#not sure why but flatten doesn't work</span></span>
<span id="cb50-68"><a href="#cb50-68" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.fc(x)</span>
<span id="cb50-69"><a href="#cb50-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x</span>
<span id="cb50-70"><a href="#cb50-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-71"><a href="#cb50-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-72"><a href="#cb50-72" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ResidualBlock(nn.Module):</span>
<span id="cb50-73"><a href="#cb50-73" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,in_channels,out_channels,kernel_size,stride):</span>
<span id="cb50-74"><a href="#cb50-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb50-75"><a href="#cb50-75" aria-hidden="true" tabindex="-1"></a><span class="co">    Some math, input kernel to conv2_x is [64,56,56], can just do stride 1, size maintained</span></span>
<span id="cb50-76"><a href="#cb50-76" aria-hidden="true" tabindex="-1"></a><span class="co">    Input kernel to conv3_x is [64,56,56] want [128,28,28], after convolutions x is [128,28,28] (stride 2 at first then stride 1),</span></span>
<span id="cb50-77"><a href="#cb50-77" aria-hidden="true" tabindex="-1"></a><span class="co">    But x is still [64,56,56], so no padding, use kernel size 1 with 128 outchannels and stride 2</span></span>
<span id="cb50-78"><a href="#cb50-78" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb50-79"><a href="#cb50-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-80"><a href="#cb50-80" aria-hidden="true" tabindex="-1"></a>    <span class="bu">super</span>(ResidualBlock,<span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb50-81"><a href="#cb50-81" aria-hidden="true" tabindex="-1"></a>    <span class="co">#again note padding here is 1 because kernel is 3 by 3</span></span>
<span id="cb50-82"><a href="#cb50-82" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.conv1 <span class="op">=</span> nn.Sequential(</span>
<span id="cb50-83"><a href="#cb50-83" aria-hidden="true" tabindex="-1"></a>        nn.Conv2d(in_channels <span class="op">=</span> in_channels, out_channels <span class="op">=</span> out_channels, kernel_size <span class="op">=</span> <span class="dv">3</span>, stride <span class="op">=</span> stride, padding <span class="op">=</span> <span class="dv">1</span>),</span>
<span id="cb50-84"><a href="#cb50-84" aria-hidden="true" tabindex="-1"></a>        nn.BatchNorm2d(num_features <span class="op">=</span> out_channels),</span>
<span id="cb50-85"><a href="#cb50-85" aria-hidden="true" tabindex="-1"></a>        nn.ReLU()</span>
<span id="cb50-86"><a href="#cb50-86" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-87"><a href="#cb50-87" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.conv2 <span class="op">=</span> nn.Sequential(</span>
<span id="cb50-88"><a href="#cb50-88" aria-hidden="true" tabindex="-1"></a>        nn.Conv2d(in_channels <span class="op">=</span> out_channels, out_channels <span class="op">=</span> out_channels, kernel_size <span class="op">=</span> <span class="dv">3</span>, stride <span class="op">=</span> <span class="dv">1</span>, padding <span class="op">=</span> <span class="dv">1</span>),</span>
<span id="cb50-89"><a href="#cb50-89" aria-hidden="true" tabindex="-1"></a>        nn.BatchNorm2d(num_features <span class="op">=</span> out_channels) <span class="co">#don't do ReLU here since we might downsample</span></span>
<span id="cb50-90"><a href="#cb50-90" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-91"><a href="#cb50-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-92"><a href="#cb50-92" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.skip_connection <span class="op">=</span> nn.Sequential() <span class="co">#identity</span></span>
<span id="cb50-93"><a href="#cb50-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-94"><a href="#cb50-94" aria-hidden="true" tabindex="-1"></a>    <span class="co">#idea here is that skip_connection will add the input x to itself</span></span>
<span id="cb50-95"><a href="#cb50-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># but if stride != 1 or in_channels != out_channels, we need to change dimensions of x</span></span>
<span id="cb50-96"><a href="#cb50-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># so that the dimensions of x after conv1 and conv2 applied</span></span>
<span id="cb50-97"><a href="#cb50-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> stride <span class="op">!=</span> <span class="dv">1</span> <span class="kw">or</span> in_channels <span class="op">!=</span> out_channels:</span>
<span id="cb50-98"><a href="#cb50-98" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.skip_connection <span class="op">=</span> nn.Sequential(</span>
<span id="cb50-99"><a href="#cb50-99" aria-hidden="true" tabindex="-1"></a>          nn.Conv2d(in_channels,out_channels,kernel_size<span class="op">=</span><span class="dv">1</span>,stride<span class="op">=</span>stride),</span>
<span id="cb50-100"><a href="#cb50-100" aria-hidden="true" tabindex="-1"></a>          nn.BatchNorm2d(num_features <span class="op">=</span> out_channels)</span>
<span id="cb50-101"><a href="#cb50-101" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb50-102"><a href="#cb50-102" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.ReLU <span class="op">=</span> nn.ReLU()</span>
<span id="cb50-103"><a href="#cb50-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-104"><a href="#cb50-104" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> forward(<span class="va">self</span>,x):</span>
<span id="cb50-105"><a href="#cb50-105" aria-hidden="true" tabindex="-1"></a>    x_layer <span class="op">=</span> <span class="va">self</span>.conv1(x)</span>
<span id="cb50-106"><a href="#cb50-106" aria-hidden="true" tabindex="-1"></a>    x_layer <span class="op">=</span> <span class="va">self</span>.conv2(x_layer)</span>
<span id="cb50-107"><a href="#cb50-107" aria-hidden="true" tabindex="-1"></a>    x_layer <span class="op">+=</span> <span class="va">self</span>.skip_connection(x)</span>
<span id="cb50-108"><a href="#cb50-108" aria-hidden="true" tabindex="-1"></a>    x_layer <span class="op">=</span> <span class="va">self</span>.ReLU(x_layer)</span>
<span id="cb50-109"><a href="#cb50-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x_layer</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Loading trained models</p>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_model(filename, model, device):</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">"""</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="co">  Takes an untrained model as input, filename to saved model, and the device</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co">  """</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#model = EfficientNet.from_pretrained('efficientnet-b0',num_classes=3)</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  checkpoint <span class="op">=</span> torch.load(filename, map_location<span class="op">=</span>device)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="st">'Loading trained model weights...'</span>)</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>  model.load_state_dict(checkpoint[<span class="st">'model_state_dict'</span>],strict<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>  model <span class="op">=</span> model.to(device)</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="58f13ebc-6226-4874-ea4e-df10080959f5" data-execution_count="83">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> efficientnet_pytorch <span class="im">import</span> EfficientNet</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> models</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="co">#model_filename = '/content/drive/Shareddrives/CheXpert-v1.0-small/efficientnet-b0_bwa_equal_frontal_10000_exponential_lr.pth'</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co">#model_filename = '/content/drive/Shareddrives/CheXpert-v1.0-small/efficientb0_10000_bwa_equal_exponential_scheduler(3).pth'</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>model_filename <span class="op">=</span> <span class="st">'/content/drive/Shareddrives/CheXpert-v1.0-small/self_resnet18_bwa_frontal_exp_lr(3).pth'</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="co">#for EfficientNetB0</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="co">#model_saved = EfficientNet.from_pretrained('efficientnet-b0',num_classes=3)</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="co">#for pretrained ResNet18</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a><span class="co">model_saved = models.resnet18(weights='IMAGENET1K_V1')</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a><span class="co">num_ftrs = model_saved.fc.in_features</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a><span class="co">out_ftrs = 3</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="co">model_saved.fc = nn.Linear(num_ftrs, out_ftrs)</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a><span class="co">#for self-implmented Resnet18</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>model_saved <span class="op">=</span> Resnet18(num_classes<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>model_saved <span class="op">=</span> load_model(model_filename,model_saved,device)</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a><span class="co">#test_dataset = ChestXrayDataset("/content/drive/Shareddrives/", df_test_bwa[:2500], IMAGE_SIZE, True)</span></span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a><span class="co">#test_dataset = ChestXrayDataset("/content/drive/Shareddrives/", df_test_bwa_equal[:2500], IMAGE_SIZE, True)</span></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>test_dataset <span class="op">=</span> ChestXrayDataset(<span class="st">"/content/drive/Shareddrives/"</span>, df_test_bwa_equal_frontal, IMAGE_SIZE, <span class="va">True</span>)</span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a><span class="co">#test_dataset = ChestXrayDataset("/content/drive/Shareddrives/", df_test_bwa_frontal[:2500], IMAGE_SIZE, True)</span></span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>test_dataloader <span class="op">=</span> DataLoader(dataset<span class="op">=</span>test_dataset, batch_size<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">False</span>, num_workers<span class="op">=</span><span class="dv">2</span>, pin_memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>y_pred_enet, y_true_enet <span class="op">=</span> test(model_saved,test_dataloader)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loading trained model weights...
tensor([0, 1, 1, 1, 0, 1, 2, 1, 1, 0, 2, 2, 1, 0, 1, 2, 1, 1, 1, 0, 0, 2, 1, 0,
        2, 1, 1, 2, 0, 1, 0, 2, 0, 2, 0, 2, 0, 2, 2, 1, 0, 2, 0, 1, 2, 0, 0, 1,
        0, 1], device='cuda:0')
predicted:  tensor([0, 1, 1, 0, 2, 1, 2, 1, 2, 0, 2, 2, 1, 0, 1, 2, 2, 1, 0, 0, 0, 2, 1, 0,
        0, 2, 1, 0, 0, 1, 0, 1, 0, 2, 0, 2, 0, 2, 2, 1, 0, 0, 2, 1, 1, 0, 0, 1,
        1, 1], device='cuda:0')
tensor([0, 0, 0, 2, 0, 2, 1, 0, 0, 0, 1, 2, 2, 1, 2, 1, 2, 2, 2, 0, 0, 0, 1, 2,
        1, 2, 1, 2, 2, 1, 0, 0, 0, 0, 0, 2, 1, 0, 1, 2, 0, 2, 0, 1, 2, 2, 2, 0,
        0, 1], device='cuda:0')
predicted:  tensor([0, 0, 0, 2, 0, 2, 1, 0, 1, 2, 0, 2, 0, 0, 2, 1, 2, 0, 0, 0, 0, 1, 1, 2,
        2, 2, 2, 0, 0, 1, 0, 0, 2, 0, 0, 2, 1, 0, 1, 2, 0, 1, 0, 1, 1, 0, 2, 1,
        2, 1], device='cuda:0')
tensor([2, 2, 1, 1, 1, 1, 2, 1, 1, 0, 2, 1, 0, 1, 2, 1, 2, 1, 0, 2, 0, 1, 1, 0,
        0, 2, 2, 1, 2, 0, 2, 0, 0, 1, 0, 1, 1, 2, 2, 2, 1, 0, 1, 2, 0, 0, 0, 2,
        2, 1], device='cuda:0')
predicted:  tensor([2, 2, 1, 0, 1, 1, 2, 1, 1, 0, 2, 2, 0, 0, 0, 1, 1, 1, 1, 2, 0, 1, 1, 2,
        0, 0, 2, 1, 0, 0, 2, 1, 2, 1, 1, 1, 2, 2, 2, 1, 1, 0, 1, 2, 1, 0, 0, 1,
        2, 1], device='cuda:0')
tensor([1, 0, 1, 0, 2, 2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 0, 1, 2, 1, 0, 1, 1, 1,
        2, 2, 2, 0, 1, 2, 1, 1, 1, 0, 1, 1, 1, 0, 2, 2, 0, 0, 1, 0, 0, 0, 2, 2,
        0, 2], device='cuda:0')
predicted:  tensor([1, 0, 1, 0, 2, 2, 0, 0, 2, 1, 2, 2, 1, 2, 2, 0, 1, 1, 2, 1, 1, 1, 1, 0,
        2, 2, 2, 1, 1, 2, 1, 0, 1, 1, 1, 1, 1, 2, 2, 2, 1, 1, 1, 0, 0, 0, 2, 2,
        0, 2], device='cuda:0')
tensor([2, 0, 1, 1, 1, 2, 0, 2, 0, 1, 1, 0, 1, 1, 2, 0, 2, 1, 0, 1, 2, 0, 2, 2,
        2, 0, 0, 2, 1, 2, 1, 2, 0, 0, 2, 1, 2, 2, 2, 2, 1, 1, 0, 2, 0, 0, 1, 2,
        1, 2], device='cuda:0')
predicted:  tensor([2, 0, 1, 1, 0, 2, 0, 2, 1, 1, 2, 0, 0, 1, 2, 0, 0, 1, 1, 0, 2, 0, 0, 2,
        2, 0, 0, 2, 0, 2, 1, 2, 0, 0, 2, 0, 2, 2, 2, 2, 0, 1, 2, 2, 0, 1, 1, 2,
        1, 2], device='cuda:0')
tensor([2, 1, 0, 2, 2, 1, 0, 1, 2, 1, 0, 1, 2, 1, 1, 2, 0, 2, 0, 0, 0, 1, 0, 0,
        0, 2, 1, 0, 2, 0, 0, 1, 1, 2, 1, 0, 2, 0, 2, 0, 1, 1, 0, 1, 2, 2, 1, 0,
        1, 2], device='cuda:0')
predicted:  tensor([2, 1, 2, 2, 2, 1, 2, 1, 0, 1, 0, 1, 2, 1, 1, 2, 0, 2, 0, 0, 0, 1, 1, 0,
        1, 1, 1, 0, 2, 0, 1, 1, 1, 2, 2, 2, 2, 0, 1, 1, 1, 0, 0, 0, 2, 2, 1, 0,
        1, 1], device='cuda:0')
tensor([0, 1, 1, 0, 1, 0, 0, 0, 1, 1, 0, 2, 1, 0, 2, 2, 1, 1, 0, 0, 2, 1, 2, 0,
        1, 2, 2, 1, 2, 0, 1, 2, 0, 2, 1, 1, 1, 0, 2, 1, 2, 1, 2, 0, 2, 1, 1, 1,
        2, 0], device='cuda:0')
predicted:  tensor([0, 1, 1, 0, 0, 1, 0, 0, 0, 1, 1, 0, 1, 0, 1, 2, 1, 1, 1, 0, 2, 0, 1, 2,
        1, 2, 2, 1, 2, 0, 1, 2, 0, 2, 1, 1, 1, 0, 2, 1, 0, 1, 2, 0, 0, 2, 1, 2,
        2, 1], device='cuda:0')
tensor([0, 1, 2, 0, 1, 0, 2, 1, 2, 2, 2, 2, 1, 2, 0, 2, 2, 0, 0, 0, 0, 1, 1, 0,
        1, 0, 1, 2, 0, 1, 0, 2, 2, 1, 2, 2, 2, 2, 2, 0, 2, 1, 1, 1, 0, 0, 0, 2,
        0, 0], device='cuda:0')
predicted:  tensor([1, 1, 2, 1, 1, 0, 2, 1, 2, 1, 2, 2, 0, 2, 0, 2, 0, 0, 1, 0, 0, 1, 0, 1,
        0, 0, 1, 2, 0, 1, 0, 2, 0, 1, 2, 1, 2, 2, 2, 0, 2, 1, 1, 1, 0, 0, 0, 2,
        0, 0], device='cuda:0')
tensor([2, 2, 2, 2, 1, 1, 1, 2, 0, 0, 2, 1, 0, 1, 1, 0, 1, 2, 2, 2, 0, 2, 1, 2,
        0, 2, 0, 1, 0, 2, 2, 0, 0, 0, 2, 0, 2, 0, 1, 2, 0, 2, 2, 1, 0, 1, 0, 0,
        1, 1], device='cuda:0')
predicted:  tensor([2, 2, 2, 2, 0, 1, 1, 2, 0, 0, 2, 1, 2, 1, 1, 0, 0, 0, 2, 2, 1, 2, 0, 2,
        0, 2, 2, 1, 0, 2, 2, 1, 0, 0, 0, 0, 2, 0, 1, 2, 0, 2, 2, 1, 2, 1, 0, 0,
        0, 1], device='cuda:0')
tensor([0, 0, 2, 0, 1, 2, 1, 2, 2, 2, 2, 2, 0, 1, 1, 2, 2, 2, 2, 2, 0, 0, 0, 2,
        0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 1, 2, 0, 1, 0, 2, 2, 1, 1, 2, 0, 2, 0, 0,
        0, 0], device='cuda:0')
predicted:  tensor([1, 0, 2, 0, 0, 0, 0, 2, 2, 2, 2, 0, 0, 1, 1, 0, 2, 0, 1, 2, 2, 0, 2, 2,
        0, 1, 2, 0, 1, 0, 1, 0, 1, 0, 2, 1, 2, 1, 0, 2, 2, 1, 1, 0, 2, 2, 2, 1,
        1, 0], device='cuda:0')
tensor([1, 1, 2, 0, 1, 2, 0, 2, 2, 1, 0, 1, 1, 2, 1, 1, 0, 0, 1, 2, 2, 0, 0, 2,
        0, 1, 1, 0, 2, 2, 0, 0, 1, 0, 1, 2, 2, 1, 1, 0, 0, 2, 0, 0, 0, 0, 0, 1,
        0, 1], device='cuda:0')
predicted:  tensor([1, 2, 2, 1, 1, 2, 0, 0, 2, 1, 0, 1, 1, 2, 2, 0, 0, 1, 0, 2, 0, 0, 0, 1,
        2, 1, 1, 0, 0, 2, 0, 0, 1, 2, 1, 2, 2, 0, 0, 2, 2, 0, 0, 0, 0, 0, 0, 0,
        0, 1], device='cuda:0')
tensor([0, 0, 0, 1, 2, 0, 1, 2, 2, 1, 1, 1, 0, 1, 1, 2, 1, 0, 1, 2, 1, 0, 0, 1,
        1, 0, 2, 0, 1, 2, 1, 2, 2, 0, 2, 0, 2, 0, 0, 0, 1, 2, 1, 0, 2, 0, 2, 0,
        0, 0], device='cuda:0')
predicted:  tensor([0, 0, 1, 0, 2, 0, 1, 0, 2, 1, 1, 0, 0, 1, 0, 2, 1, 2, 2, 1, 1, 1, 0, 0,
        1, 0, 0, 0, 1, 2, 1, 2, 2, 0, 0, 2, 0, 1, 0, 1, 1, 2, 1, 0, 2, 2, 2, 0,
        1, 1], device='cuda:0')
tensor([0, 0, 0, 1, 2, 0, 0, 2, 0, 1, 0, 1, 0, 2, 2, 2, 1, 2, 0, 2, 0, 2, 1, 1,
        2, 2, 1, 2, 0, 0, 1, 0, 1, 1, 0, 1, 0, 1, 2, 1, 0, 0, 2, 1, 0, 1, 0, 2,
        0, 1], device='cuda:0')
predicted:  tensor([0, 0, 2, 1, 1, 0, 0, 2, 2, 1, 0, 1, 0, 2, 0, 1, 2, 1, 2, 2, 0, 2, 1, 2,
        2, 2, 1, 2, 1, 0, 1, 0, 1, 1, 0, 0, 0, 0, 2, 0, 0, 1, 2, 1, 0, 1, 2, 0,
        0, 1], device='cuda:0')
tensor([0, 1, 0, 0, 1, 1, 2, 0, 1, 0, 2, 1, 1, 2, 1, 0, 0, 1, 2, 0, 0, 2, 2, 2,
        0, 1, 0, 1, 2, 2, 2, 1, 0, 1, 1, 2, 0, 2, 2, 0, 0, 0, 1, 1, 2, 2, 1, 1,
        1, 0], device='cuda:0')
predicted:  tensor([0, 1, 2, 0, 1, 1, 2, 0, 0, 1, 2, 0, 1, 0, 0, 2, 0, 1, 2, 0, 1, 0, 2, 0,
        1, 1, 0, 1, 0, 2, 2, 1, 2, 2, 1, 0, 0, 2, 2, 0, 2, 2, 2, 1, 0, 1, 1, 1,
        1, 2], device='cuda:0')
tensor([1, 1, 1, 2, 1, 0, 2, 2, 0, 1, 2, 0, 1, 1, 2, 0, 1, 2, 2, 0, 0, 1, 0, 0,
        1, 0, 0, 1, 0, 1, 0, 2, 1, 1, 0, 0, 2, 2, 0, 1, 1, 2, 2, 1, 1, 0, 0, 1,
        1, 1], device='cuda:0')
predicted:  tensor([1, 2, 1, 2, 1, 0, 0, 0, 0, 1, 0, 0, 1, 1, 1, 0, 1, 2, 2, 0, 0, 0, 0, 0,
        0, 0, 0, 1, 0, 2, 0, 0, 1, 1, 0, 1, 2, 2, 0, 1, 2, 0, 2, 1, 1, 2, 0, 0,
        1, 1], device='cuda:0')
tensor([1, 2, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 1, 0, 1, 2, 0, 1, 1, 0, 1, 0,
        2, 1, 0, 2, 2, 1, 1, 0, 1, 0, 0, 1, 0, 2, 1, 2, 2, 2, 1, 1, 0, 1, 2, 2,
        2, 0], device='cuda:0')
predicted:  tensor([1, 2, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 2, 0, 1, 0, 1, 2, 0, 1, 1, 0, 1, 0,
        2, 0, 0, 2, 0, 1, 2, 2, 0, 0, 0, 1, 2, 0, 1, 2, 2, 0, 0, 1, 0, 1, 2, 2,
        1, 1], device='cuda:0')
tensor([1, 1, 0, 2, 0, 2, 2, 0, 2, 2, 0, 1, 0, 0, 2, 2, 1, 1, 2, 2, 0, 0, 0, 2,
        0, 2, 1, 1, 0, 2, 0, 0, 1, 1, 1, 2, 2, 2, 0, 1, 0, 0, 2, 0, 2, 0, 1, 0,
        0, 2], device='cuda:0')
predicted:  tensor([1, 1, 2, 2, 1, 1, 2, 0, 2, 0, 0, 1, 0, 1, 2, 2, 2, 0, 2, 2, 0, 0, 0, 1,
        1, 1, 1, 2, 1, 1, 0, 0, 1, 0, 1, 2, 2, 2, 0, 2, 1, 0, 2, 0, 2, 0, 0, 0,
        1, 2], device='cuda:0')
tensor([1, 0, 0, 0, 1, 1, 1, 1, 2, 1, 0, 2, 0, 2, 1, 2, 2, 2, 1, 1, 2, 2, 0, 2,
        1, 2, 1, 2, 1, 2, 1, 1, 2, 2, 1, 1, 0, 2, 1, 0, 0, 0, 1, 0, 1, 2, 1, 2,
        1, 2], device='cuda:0')
predicted:  tensor([0, 2, 0, 2, 1, 1, 1, 0, 2, 1, 2, 0, 0, 1, 1, 0, 2, 2, 2, 1, 0, 0, 0, 2,
        1, 2, 1, 0, 1, 2, 1, 1, 2, 2, 1, 0, 0, 2, 1, 0, 0, 0, 1, 0, 0, 2, 1, 2,
        0, 2], device='cuda:0')
tensor([2, 0, 2, 2, 1, 0, 2, 2, 1, 2, 2, 2, 0, 0, 0, 2, 0, 0, 0, 2, 1, 2, 2, 2,
        1, 0, 2, 1, 1, 0, 2, 0, 1, 1, 0, 0, 2, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 1,
        2, 1], device='cuda:0')
predicted:  tensor([2, 0, 2, 2, 1, 2, 1, 1, 1, 2, 2, 2, 2, 0, 0, 2, 1, 1, 0, 2, 0, 2, 2, 2,
        1, 2, 2, 0, 0, 0, 2, 0, 1, 1, 1, 0, 2, 0, 0, 0, 2, 0, 1, 2, 0, 0, 2, 1,
        2, 1], device='cuda:0')
tensor([1, 1, 1, 1, 0, 1, 1, 1, 2, 0, 2, 0, 0, 2, 2, 2, 2, 1, 1, 2, 1, 1, 2, 2,
        0, 0, 2, 2, 1, 1, 1, 2, 0, 1, 1, 0, 1, 0, 1, 1, 0, 0, 0, 2, 0, 2, 0, 1,
        2, 1], device='cuda:0')
predicted:  tensor([2, 1, 1, 1, 0, 1, 1, 2, 0, 0, 2, 0, 0, 2, 2, 1, 2, 1, 0, 0, 1, 0, 2, 1,
        0, 0, 2, 2, 1, 1, 1, 2, 0, 2, 1, 0, 1, 0, 1, 1, 0, 2, 2, 0, 0, 0, 1, 1,
        2, 1], device='cuda:0')
tensor([2, 0, 0, 0, 2, 0, 1, 0, 2, 0, 1, 2, 1, 2, 2, 2, 1, 2, 1, 0, 2, 1, 2, 0,
        0, 0, 0, 2, 1, 0, 2, 1, 2, 1, 2, 1, 2, 2, 2, 1, 0, 1, 2, 0, 1, 0, 1, 1,
        0, 2], device='cuda:0')
predicted:  tensor([2, 0, 0, 0, 2, 0, 1, 0, 2, 0, 0, 2, 1, 2, 2, 2, 1, 2, 2, 0, 0, 0, 2, 2,
        1, 2, 0, 2, 1, 0, 2, 1, 2, 1, 2, 1, 2, 2, 2, 1, 0, 1, 2, 0, 1, 0, 1, 1,
        0, 2], device='cuda:0')
tensor([0, 1, 0, 2, 1, 1, 2, 1, 2, 0, 2, 2, 0, 0, 0, 0, 2, 0, 2, 1, 0, 1, 1, 2,
        0, 0, 0, 0, 1, 0, 1, 1, 1, 2, 2, 1, 0, 0, 2, 1, 2, 1, 0, 1, 1, 0, 0, 2,
        2, 0], device='cuda:0')
predicted:  tensor([1, 1, 0, 2, 1, 1, 2, 1, 0, 0, 2, 2, 2, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0,
        2, 0, 1, 1, 1, 0, 1, 1, 0, 2, 2, 1, 0, 2, 2, 1, 2, 1, 0, 0, 1, 2, 0, 1,
        2, 1], device='cuda:0')
tensor([2, 2, 2, 0, 0, 0, 0, 2, 1, 1, 2, 2, 0, 1, 1, 2, 2, 0, 1, 1, 0, 1, 1, 0,
        2, 0, 2, 1, 2, 2, 1, 1, 1, 0, 1, 1, 0, 2, 1, 1, 2, 1, 2, 0, 1, 2, 2, 0,
        1, 0], device='cuda:0')
predicted:  tensor([2, 2, 2, 1, 0, 0, 0, 1, 1, 2, 1, 2, 0, 0, 1, 2, 0, 0, 1, 1, 2, 1, 0, 1,
        2, 1, 0, 1, 2, 0, 1, 1, 1, 0, 1, 1, 0, 2, 1, 1, 2, 1, 0, 1, 1, 2, 2, 0,
        1, 0], device='cuda:0')
tensor([0, 0, 2, 1, 1, 0, 1, 0, 2, 2, 2, 0, 2, 2, 2, 1, 2, 0, 2, 1, 0, 1, 1, 1,
        0, 2, 1, 1, 2, 2, 0, 1, 2, 2, 1, 1, 2, 2, 0, 0, 2, 0, 2, 0, 0, 0, 0, 0,
        1, 0], device='cuda:0')
predicted:  tensor([0, 0, 2, 0, 1, 0, 2, 0, 0, 2, 2, 0, 2, 2, 0, 0, 2, 0, 2, 1, 1, 0, 2, 1,
        0, 2, 0, 1, 2, 2, 2, 0, 2, 2, 1, 2, 2, 2, 1, 0, 0, 0, 2, 1, 0, 0, 1, 0,
        1, 1], device='cuda:0')
tensor([2, 2, 1, 1, 0, 1, 2, 1, 2, 0, 2, 1, 2, 1, 1, 0, 0, 2, 1, 2, 0, 1, 1, 0,
        1, 1, 2, 1, 2, 0, 0, 0, 2, 1, 0, 0, 2, 2, 1, 2, 0, 1, 1, 1, 1, 2, 0, 2,
        2, 1], device='cuda:0')
predicted:  tensor([0, 2, 1, 0, 0, 1, 1, 0, 2, 0, 0, 1, 0, 1, 1, 0, 0, 0, 1, 2, 0, 1, 2, 0,
        0, 0, 2, 1, 2, 0, 0, 0, 2, 0, 0, 0, 0, 0, 1, 1, 0, 1, 1, 1, 0, 0, 2, 0,
        2, 1], device='cuda:0')
tensor([1, 1, 1, 0, 1, 0, 2, 1, 2, 1, 1, 1, 1, 0, 0, 2, 2, 2, 0, 2, 2, 0, 1, 0,
        2, 1, 0, 1, 0, 0, 2, 2, 2, 0, 2, 0, 0, 2, 1, 2, 0, 0, 2, 1, 0, 0, 1, 2,
        0, 0], device='cuda:0')
predicted:  tensor([1, 1, 1, 0, 1, 2, 2, 1, 2, 2, 1, 1, 1, 0, 1, 2, 2, 2, 0, 2, 2, 0, 2, 0,
        2, 1, 0, 2, 0, 2, 2, 2, 2, 1, 2, 0, 0, 2, 2, 2, 1, 1, 0, 1, 0, 0, 1, 2,
        0, 1], device='cuda:0')
tensor([2, 0, 0, 2, 0, 1, 1, 0, 1, 2, 0, 0, 2, 1, 2, 0, 2, 0, 0, 2, 1, 2, 0, 2,
        0, 1, 0, 0, 1, 2, 0, 1, 1, 0, 2, 0, 0, 0, 2, 0, 1, 1, 1, 1, 0, 0, 2, 1,
        0, 1], device='cuda:0')
predicted:  tensor([2, 0, 0, 1, 1, 1, 0, 0, 1, 2, 0, 0, 1, 0, 2, 2, 2, 0, 0, 2, 1, 2, 0, 2,
        2, 2, 0, 0, 1, 2, 0, 1, 2, 0, 2, 2, 0, 0, 2, 1, 1, 1, 2, 0, 2, 0, 0, 1,
        0, 0], device='cuda:0')
tensor([0, 0, 1, 2, 1, 0, 1, 0, 1, 2, 2, 2, 1, 0, 2, 2, 2, 0, 0, 2, 2, 0, 2, 1,
        1, 1, 2, 1, 1, 1, 2, 2, 1, 2, 1, 0, 0, 1, 0, 2, 2, 2, 0, 0, 1, 1, 0, 1,
        0, 2], device='cuda:0')
predicted:  tensor([2, 2, 1, 2, 1, 0, 0, 0, 1, 0, 2, 2, 1, 0, 2, 2, 2, 0, 1, 2, 0, 0, 1, 1,
        1, 2, 2, 1, 1, 0, 2, 2, 1, 2, 2, 1, 0, 1, 0, 0, 2, 2, 0, 0, 1, 1, 1, 1,
        0, 2], device='cuda:0')
tensor([2, 2, 0, 1, 2, 0, 2, 2, 0, 2, 1, 2, 1, 1, 2, 2, 2, 2, 1, 1, 0, 0, 0, 1,
        1, 0, 2, 1, 0, 0, 0, 0, 2, 1, 1, 2, 1, 1, 1, 2, 0, 1, 0, 2, 2, 2, 0, 2,
        0, 0], device='cuda:0')
predicted:  tensor([0, 2, 1, 1, 0, 2, 2, 2, 0, 2, 1, 2, 1, 1, 2, 2, 2, 2, 0, 1, 0, 0, 2, 1,
        0, 0, 2, 0, 0, 0, 0, 1, 2, 2, 1, 2, 1, 1, 0, 0, 0, 1, 0, 2, 1, 1, 0, 1,
        2, 2], device='cuda:0')
tensor([2, 0, 2, 0, 2, 1, 2, 2, 2, 1, 2, 0, 0, 0, 0, 1, 2, 2, 0, 1, 2, 0, 0, 0,
        1, 2, 0, 1, 2, 1, 2, 0, 0, 0, 1, 0, 0, 0, 1, 2, 2, 0, 1, 2, 1, 1, 0, 2,
        0, 2], device='cuda:0')
predicted:  tensor([2, 0, 0, 0, 2, 1, 0, 0, 2, 1, 2, 2, 0, 0, 0, 1, 2, 2, 0, 1, 2, 0, 1, 0,
        1, 2, 0, 1, 2, 1, 2, 1, 0, 0, 1, 0, 0, 0, 1, 2, 1, 0, 1, 2, 1, 1, 0, 2,
        2, 2], device='cuda:0')
tensor([2, 2, 1, 0, 1, 2, 1, 0, 1, 0, 0, 0, 2, 1, 0, 2, 0, 2, 0, 1, 0, 2, 2, 0,
        0, 0, 2, 2, 0, 2, 2, 0, 1, 0, 2, 2, 0, 2, 1, 1, 0, 0, 2, 2, 2, 2, 2, 1,
        1, 0], device='cuda:0')
predicted:  tensor([2, 0, 1, 0, 1, 2, 2, 2, 0, 2, 0, 2, 2, 1, 1, 0, 0, 2, 0, 1, 1, 2, 2, 0,
        0, 0, 2, 2, 2, 2, 1, 0, 2, 1, 0, 2, 0, 2, 1, 0, 1, 2, 2, 2, 2, 2, 2, 1,
        0, 0], device='cuda:0')
tensor([1, 0, 1, 0, 0, 0, 2, 2, 0, 1, 2, 1, 1, 0, 1, 1, 1, 0, 0, 0, 1, 2, 1, 1,
        0, 0, 0, 1, 1, 2, 2, 2, 2, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 2, 2, 1, 2, 1,
        1, 0], device='cuda:0')
predicted:  tensor([1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 2, 1, 1, 2, 0, 1, 1, 0, 0, 0, 1, 0, 1, 2,
        0, 2, 0, 0, 1, 0, 0, 0, 2, 2, 0, 2, 0, 0, 1, 1, 0, 2, 1, 1, 2, 0, 0, 1,
        1, 0], device='cuda:0')
tensor([0, 1, 0, 1, 1, 2, 0, 2, 1, 0, 0, 0, 2, 0, 1, 0, 2, 0, 0, 0, 0, 2, 0, 2,
        2, 2, 0, 0, 1, 0, 1, 2, 1, 1, 0, 0, 0, 0, 0, 2, 2, 1, 2, 2, 2, 1, 2, 0,
        0, 1], device='cuda:0')
predicted:  tensor([0, 1, 0, 1, 1, 2, 0, 0, 2, 0, 0, 1, 2, 0, 1, 0, 2, 0, 0, 0, 1, 0, 0, 2,
        2, 2, 1, 1, 1, 0, 1, 2, 2, 1, 0, 0, 1, 2, 2, 2, 1, 1, 0, 0, 2, 2, 2, 2,
        0, 1], device='cuda:0')
tensor([0, 2, 0, 1, 2, 2, 1, 1, 1, 2, 1, 2, 1, 2, 2, 0, 1, 2, 0, 1, 2, 0, 0, 2,
        0, 1, 0, 0, 2, 2, 1, 1, 2, 2, 1, 2, 1, 0, 2, 2, 0, 1, 2, 2, 0, 0, 0, 2,
        1, 2], device='cuda:0')
predicted:  tensor([0, 2, 0, 1, 1, 1, 1, 1, 1, 0, 0, 2, 1, 2, 2, 0, 1, 0, 0, 0, 2, 1, 0, 2,
        0, 1, 0, 0, 2, 2, 1, 1, 0, 2, 1, 2, 1, 0, 0, 2, 0, 1, 2, 2, 1, 0, 0, 2,
        2, 0], device='cuda:0')
tensor([1, 1, 0, 1, 0, 1, 1, 2, 1, 0, 1, 1, 1, 1, 1, 2, 0, 1, 2, 2, 0, 0, 1, 2,
        1, 1, 2, 1, 0, 0, 1, 1, 1, 1, 0, 2, 1, 2, 1, 0, 1, 2, 0, 2, 2, 0, 1, 1,
        2, 0], device='cuda:0')
predicted:  tensor([1, 1, 0, 0, 1, 1, 1, 0, 1, 2, 1, 1, 0, 1, 1, 1, 0, 1, 0, 2, 2, 0, 1, 2,
        1, 1, 2, 1, 0, 1, 1, 1, 2, 0, 1, 2, 1, 0, 1, 0, 2, 2, 0, 2, 2, 0, 1, 1,
        1, 0], device='cuda:0')
tensor([1, 0, 2, 0, 1, 2, 1, 2, 1, 0, 2, 1, 1, 2, 2, 0, 0, 2, 0, 1, 2, 1, 2, 1,
        1, 1, 0, 2, 2, 2, 2, 1, 0, 1, 0, 1, 2, 2, 1, 2, 2, 2, 2, 2, 2, 0, 0, 1,
        1, 2], device='cuda:0')
predicted:  tensor([1, 0, 1, 0, 1, 1, 1, 2, 1, 0, 2, 2, 1, 0, 2, 2, 0, 2, 1, 1, 2, 1, 0, 1,
        2, 0, 0, 2, 2, 1, 0, 1, 0, 0, 2, 1, 0, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0,
        1, 0], device='cuda:0')
tensor([1, 0, 2, 0, 0, 0, 0, 1, 0, 0, 0, 2, 2, 0, 0, 2, 2, 1, 1, 1, 2, 0, 0, 2,
        1, 2, 0, 1, 0, 1, 2, 2, 0, 0, 2, 2, 0, 1, 0, 2, 0, 2, 1, 2, 0, 1, 1, 2,
        1, 1], device='cuda:0')
predicted:  tensor([2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 2, 2, 1, 2, 2, 2, 2, 2, 1, 1, 2, 0, 0, 2,
        0, 0, 0, 0, 0, 1, 2, 2, 0, 0, 0, 2, 0, 0, 0, 2, 0, 0, 1, 0, 0, 1, 0, 2,
        1, 1], device='cuda:0')
tensor([0, 2, 0, 1, 1, 0, 1, 0, 2, 1, 1, 1, 2, 2, 0, 0, 2, 0, 1, 1, 2, 2, 0, 0,
        0, 1, 0, 1, 2, 0, 1, 1, 1, 1, 1, 0, 0, 1, 0, 2, 1, 0, 0, 2, 1, 0, 0, 0,
        2, 0], device='cuda:0')
predicted:  tensor([0, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 2, 2, 0, 0, 1, 0, 1, 1, 2, 2, 0, 0,
        0, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 0, 2, 1, 0, 2, 2, 1, 0, 0, 0,
        2, 0], device='cuda:0')
tensor([2, 1, 0, 0, 2, 1, 1, 1, 1, 0, 0, 1, 0, 1, 0, 0, 1, 0, 1, 2, 2, 2, 2, 2,
        0, 1, 2, 0, 0, 0, 1, 1, 0, 1, 2, 0, 0, 1, 1, 0, 2, 2, 2, 1, 1, 2, 2, 0,
        2, 0], device='cuda:0')
predicted:  tensor([1, 1, 2, 0, 0, 1, 1, 1, 1, 2, 1, 1, 1, 1, 0, 0, 1, 1, 1, 2, 2, 2, 2, 2,
        0, 1, 0, 0, 0, 2, 2, 2, 0, 1, 2, 0, 0, 2, 0, 0, 2, 2, 2, 1, 1, 2, 2, 0,
        0, 1], device='cuda:0')
tensor([2, 2, 1, 0, 0, 0, 2, 1, 2, 1, 0, 1, 2, 1, 2, 0, 1, 1, 1, 0, 0, 2, 2, 0,
        1, 1, 1, 1, 0, 0, 1, 1, 0, 2, 1, 0, 0, 2, 0, 2, 2, 1, 0, 0, 2, 2, 2, 1,
        2, 1], device='cuda:0')
predicted:  tensor([2, 1, 1, 0, 0, 0, 2, 1, 0, 1, 0, 0, 2, 1, 2, 0, 1, 1, 1, 0, 0, 2, 0, 2,
        0, 2, 1, 2, 0, 0, 1, 2, 0, 2, 1, 0, 0, 2, 0, 1, 2, 1, 0, 0, 2, 2, 2, 1,
        0, 1], device='cuda:0')
tensor([2, 2, 2, 2, 1, 0, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 2, 2, 2, 0, 2, 1, 2, 1,
        1, 1, 2, 2, 2, 1, 1, 0, 2, 0, 1, 0, 2, 1, 1, 2, 0, 2, 2, 2, 0, 2, 2, 1,
        1, 2], device='cuda:0')
predicted:  tensor([2, 2, 2, 0, 1, 0, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 2, 2, 2, 1, 2, 1, 2, 0,
        0, 1, 2, 2, 2, 2, 1, 0, 2, 0, 0, 0, 2, 0, 1, 0, 1, 0, 2, 2, 2, 2, 0, 1,
        1, 2], device='cuda:0')
tensor([0, 2, 0, 1, 2, 1, 0, 1, 2, 0, 1, 2, 1, 2, 2, 0, 2, 1, 1, 2, 0, 0, 0, 0,
        0, 1, 2, 2, 1, 1, 1, 2, 0, 1, 0, 2, 1, 2, 2, 2, 0, 0, 0, 2, 2, 2, 1, 2,
        0, 0], device='cuda:0')
predicted:  tensor([1, 0, 0, 1, 1, 1, 0, 0, 2, 0, 1, 2, 1, 2, 0, 0, 2, 2, 1, 2, 0, 0, 0, 2,
        0, 1, 2, 2, 0, 1, 1, 0, 1, 1, 0, 2, 1, 2, 2, 2, 0, 0, 1, 2, 2, 0, 0, 2,
        0, 0], device='cuda:0')
tensor([2, 1, 1, 1, 2, 0, 1, 0, 0, 2, 1, 2, 1, 0, 2, 1, 0, 1, 2, 1, 0, 0, 1, 1,
        0, 2, 2, 1, 2, 2, 1, 1, 2, 2, 0, 0, 0, 0, 0, 1, 0, 2, 0, 0, 0, 0, 1, 2,
        2, 0], device='cuda:0')
predicted:  tensor([1, 1, 2, 1, 0, 0, 1, 0, 0, 2, 1, 2, 1, 2, 2, 2, 1, 0, 0, 1, 0, 0, 0, 0,
        0, 2, 2, 1, 2, 2, 0, 1, 0, 1, 0, 0, 0, 1, 1, 1, 1, 2, 0, 0, 0, 0, 1, 2,
        2, 0], device='cuda:0')
tensor([0, 2, 2, 0, 1, 2, 2, 0, 0, 0, 0, 0, 0, 0, 2, 0, 2, 0, 1, 1, 0, 0, 2, 1,
        0, 0, 1, 2, 0, 0, 2, 0, 2, 2, 1, 0, 2, 0, 0, 1, 2, 0, 1, 2, 1, 1, 0, 1,
        0, 1], device='cuda:0')
predicted:  tensor([0, 0, 2, 2, 1, 2, 2, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 1, 1, 0, 0, 2, 1,
        0, 0, 0, 2, 0, 0, 2, 0, 2, 2, 1, 0, 2, 0, 0, 1, 0, 1, 0, 2, 1, 1, 0, 1,
        2, 0], device='cuda:0')
tensor([1, 1, 2, 0, 2, 0, 2, 0, 0, 0, 0, 1, 2, 1, 2, 1, 0, 0, 0, 2, 0, 2, 1, 1,
        1, 1, 0, 0, 1, 2, 0, 2, 2, 1, 0, 0, 2, 0, 0, 2, 0, 0, 0, 2, 0, 1, 0, 0,
        1, 2], device='cuda:0')
predicted:  tensor([1, 1, 2, 0, 2, 1, 1, 1, 2, 0, 1, 2, 2, 2, 2, 2, 0, 2, 1, 2, 0, 2, 1, 2,
        1, 2, 0, 0, 1, 2, 0, 2, 2, 0, 2, 0, 2, 0, 0, 2, 2, 0, 0, 2, 0, 1, 1, 0,
        0, 2], device='cuda:0')
tensor([0, 1, 2, 1, 1, 2, 2, 1, 0, 2, 2, 2, 0, 2, 0, 0, 2, 1, 1, 1, 1, 2, 1, 0,
        0, 2, 1, 0, 1, 1, 1, 1, 0, 1, 0, 0, 2, 0, 2, 1, 1, 0, 1, 1, 2, 0, 2, 2,
        0, 2], device='cuda:0')
predicted:  tensor([1, 1, 1, 1, 1, 2, 2, 0, 0, 2, 1, 2, 0, 0, 1, 0, 0, 2, 1, 0, 1, 2, 1, 0,
        0, 2, 1, 2, 1, 1, 1, 1, 0, 1, 2, 0, 0, 0, 2, 2, 2, 0, 2, 1, 0, 0, 2, 2,
        2, 2], device='cuda:0')
tensor([2, 2, 1, 0, 2, 2, 1, 0, 2, 0, 0, 1, 2, 0, 1, 2, 0, 2, 2, 1, 2, 0, 1, 1,
        0, 1, 2, 1, 0, 0, 1, 1, 0, 2, 1, 2, 0, 0, 1, 2, 2, 1, 2, 2, 1, 2, 2, 2,
        1, 1], device='cuda:0')
predicted:  tensor([2, 0, 1, 0, 2, 2, 0, 0, 2, 0, 0, 1, 2, 0, 1, 2, 0, 2, 0, 0, 2, 0, 1, 1,
        0, 1, 1, 1, 0, 2, 1, 1, 2, 2, 1, 0, 0, 0, 1, 2, 2, 1, 1, 1, 1, 1, 0, 1,
        0, 1], device='cuda:0')
tensor([0], device='cuda:0')
predicted:  tensor([0], device='cuda:0')
Test accuracy: 70 %</code></pre>
</div>
</div>
<div class="cell" data-outputid="34a8bae2-6cdf-47cf-f618-ce89cc3fa7ae">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>inputs <span class="op">=</span> torch.rand(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">224</span>, <span class="dv">224</span>)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>model_saved.extract_features(inputs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>RuntimeError: ignored</code></pre>
</div>
</div>
<div class="cell" data-outputid="3ead5282-46b3-432b-d161-e1fb1d311096" data-execution_count="84">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>cf_matrix <span class="op">=</span> confusion_matrix(y_true_enet, y_pred_enet)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cf_matrix)</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>classes <span class="op">=</span> [<span class="st">'White'</span>,<span class="st">'Black'</span>,<span class="st">'Asian'</span>]</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>df_cm <span class="op">=</span> pd.DataFrame(cf_matrix <span class="op">/</span> np.<span class="bu">sum</span>(cf_matrix, axis<span class="op">=</span><span class="dv">1</span>)[:, <span class="va">None</span>], index <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> classes],</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>                     columns <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> classes])</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_cm)</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize <span class="op">=</span> (<span class="dv">12</span>,<span class="dv">7</span>))</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>sns.heatmap(df_cm, annot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">'output.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[573 130 114]
 [139 537  83]
 [157  76 542]]
          White     Black     Asian
White  0.701346  0.159119  0.139535
Black  0.183136  0.707510  0.109354
Asian  0.202581  0.098065  0.699355</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-38-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Model Optimization</p>
<p>We will do hold-out optimization as our dataset is large enough that cross validation is not neccessary. Moreover, training times for the algorithm are expensive.</p>
<div class="cell" data-outputid="5ab72e8d-82fc-4f2f-dbcf-41e9cfee13fc" data-execution_count="85">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.optim <span class="im">as</span> optim</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.optim.lr_scheduler <span class="im">as</span> lr_scheduler</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset, DataLoader,TensorDataset,random_split,SubsetRandomSampler, ConcatDataset</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> KFold</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> models</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> efficientnet_pytorch <span class="im">import</span> EfficientNet</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_epoch(model, trainloader, optimizer, loss_fn, print_every <span class="op">=</span> <span class="dv">2000</span>):</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>  training_loss <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>  num_batches <span class="op">=</span> <span class="bu">len</span>(trainloader)</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>  model.train()</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>  running_loss <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> i, data <span class="kw">in</span> <span class="bu">enumerate</span>(trainloader, <span class="dv">0</span>):</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>      X, y <span class="op">=</span> data</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>      X <span class="op">=</span> X.to(device)</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>      y <span class="op">=</span> torch.flatten(y)</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>      y <span class="op">=</span> y.to(torch.<span class="bu">long</span>)</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>      y <span class="op">=</span> y.to(device)</span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>      optimizer.zero_grad()</span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>      y_hat <span class="op">=</span> model(X)</span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>      loss <span class="op">=</span> loss_fn(y_hat, y)</span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a>      loss.backward()</span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a>      optimizer.step()</span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a>      training_loss <span class="op">+=</span> loss.item()</span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a>      running_loss <span class="op">+=</span> loss.item()</span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (i <span class="op">%</span> <span class="dv">20</span> <span class="op">==</span> <span class="dv">19</span>):</span>
<span id="cb58-41"><a href="#cb58-41" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Batch "</span>,i,<span class="st">"/"</span>,num_batches, <span class="st">" done! Training loss: "</span>,running_loss<span class="op">/</span><span class="dv">20</span>)</span>
<span id="cb58-42"><a href="#cb58-42" aria-hidden="true" tabindex="-1"></a>        running_loss <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb58-43"><a href="#cb58-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-44"><a href="#cb58-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> training_loss<span class="op">/</span>num_batches</span>
<span id="cb58-45"><a href="#cb58-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-46"><a href="#cb58-46" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_epoch(model, testloader, loss_fn):</span>
<span id="cb58-47"><a href="#cb58-47" aria-hidden="true" tabindex="-1"></a>  correct <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb58-48"><a href="#cb58-48" aria-hidden="true" tabindex="-1"></a>  total <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb58-49"><a href="#cb58-49" aria-hidden="true" tabindex="-1"></a>  running_loss <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb58-50"><a href="#cb58-50" aria-hidden="true" tabindex="-1"></a>  num_batches <span class="op">=</span> <span class="bu">len</span>(testloader)</span>
<span id="cb58-51"><a href="#cb58-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-52"><a href="#cb58-52" aria-hidden="true" tabindex="-1"></a>  model.<span class="bu">eval</span>()</span>
<span id="cb58-53"><a href="#cb58-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-54"><a href="#cb58-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">with</span> torch.no_grad():</span>
<span id="cb58-55"><a href="#cb58-55" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> data, label <span class="kw">in</span> testloader:</span>
<span id="cb58-56"><a href="#cb58-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-57"><a href="#cb58-57" aria-hidden="true" tabindex="-1"></a>          X <span class="op">=</span> data</span>
<span id="cb58-58"><a href="#cb58-58" aria-hidden="true" tabindex="-1"></a>          y <span class="op">=</span> label</span>
<span id="cb58-59"><a href="#cb58-59" aria-hidden="true" tabindex="-1"></a>          X <span class="op">=</span> X.to(device)</span>
<span id="cb58-60"><a href="#cb58-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-61"><a href="#cb58-61" aria-hidden="true" tabindex="-1"></a>          y <span class="op">=</span> torch.flatten(label)</span>
<span id="cb58-62"><a href="#cb58-62" aria-hidden="true" tabindex="-1"></a>          y <span class="op">=</span> y.to(torch.<span class="bu">long</span>)</span>
<span id="cb58-63"><a href="#cb58-63" aria-hidden="true" tabindex="-1"></a>          y <span class="op">=</span> y.to(device)</span>
<span id="cb58-64"><a href="#cb58-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-65"><a href="#cb58-65" aria-hidden="true" tabindex="-1"></a>          y_hat <span class="op">=</span> model(X)</span>
<span id="cb58-66"><a href="#cb58-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-67"><a href="#cb58-67" aria-hidden="true" tabindex="-1"></a>          _, predicted <span class="op">=</span> torch.<span class="bu">max</span>(y_hat.data, <span class="dv">1</span>)</span>
<span id="cb58-68"><a href="#cb58-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-69"><a href="#cb58-69" aria-hidden="true" tabindex="-1"></a>          <span class="co"># compute the accuracy</span></span>
<span id="cb58-70"><a href="#cb58-70" aria-hidden="true" tabindex="-1"></a>          total <span class="op">+=</span> y.size(<span class="dv">0</span>)</span>
<span id="cb58-71"><a href="#cb58-71" aria-hidden="true" tabindex="-1"></a>          correct <span class="op">+=</span> (predicted <span class="op">==</span> y).<span class="bu">sum</span>().item()</span>
<span id="cb58-72"><a href="#cb58-72" aria-hidden="true" tabindex="-1"></a>          loss <span class="op">=</span> loss_fn(y_hat, y)</span>
<span id="cb58-73"><a href="#cb58-73" aria-hidden="true" tabindex="-1"></a>          running_loss <span class="op">+=</span> loss.item()</span>
<span id="cb58-74"><a href="#cb58-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-75"><a href="#cb58-75" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> correct<span class="op">/</span>total, running_loss<span class="op">/</span>num_batches</span>
<span id="cb58-76"><a href="#cb58-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-77"><a href="#cb58-77" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> optimize(train_loader,val_loader,lr_params,max_epochs<span class="op">=</span><span class="dv">100</span>,batch_size<span class="op">=</span>BATCH_SIZE,loss_fn <span class="op">=</span> nn.CrossEntropyLoss(), use_scheduler <span class="op">=</span> <span class="va">False</span>, print_every <span class="op">=</span> <span class="dv">20</span>):</span>
<span id="cb58-78"><a href="#cb58-78" aria-hidden="true" tabindex="-1"></a>  <span class="co">"""</span></span>
<span id="cb58-79"><a href="#cb58-79" aria-hidden="true" tabindex="-1"></a><span class="co">  So far this only optimizes the learning rate, ideally it would optimize more</span></span>
<span id="cb58-80"><a href="#cb58-80" aria-hidden="true" tabindex="-1"></a><span class="co">  https://medium.com/dataseries/k-fold-cross-validation-with-pytorch-and-sklearn-d094aa00105f</span></span>
<span id="cb58-81"><a href="#cb58-81" aria-hidden="true" tabindex="-1"></a><span class="co">  a helpful example</span></span>
<span id="cb58-82"><a href="#cb58-82" aria-hidden="true" tabindex="-1"></a><span class="co">  """</span></span>
<span id="cb58-83"><a href="#cb58-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-84"><a href="#cb58-84" aria-hidden="true" tabindex="-1"></a>  begin <span class="op">=</span> time.time()</span>
<span id="cb58-85"><a href="#cb58-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-86"><a href="#cb58-86" aria-hidden="true" tabindex="-1"></a>  <span class="co">#train_data, val_data = random_split(train_dataset, [0.8*len(train_dataset), 0.2*len(train_dataset)])</span></span>
<span id="cb58-87"><a href="#cb58-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-88"><a href="#cb58-88" aria-hidden="true" tabindex="-1"></a>  <span class="co">#train_loader = DataLoader(train_data, batch_size=batch_size)</span></span>
<span id="cb58-89"><a href="#cb58-89" aria-hidden="true" tabindex="-1"></a>  <span class="co">#val_loader = DataLoader(val_data, batch_size=batch_size)</span></span>
<span id="cb58-90"><a href="#cb58-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-91"><a href="#cb58-91" aria-hidden="true" tabindex="-1"></a>  <span class="co">#stores the best loss, accuracy for each param value</span></span>
<span id="cb58-92"><a href="#cb58-92" aria-hidden="true" tabindex="-1"></a>  best_train_losses <span class="op">=</span> []</span>
<span id="cb58-93"><a href="#cb58-93" aria-hidden="true" tabindex="-1"></a>  best_train_accs <span class="op">=</span> []</span>
<span id="cb58-94"><a href="#cb58-94" aria-hidden="true" tabindex="-1"></a>  best_val_accs <span class="op">=</span> []</span>
<span id="cb58-95"><a href="#cb58-95" aria-hidden="true" tabindex="-1"></a>  best_val_losses <span class="op">=</span> []</span>
<span id="cb58-96"><a href="#cb58-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-97"><a href="#cb58-97" aria-hidden="true" tabindex="-1"></a>  train_loss_history <span class="op">=</span> []</span>
<span id="cb58-98"><a href="#cb58-98" aria-hidden="true" tabindex="-1"></a>  train_acc_history <span class="op">=</span> []</span>
<span id="cb58-99"><a href="#cb58-99" aria-hidden="true" tabindex="-1"></a>  val_acc_history <span class="op">=</span> []</span>
<span id="cb58-100"><a href="#cb58-100" aria-hidden="true" tabindex="-1"></a>  val_loss_history <span class="op">=</span> []</span>
<span id="cb58-101"><a href="#cb58-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-102"><a href="#cb58-102" aria-hidden="true" tabindex="-1"></a>  <span class="co">#model = EfficientNet.from_pretrained('efficientnet-b0',num_classes=3)</span></span>
<span id="cb58-103"><a href="#cb58-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-104"><a href="#cb58-104" aria-hidden="true" tabindex="-1"></a>  model_filename <span class="op">=</span> <span class="st">'/content/drive/Shareddrives/CheXpert-v1.0-small/resnet18_bwa_equal_frontal_10000_exp_lr.pth'</span></span>
<span id="cb58-105"><a href="#cb58-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-106"><a href="#cb58-106" aria-hidden="true" tabindex="-1"></a>  model <span class="op">=</span> models.resnet18(weights<span class="op">=</span><span class="st">'IMAGENET1K_V1'</span>)</span>
<span id="cb58-107"><a href="#cb58-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-108"><a href="#cb58-108" aria-hidden="true" tabindex="-1"></a>  num_ftrs <span class="op">=</span> model.fc.in_features</span>
<span id="cb58-109"><a href="#cb58-109" aria-hidden="true" tabindex="-1"></a>  out_ftrs <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb58-110"><a href="#cb58-110" aria-hidden="true" tabindex="-1"></a>  model.fc <span class="op">=</span> nn.Linear(num_ftrs, out_ftrs)</span>
<span id="cb58-111"><a href="#cb58-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-112"><a href="#cb58-112" aria-hidden="true" tabindex="-1"></a>  checkpoint <span class="op">=</span> torch.load(model_filename, map_location<span class="op">=</span>device)</span>
<span id="cb58-113"><a href="#cb58-113" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="st">'Loading trained model weights...'</span>)</span>
<span id="cb58-114"><a href="#cb58-114" aria-hidden="true" tabindex="-1"></a>  model.load_state_dict(checkpoint[<span class="st">'model_state_dict'</span>],strict<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb58-115"><a href="#cb58-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-116"><a href="#cb58-116" aria-hidden="true" tabindex="-1"></a>  model <span class="op">=</span> model.to(device)</span>
<span id="cb58-117"><a href="#cb58-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-118"><a href="#cb58-118" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> param <span class="kw">in</span> model.parameters():</span>
<span id="cb58-119"><a href="#cb58-119" aria-hidden="true" tabindex="-1"></a>      param.requires_grad <span class="op">=</span> <span class="va">False</span></span>
<span id="cb58-120"><a href="#cb58-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-121"><a href="#cb58-121" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> param <span class="kw">in</span> model.fc.parameters():</span>
<span id="cb58-122"><a href="#cb58-122" aria-hidden="true" tabindex="-1"></a>    param.requires_grad <span class="op">=</span> <span class="va">True</span></span>
<span id="cb58-123"><a href="#cb58-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-124"><a href="#cb58-124" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> lr_param <span class="kw">in</span> lr_params:</span>
<span id="cb58-125"><a href="#cb58-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-126"><a href="#cb58-126" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Param value: "</span>,lr_param)</span>
<span id="cb58-127"><a href="#cb58-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-128"><a href="#cb58-128" aria-hidden="true" tabindex="-1"></a>    <span class="co">#holds best losses in each fold for particular param value</span></span>
<span id="cb58-129"><a href="#cb58-129" aria-hidden="true" tabindex="-1"></a>    <span class="co">#train_losses = []</span></span>
<span id="cb58-130"><a href="#cb58-130" aria-hidden="true" tabindex="-1"></a>    <span class="co">#valid_accs = []</span></span>
<span id="cb58-131"><a href="#cb58-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-132"><a href="#cb58-132" aria-hidden="true" tabindex="-1"></a>    train_loss_history_param <span class="op">=</span> []</span>
<span id="cb58-133"><a href="#cb58-133" aria-hidden="true" tabindex="-1"></a>    train_acc_history_param <span class="op">=</span> []</span>
<span id="cb58-134"><a href="#cb58-134" aria-hidden="true" tabindex="-1"></a>    val_acc_history_param <span class="op">=</span> []</span>
<span id="cb58-135"><a href="#cb58-135" aria-hidden="true" tabindex="-1"></a>    val_loss_history_param <span class="op">=</span> []</span>
<span id="cb58-136"><a href="#cb58-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-137"><a href="#cb58-137" aria-hidden="true" tabindex="-1"></a>    best_train_loss <span class="op">=</span> <span class="fl">10000.0</span></span>
<span id="cb58-138"><a href="#cb58-138" aria-hidden="true" tabindex="-1"></a>    best_train_acc <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb58-139"><a href="#cb58-139" aria-hidden="true" tabindex="-1"></a>    best_val_loss <span class="op">=</span> <span class="fl">10000.0</span></span>
<span id="cb58-140"><a href="#cb58-140" aria-hidden="true" tabindex="-1"></a>    best_val_acc <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb58-141"><a href="#cb58-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-142"><a href="#cb58-142" aria-hidden="true" tabindex="-1"></a>    best_train_loss_epoch <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb58-143"><a href="#cb58-143" aria-hidden="true" tabindex="-1"></a>    best_train_acc_epoch <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb58-144"><a href="#cb58-144" aria-hidden="true" tabindex="-1"></a>    best_val_acc_epoch <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb58-145"><a href="#cb58-145" aria-hidden="true" tabindex="-1"></a>    best_val_loss_epoch <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb58-146"><a href="#cb58-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-147"><a href="#cb58-147" aria-hidden="true" tabindex="-1"></a>    <span class="co">#NOT THE BEST WAY TO DO THIS</span></span>
<span id="cb58-148"><a href="#cb58-148" aria-hidden="true" tabindex="-1"></a>    <span class="co">#define the model each loop so it resets</span></span>
<span id="cb58-149"><a href="#cb58-149" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-150"><a href="#cb58-150" aria-hidden="true" tabindex="-1"></a>    <span class="co">#model = EfficientNet.from_pretrained('efficientnet-b0',num_classes=3)</span></span>
<span id="cb58-151"><a href="#cb58-151" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-152"><a href="#cb58-152" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb58-153"><a href="#cb58-153" aria-hidden="true" tabindex="-1"></a><span class="co">    for param in model.parameters():</span></span>
<span id="cb58-154"><a href="#cb58-154" aria-hidden="true" tabindex="-1"></a><span class="co">      param.requires_grad = False</span></span>
<span id="cb58-155"><a href="#cb58-155" aria-hidden="true" tabindex="-1"></a><span class="co">    num_ftrs = model._fc.in_features</span></span>
<span id="cb58-156"><a href="#cb58-156" aria-hidden="true" tabindex="-1"></a><span class="co">    model._fc = nn.Linear(num_ftrs, 3)</span></span>
<span id="cb58-157"><a href="#cb58-157" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb58-158"><a href="#cb58-158" aria-hidden="true" tabindex="-1"></a>    <span class="co">#model = models.resnet18(weights='IMAGENET1K_V1')</span></span>
<span id="cb58-159"><a href="#cb58-159" aria-hidden="true" tabindex="-1"></a>    <span class="co">#for param in model.parameters():</span></span>
<span id="cb58-160"><a href="#cb58-160" aria-hidden="true" tabindex="-1"></a>    <span class="co">#  param.requires_grad = False</span></span>
<span id="cb58-161"><a href="#cb58-161" aria-hidden="true" tabindex="-1"></a>    <span class="co">#num_ftrs = model.fc.in_features</span></span>
<span id="cb58-162"><a href="#cb58-162" aria-hidden="true" tabindex="-1"></a>    <span class="co">#out_ftrs = 3</span></span>
<span id="cb58-163"><a href="#cb58-163" aria-hidden="true" tabindex="-1"></a>    <span class="co">#model.fc = nn.Linear(num_ftrs, out_ftrs)</span></span>
<span id="cb58-164"><a href="#cb58-164" aria-hidden="true" tabindex="-1"></a>    <span class="co">#model = model.to(device)</span></span>
<span id="cb58-165"><a href="#cb58-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-166"><a href="#cb58-166" aria-hidden="true" tabindex="-1"></a>    <span class="co">#I decided just to train the last linear layer since overfitting</span></span>
<span id="cb58-167"><a href="#cb58-167" aria-hidden="true" tabindex="-1"></a>    <span class="co">#optimizer = optim.Adam(model._fc.parameters(), lr=lr_param) #train last linear layer of efficientb4 which is called _fc, NOT fc</span></span>
<span id="cb58-168"><a href="#cb58-168" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> optim.Adam(model.parameters(), lr<span class="op">=</span>lr_param)</span>
<span id="cb58-169"><a href="#cb58-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-170"><a href="#cb58-170" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use_scheduler:</span>
<span id="cb58-171"><a href="#cb58-171" aria-hidden="true" tabindex="-1"></a>      scheduler <span class="op">=</span> lr_scheduler.ExponentialLR(optimizer, gamma<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb58-172"><a href="#cb58-172" aria-hidden="true" tabindex="-1"></a>      <span class="co">#scheduler = lr_scheduler.ReduceLROnPlateau(optimizer, mode='min', factor=0.1, patience=2, min_lr=0.000005, verbose=True)</span></span>
<span id="cb58-173"><a href="#cb58-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-174"><a href="#cb58-174" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(max_epochs):</span>
<span id="cb58-175"><a href="#cb58-175" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-176"><a href="#cb58-176" aria-hidden="true" tabindex="-1"></a>      train_loss <span class="op">=</span> train_epoch(model, train_loader, optimizer, loss_fn)</span>
<span id="cb58-177"><a href="#cb58-177" aria-hidden="true" tabindex="-1"></a>      train_acc, train_junk <span class="op">=</span> test_epoch(model,train_loader,loss_fn)</span>
<span id="cb58-178"><a href="#cb58-178" aria-hidden="true" tabindex="-1"></a>      val_acc, val_loss <span class="op">=</span> test_epoch(model, val_loader, loss_fn)</span>
<span id="cb58-179"><a href="#cb58-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-180"><a href="#cb58-180" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> use_scheduler:</span>
<span id="cb58-181"><a href="#cb58-181" aria-hidden="true" tabindex="-1"></a>        <span class="co">#scheduler.step(val_loss)</span></span>
<span id="cb58-182"><a href="#cb58-182" aria-hidden="true" tabindex="-1"></a>        scheduler.step()</span>
<span id="cb58-183"><a href="#cb58-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-184"><a href="#cb58-184" aria-hidden="true" tabindex="-1"></a>      train_loss_history_param.append(train_loss)</span>
<span id="cb58-185"><a href="#cb58-185" aria-hidden="true" tabindex="-1"></a>      train_acc_history_param.append(train_acc)</span>
<span id="cb58-186"><a href="#cb58-186" aria-hidden="true" tabindex="-1"></a>      val_acc_history_param.append(val_acc)</span>
<span id="cb58-187"><a href="#cb58-187" aria-hidden="true" tabindex="-1"></a>      val_loss_history_param.append(val_loss)</span>
<span id="cb58-188"><a href="#cb58-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-189"><a href="#cb58-189" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> train_loss <span class="op">&lt;</span> best_train_loss:</span>
<span id="cb58-190"><a href="#cb58-190" aria-hidden="true" tabindex="-1"></a>        best_train_loss <span class="op">=</span> train_loss</span>
<span id="cb58-191"><a href="#cb58-191" aria-hidden="true" tabindex="-1"></a>        best_train_acc_epoch <span class="op">=</span> epoch</span>
<span id="cb58-192"><a href="#cb58-192" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> train_acc <span class="op">&gt;</span> best_train_acc:</span>
<span id="cb58-193"><a href="#cb58-193" aria-hidden="true" tabindex="-1"></a>        best_train_acc <span class="op">=</span> train_acc</span>
<span id="cb58-194"><a href="#cb58-194" aria-hidden="true" tabindex="-1"></a>        best_train_acc_epoch <span class="op">=</span> epoch</span>
<span id="cb58-195"><a href="#cb58-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-196"><a href="#cb58-196" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> val_loss <span class="op">&lt;</span> best_val_loss:</span>
<span id="cb58-197"><a href="#cb58-197" aria-hidden="true" tabindex="-1"></a>        best_val_loss <span class="op">=</span> val_loss</span>
<span id="cb58-198"><a href="#cb58-198" aria-hidden="true" tabindex="-1"></a>        best_train_acc_epoch <span class="op">=</span> epoch</span>
<span id="cb58-199"><a href="#cb58-199" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> val_acc <span class="op">&gt;</span> best_val_acc:</span>
<span id="cb58-200"><a href="#cb58-200" aria-hidden="true" tabindex="-1"></a>        best_val_acc <span class="op">=</span> val_acc</span>
<span id="cb58-201"><a href="#cb58-201" aria-hidden="true" tabindex="-1"></a>        best_val_acc_epoch <span class="op">=</span> epoch</span>
<span id="cb58-202"><a href="#cb58-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-203"><a href="#cb58-203" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (epoch <span class="op">%</span> print_every <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb58-204"><a href="#cb58-204" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Epoch: "</span>,epoch)</span>
<span id="cb58-205"><a href="#cb58-205" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Best train loss: "</span>,best_train_loss)</span>
<span id="cb58-206"><a href="#cb58-206" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Best train accuracy: "</span>,best_train_acc)</span>
<span id="cb58-207"><a href="#cb58-207" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Best validation accuracy: "</span>,best_val_acc)</span>
<span id="cb58-208"><a href="#cb58-208" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Validation loss: "</span>,val_loss)</span>
<span id="cb58-209"><a href="#cb58-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-210"><a href="#cb58-210" aria-hidden="true" tabindex="-1"></a>    best_train_losses.append((best_train_loss_epoch,best_train_loss))</span>
<span id="cb58-211"><a href="#cb58-211" aria-hidden="true" tabindex="-1"></a>    best_train_accs.append((best_train_acc_epoch,best_train_acc))</span>
<span id="cb58-212"><a href="#cb58-212" aria-hidden="true" tabindex="-1"></a>    best_val_accs.append((best_val_acc_epoch,best_val_acc))</span>
<span id="cb58-213"><a href="#cb58-213" aria-hidden="true" tabindex="-1"></a>    best_val_losses.append((best_val_acc_epoch,best_val_acc))</span>
<span id="cb58-214"><a href="#cb58-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-215"><a href="#cb58-215" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Best validation epoch: "</span>,best_val_acc_epoch)</span>
<span id="cb58-216"><a href="#cb58-216" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Best training loss: "</span>,(best_train_loss_epoch,best_train_loss))</span>
<span id="cb58-217"><a href="#cb58-217" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Best training accuracy: "</span>,(best_train_acc_epoch,best_train_acc))</span>
<span id="cb58-218"><a href="#cb58-218" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Best validation accuracy: "</span>,(best_val_acc_epoch,best_val_acc))</span>
<span id="cb58-219"><a href="#cb58-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-220"><a href="#cb58-220" aria-hidden="true" tabindex="-1"></a>    train_loss_history.append(train_loss_history_param)</span>
<span id="cb58-221"><a href="#cb58-221" aria-hidden="true" tabindex="-1"></a>    train_acc_history.append(train_acc_history_param)</span>
<span id="cb58-222"><a href="#cb58-222" aria-hidden="true" tabindex="-1"></a>    val_acc_history.append(val_acc_history_param)</span>
<span id="cb58-223"><a href="#cb58-223" aria-hidden="true" tabindex="-1"></a>    val_loss_history.append(val_loss_history_param)</span>
<span id="cb58-224"><a href="#cb58-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-225"><a href="#cb58-225" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb58-226"><a href="#cb58-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-227"><a href="#cb58-227" aria-hidden="true" tabindex="-1"></a>  <span class="co">#outside parameterization loop</span></span>
<span id="cb58-228"><a href="#cb58-228" aria-hidden="true" tabindex="-1"></a>  <span class="co">#best losses amongst fold</span></span>
<span id="cb58-229"><a href="#cb58-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-230"><a href="#cb58-230" aria-hidden="true" tabindex="-1"></a>  end <span class="op">=</span> time.time()</span>
<span id="cb58-231"><a href="#cb58-231" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="ss">f'Finished optimizing in </span><span class="sc">{</span><span class="bu">round</span>(end <span class="op">-</span> begin)<span class="sc">}</span><span class="ss">s'</span>)</span>
<span id="cb58-232"><a href="#cb58-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-233"><a href="#cb58-233" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="st">"Best param: "</span>, lr_params)</span>
<span id="cb58-234"><a href="#cb58-234" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="st">"Best train loss: "</span>,best_train_losses)</span>
<span id="cb58-235"><a href="#cb58-235" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="st">"Best train accuracy: "</span>,best_train_accs)</span>
<span id="cb58-236"><a href="#cb58-236" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="st">"Best valid accuracy: "</span>,best_val_accs)</span>
<span id="cb58-237"><a href="#cb58-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-238"><a href="#cb58-238" aria-hidden="true" tabindex="-1"></a>  <span class="co">#NEED TO ADD val_loss_history</span></span>
<span id="cb58-239"><a href="#cb58-239" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> model, train_loss_history, train_acc_history, val_loss_history, val_acc_history</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="85">
<pre><code>'  \ndef optimize(train_dataset,lr_params,max_epochs=100,batch_size=BATCH_SIZE):\n  \n  #So far this only optimizes the learning rate, ideally it would optimize more\n  #https://medium.com/dataseries/k-fold-cross-validation-with-pytorch-and-sklearn-d094aa00105f\n  #a helpful example\n  \n\n  begin = time.time()\n\n  loss_fn = nn.CrossEntropyLoss()\n\n  k_folds = 5\n\n  splits=KFold(n_splits=k_folds,shuffle=True,random_state=42)\n\n  #best_param = lr_params[0]\n  #best_train_loss = 10.0\n  #best_valid_loss = 10.0\n  \n  best_train_losses = []\n  best_valid_losses = []\n\n  for lr_param in lr_params:\n\n    print("Param value: ",lr_param)\n\n    #holds best losses in each fold for particular param value\n    train_losses = []\n    valid_losses = []\n\n    for fold, (train_idx,val_idx) in enumerate(splits.split(np.arange(len(train_dataset)))):\n\n      print("Fold: ",fold)\n\n      train_sampler_epoch = SubsetRandomSampler(train_idx)\n      val_sampler_epoch = SubsetRandomSampler(val_idx)\n      train_loader_epoch = DataLoader(train_dataset, batch_size=batch_size, sampler=train_sampler_epoch)\n      val_loader_epoch = DataLoader(train_dataset, batch_size=batch_size, sampler=val_sampler_epoch)\n      \n      #pretrained resnet 18 model with weights from IMAGENET\n      model = models.resnet18(weights=\'IMAGENET1K_V1\')\n      num_ftrs = model.fc.in_features\n      out_ftrs = 4\n      model.fc = nn.Linear(num_ftrs, out_ftrs)\n      model = model.to(device)\n\n      optimizer = optim.Adam(model.fc.parameters(), lr=lr_param)\n\n      best_epoch_train_loss = 100.0\n      best_epoch_val_loss = 0.0\n\n      for epoch in range(max_epochs):\n      \n        train_loss = train_epoch(model, train_loader_epoch, optimizer, loss_fn)\n        val_loss = test_epoch(model, val_loader_epoch)\n\n        #print(lr_param,"Epoch: ",epoch," train loss: ",train_loss," test loss: ",val_loss)\n\n        if train_loss &lt; best_epoch_train_loss:\n          best_epoch_train_loss = train_loss\n\n        #bit of a mislabel here, in this case, the val loss is actually an accuracy score, not a loss\n        if val_loss &gt; best_epoch_val_loss:\n          best_epoch_val_loss = val_loss\n\n      train_losses.append(best_epoch_train_loss)\n      valid_losses.append(best_epoch_val_loss)\n\n      print("Best train loss: ",best_epoch_train_loss," best test loss: ",best_epoch_val_loss)\n\n    #best losses amongst fold\n    best_train_losses.append(sum(train_losses)/len(train_losses))\n    best_valid_losses.append(sum(valid_losses)/len(valid_losses))\n\n  print("Best param: ", lr_params)\n  print("Best train loss: ",best_train_losses)\n  print("Best test loss: ",best_valid_losses)\n\n  end = time.time()\n  print(f\'Finished optimizing in {round(end - begin)}s\')\n'</code></pre>
</div>
</div>
<p>We’ve decided to train all the parameters of the model as our assumption is that the ImageNet database will not have X-ray data. This of course does make us more vulnerable to overfitting.</p>
<p>We noticed in the original paper, they used a minimum learning rate of 1e-5 and initial of 0.0001. Adopting this, for the exponential learning rate we tested two gamma decays, 0.735 (which decays to 1e-5 after 10 epochs) and 0.8, which decays slightly slower.</p>
<p>The original paper also used a learning rate scheduler, and we have attempted to reproduce this with the same parameters.</p>
<div class="cell" data-outputid="469832b0-579f-46fa-a23e-dae9dad2bef8">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>data_size <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="co">#train_dataset = ChestXrayDataset("/content/drive/Shareddrives/", df_train_bwa_equal_frontal[:data_size], IMAGE_SIZE, True)</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="co">#val_dataset = ChestXrayDataset("/content/drive/Shareddrives/", df_train_bwa_equal_frontal[data_size:int(1.2*data_size)], IMAGE_SIZE, True)</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>train_dataset <span class="op">=</span> ChestXrayDataset(<span class="st">"/content/drive/Shareddrives/"</span>, df_train_bwa_equal_frontal[:data_size], IMAGE_SIZE, <span class="va">True</span>)</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>val_dataset <span class="op">=</span> ChestXrayDataset(<span class="st">"/content/drive/Shareddrives/"</span>, df_train_bwa_equal_frontal[<span class="op">-</span><span class="dv">2500</span>:], IMAGE_SIZE, <span class="va">True</span>)</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>train_loader <span class="op">=</span> DataLoader(dataset<span class="op">=</span>train_dataset, batch_size<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">True</span>, num_workers<span class="op">=</span><span class="dv">2</span>, pin_memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>val_loader <span class="op">=</span> DataLoader(dataset<span class="op">=</span>val_dataset, batch_size<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">False</span>, num_workers<span class="op">=</span><span class="dv">2</span>, pin_memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a><span class="co">#train_data, val_data = random_split(train_dataset, [0.8*len(train_dataset), 0.2*len(train_dataset)])</span></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>loss_fn <span class="op">=</span> nn.CrossEntropyLoss()</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a><span class="co">#lr_params = [0.0001,0.0005,0.001,0.005,0.01]</span></span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a><span class="co"># lr_params = [0.0001,0.001,0.005,0.01]</span></span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a><span class="co">#lr_params = [0.00001,0.0001,0.001,0.01]</span></span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>lr_params <span class="op">=</span> [<span class="fl">0.001</span>]</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>model, train_loss_history, train_acc_history, val_loss_history, val_acc_history <span class="op">=</span> optimize(train_loader,</span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>                                                                  val_loader,</span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>                                                                  lr_params,</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>                                                                  max_epochs<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>                                                                  batch_size <span class="op">=</span> BATCH_SIZE, </span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>                                                                  loss_fn <span class="op">=</span> loss_fn,</span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>                                                                  use_scheduler <span class="op">=</span> <span class="va">True</span>, </span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>                                                                  print_every <span class="op">=</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loading trained model weights...
Param value:  0.001
Batch  19 / 200  done! Training loss:  0.1528143562376499
Batch  39 / 200  done! Training loss:  0.1664441805332899
Batch  59 / 200  done! Training loss:  0.15741296280175449
Batch  79 / 200  done! Training loss:  0.17828873358666897
Batch  99 / 200  done! Training loss:  0.16379947625100613
Batch  119 / 200  done! Training loss:  0.19253771081566812
Batch  139 / 200  done! Training loss:  0.15879652025178076
Batch  159 / 200  done! Training loss:  0.1724318966269493
Batch  179 / 200  done! Training loss:  0.15257574059069157
Batch  199 / 200  done! Training loss:  0.20827685352414846
Epoch:  0
Best train loss:  0.17033784312196076
Best train accuracy:  0.949
Best validation accuracy:  0.8412
Validation loss:  0.5364894476532936
Batch  19 / 200  done! Training loss:  0.18965775817632674
Batch  39 / 200  done! Training loss:  0.15279387179762124
Batch  59 / 200  done! Training loss:  0.16380660533905028
Batch  79 / 200  done! Training loss:  0.21136089861392976
Batch  99 / 200  done! Training loss:  0.17766814157366753
Batch  119 / 200  done! Training loss:  0.15910167824476956
Batch  139 / 200  done! Training loss:  0.1518234523013234
Batch  159 / 200  done! Training loss:  0.1434622874483466
Batch  179 / 200  done! Training loss:  0.16085950154811143
Batch  199 / 200  done! Training loss:  0.19031524006277323
Epoch:  1
Best train loss:  0.17008494351059197
Best train accuracy:  0.9509
Best validation accuracy:  0.8412
Validation loss:  0.5593803146481514
Batch  19 / 200  done! Training loss:  0.1839012246578932
Batch  39 / 200  done! Training loss:  0.16211103592067957
Batch  59 / 200  done! Training loss:  0.1672391626983881
Batch  79 / 200  done! Training loss:  0.18950870279222726
Batch  99 / 200  done! Training loss:  0.16299439799040555
Batch  119 / 200  done! Training loss:  0.1461887000128627
Batch  139 / 200  done! Training loss:  0.12911026645451784
Batch  159 / 200  done! Training loss:  0.18273232951760293
Batch  179 / 200  done! Training loss:  0.16561143463477493
Batch  199 / 200  done! Training loss:  0.16294158138334752
Epoch:  2
Best train loss:  0.16523388360626995
Best train accuracy:  0.9532
Best validation accuracy:  0.8412
Validation loss:  0.5573970505595207
Batch  19 / 200  done! Training loss:  0.16955045610666275
Batch  39 / 200  done! Training loss:  0.15128388479351998
Batch  59 / 200  done! Training loss:  0.13808564990758895
Batch  79 / 200  done! Training loss:  0.12648260816931725
Batch  99 / 200  done! Training loss:  0.17324613071978093
Batch  119 / 200  done! Training loss:  0.16252141688019037
Batch  139 / 200  done! Training loss:  0.17211350481957197
Batch  159 / 200  done! Training loss:  0.1516774943098426
Batch  179 / 200  done! Training loss:  0.18313992954790592
Batch  199 / 200  done! Training loss:  0.14182114470750093
Epoch:  3
Best train loss:  0.15699222199618817
Best train accuracy:  0.9532
Best validation accuracy:  0.8412
Validation loss:  0.5490620124340058
Batch  19 / 200  done! Training loss:  0.17072872966527938
Batch  39 / 200  done! Training loss:  0.16742814797908068
Batch  59 / 200  done! Training loss:  0.17456801533699035
Batch  79 / 200  done! Training loss:  0.14226952027529477
Batch  99 / 200  done! Training loss:  0.15801444388926028
Batch  119 / 200  done! Training loss:  0.14497486166656018
Batch  139 / 200  done! Training loss:  0.1597029823809862
Batch  159 / 200  done! Training loss:  0.17004797980189323
Batch  179 / 200  done! Training loss:  0.21532449908554555
Batch  199 / 200  done! Training loss:  0.18260762058198451
Epoch:  4
Best train loss:  0.15699222199618817
Best train accuracy:  0.9545
Best validation accuracy:  0.8412
Validation loss:  0.5363550755381584
Batch  19 / 200  done! Training loss:  0.16470940373837947
Batch  39 / 200  done! Training loss:  0.1529711689800024
Batch  59 / 200  done! Training loss:  0.16924651712179184
Batch  79 / 200  done! Training loss:  0.15943353194743395
Batch  99 / 200  done! Training loss:  0.1458769364282489
Batch  119 / 200  done! Training loss:  0.18045847825706005
Batch  139 / 200  done! Training loss:  0.1350273720920086
Batch  159 / 200  done! Training loss:  0.14468384645879268
Batch  179 / 200  done! Training loss:  0.16156351212412118
Batch  199 / 200  done! Training loss:  0.136487946100533
Epoch:  5
Best train loss:  0.15504587132483721
Best train accuracy:  0.9545
Best validation accuracy:  0.8448
Validation loss:  0.5380366158485412
Batch  19 / 200  done! Training loss:  0.17918823258951305
Batch  39 / 200  done! Training loss:  0.1593499282374978
Batch  59 / 200  done! Training loss:  0.1601030632853508
Batch  79 / 200  done! Training loss:  0.17086085062474013
Batch  99 / 200  done! Training loss:  0.17393264826387167
Batch  119 / 200  done! Training loss:  0.18510820902884007
Batch  139 / 200  done! Training loss:  0.1567397139966488
Batch  159 / 200  done! Training loss:  0.13284184355288745
Batch  179 / 200  done! Training loss:  0.1463731849566102
Batch  199 / 200  done! Training loss:  0.17187118530273438
Epoch:  6
Best train loss:  0.15504587132483721
Best train accuracy:  0.9562
Best validation accuracy:  0.8448
Validation loss:  0.5468182641267777
Batch  19 / 200  done! Training loss:  0.16395481657236816
Batch  39 / 200  done! Training loss:  0.15406818520277737
Batch  59 / 200  done! Training loss:  0.15586457569152118
Batch  79 / 200  done! Training loss:  0.1422238141298294
Batch  99 / 200  done! Training loss:  0.1668498931452632
Batch  119 / 200  done! Training loss:  0.14960379023104906
Batch  139 / 200  done! Training loss:  0.1401976615190506
Batch  159 / 200  done! Training loss:  0.1650935934856534
Batch  179 / 200  done! Training loss:  0.1610572265461087
Batch  199 / 200  done! Training loss:  0.16840551532804965
Epoch:  7
Best train loss:  0.15504587132483721
Best train accuracy:  0.9562
Best validation accuracy:  0.8504
Validation loss:  0.5140332788228988
Best validation epoch:  7
Best training loss:  (0, 0.15504587132483721)
Best training accuracy:  (7, 0.9562)
Best validation accuracy:  (7, 0.8504)


Finished optimizing in 4338s
Best param:  [0.001]
Best train loss:  [(0, 0.15504587132483721)]
Best train accuracy:  [(7, 0.9562)]
Best valid accuracy:  [(7, 0.8504)]</code></pre>
</div>
</div>
<div class="cell" data-outputid="e2acea7a-c4d5-4484-801e-c720ce32d45d">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="co">#loss_file = '/content/drive/Shareddrives/CheXpert-v1.0-small/efficientb0_10000_losses.pt'</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>loss_file <span class="op">=</span> <span class="st">'/content/drive/Shareddrives/CheXpert-v1.0-small/resnet18_bwa_frontal_gamma09.pt'</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>loss_dict <span class="op">=</span> torch.load(loss_file,map_location<span class="op">=</span>torch.device(<span class="st">'cpu'</span>))</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>train_loss_history_file <span class="op">=</span> loss_dict[<span class="st">'train_loss_history'</span>]</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>val_loss_history_file <span class="op">=</span> loss_dict[<span class="st">'val_loss_history'</span>]</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>train_acc_history_file <span class="op">=</span> loss_dict[<span class="st">'train_acc_history'</span>]</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>val_acc_history_file <span class="op">=</span> loss_dict[<span class="st">'val_acc_history'</span>]</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>epoch_list <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">8</span>)]</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>plt.scatter(epoch_list,train_loss_history_file,c<span class="op">=</span><span class="st">'Red'</span>, label <span class="op">=</span> <span class="st">'Training loss'</span>)</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>plt.scatter(epoch_list,val_loss_history_file,c<span class="op">=</span><span class="st">'Green'</span>, label <span class="op">=</span> <span class="st">'Validation loss'</span>)</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Epoch'</span>)</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Loss'</span>)</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="vs">r'Loss: BWA Equal with Exponential Scheduler, $\gamma=0.9$'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>Text(0.5, 1.0, 'Loss: BWA Equal with Exponential Scheduler, $\\gamma=0.9$')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-41-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="3a9df8ae-fcd8-4cd9-c3b4-34c350ab2476">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="co">#loss_file = '/content/drive/Shareddrives/CheXpert-v1.0-small/efficientb0_10000_losses.pt'</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>loss_file <span class="op">=</span> <span class="st">'/content/drive/Shareddrives/CheXpert-v1.0-small/self_resnet18_bwa_frontal_exp_lr(4).pt'</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>loss_dict <span class="op">=</span> torch.load(loss_file,map_location<span class="op">=</span>torch.device(<span class="st">'cpu'</span>))</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>train_loss_history_file <span class="op">=</span> loss_dict[<span class="st">'train_loss_history'</span>]</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>val_loss_history_file <span class="op">=</span> loss_dict[<span class="st">'val_loss_history'</span>]</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>train_acc_history_file <span class="op">=</span> loss_dict[<span class="st">'train_acc_history'</span>]</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>val_acc_history_file <span class="op">=</span> loss_dict[<span class="st">'val_acc_history'</span>]</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>epoch_list <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(val_loss_history_file[<span class="dv">0</span>]))]</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>plt.scatter(epoch_list,train_loss_history_file,c<span class="op">=</span><span class="st">'Red'</span>, label <span class="op">=</span> <span class="st">'Training loss'</span>)</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>plt.scatter(epoch_list,val_loss_history_file,c<span class="op">=</span><span class="st">'Green'</span>, label <span class="op">=</span> <span class="st">'Validation loss'</span>)</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Epoch'</span>)</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Loss'</span>)</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="vs">r'Loss: ResNet18, Self-Implementation, Exponential Scheduler'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>Text(0.5, 1.0, 'Loss: ResNet18, Self-Implementation, Exponential Scheduler')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-42-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="9dd2aee9-53b4-4129-ea62-0d3bbe8833c7">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(epoch_list,train_acc_history_file,c<span class="op">=</span><span class="st">'Red'</span>, label <span class="op">=</span> <span class="st">'Training score'</span>)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>plt.scatter(epoch_list,val_acc_history_file,c<span class="op">=</span><span class="st">'Green'</span>, label <span class="op">=</span> <span class="st">'Validation score'</span>)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Score'</span>)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Loss'</span>)</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="vs">r'Score: ResNet18, Self-Implementation, Exponential Scheduler'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>Text(0.5, 1.0, 'Score: ResNet18, Self-Implementation, Exponential Scheduler')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-43-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="4b6fdc60-ca4d-47e6-a220-b25d0e5aa97e">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>model_filename <span class="op">=</span> <span class="st">"/content/drive/Shareddrives/CheXpert-v1.0-small/resnet18_bwa_frontal_gamma09.pth"</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>model_saved <span class="op">=</span> models.resnet18(weights<span class="op">=</span><span class="st">'IMAGENET1K_V1'</span>)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>num_ftrs <span class="op">=</span> model_saved.fc.in_features</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>model_saved.fc <span class="op">=</span> nn.Linear(num_ftrs, <span class="dv">3</span>) </span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>checkpoint <span class="op">=</span> torch.load(model_filename, map_location<span class="op">=</span>device)</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Loading trained model weights...'</span>)</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>model_saved.load_state_dict(checkpoint[<span class="st">'model_state_dict'</span>],strict<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>model_saved <span class="op">=</span> model_saved.to(device)</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>test_dataset <span class="op">=</span> ChestXrayDataset(<span class="st">"/content/drive/Shareddrives/"</span>, df_test_bwa_equal_frontal[:<span class="dv">2000</span>], IMAGE_SIZE, <span class="va">True</span>)</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>test_dataloader <span class="op">=</span> DataLoader(dataset<span class="op">=</span>test_dataset, batch_size<span class="op">=</span><span class="dv">50</span>, shuffle<span class="op">=</span><span class="va">False</span>, num_workers<span class="op">=</span><span class="dv">2</span>, pin_memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>y_pred_enet, y_true_enet <span class="op">=</span> test(model_saved,test_dataloader)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: "https://download.pytorch.org/models/resnet18-f37072fd.pth" to /root/.cache/torch/hub/checkpoints/resnet18-f37072fd.pth
100%|██████████| 44.7M/44.7M [00:00&lt;00:00, 93.6MB/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Loading trained model weights...
tensor([0, 1, 1, 1, 0, 1, 2, 1, 1, 0, 2, 2, 1, 0, 1, 2, 1, 1, 1, 0, 0, 2, 1, 0,
        2, 1, 1, 2, 0, 1, 0, 2, 0, 2, 0, 2, 0, 2, 2, 1, 0, 2, 0, 1, 2, 0, 0, 1,
        0, 1], device='cuda:0')
predicted:  tensor([0, 1, 1, 1, 0, 1, 2, 1, 0, 0, 1, 2, 1, 0, 1, 2, 1, 1, 1, 0, 0, 2, 1, 0,
        2, 0, 1, 0, 0, 1, 0, 2, 0, 2, 2, 2, 0, 2, 2, 1, 2, 2, 0, 2, 2, 0, 0, 1,
        1, 1], device='cuda:0')
tensor([0, 0, 0, 2, 0, 2, 1, 0, 0, 0, 1, 2, 2, 1, 2, 1, 2, 2, 2, 0, 0, 0, 1, 2,
        1, 2, 1, 2, 2, 1, 0, 0, 0, 0, 0, 2, 1, 0, 1, 2, 0, 2, 0, 1, 2, 2, 2, 0,
        0, 1], device='cuda:0')
predicted:  tensor([0, 0, 0, 2, 0, 2, 1, 0, 1, 2, 1, 2, 0, 0, 2, 1, 2, 0, 2, 0, 0, 1, 1, 2,
        1, 2, 0, 2, 2, 1, 0, 0, 2, 0, 0, 2, 0, 0, 1, 2, 0, 1, 0, 1, 0, 2, 2, 0,
        2, 1], device='cuda:0')
tensor([2, 2, 1, 1, 1, 1, 2, 1, 1, 0, 2, 1, 0, 1, 2, 1, 2, 1, 0, 2, 0, 1, 1, 0,
        0, 2, 2, 1, 2, 0, 2, 0, 0, 1, 0, 1, 1, 2, 2, 2, 1, 0, 1, 2, 0, 0, 0, 2,
        2, 1], device='cuda:0')
predicted:  tensor([2, 2, 0, 0, 1, 1, 2, 1, 1, 0, 2, 0, 0, 0, 0, 1, 1, 1, 0, 2, 0, 1, 1, 0,
        0, 0, 2, 0, 2, 0, 2, 1, 0, 1, 1, 1, 2, 2, 2, 1, 1, 0, 1, 2, 1, 0, 0, 2,
        2, 0], device='cuda:0')
tensor([1, 0, 1, 0, 2, 2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 0, 1, 2, 1, 0, 1, 1, 1,
        2, 2, 2, 0, 1, 2, 1, 1, 1, 0, 1, 1, 1, 0, 2, 2, 0, 0, 1, 0, 0, 0, 2, 2,
        0, 2], device='cuda:0')
predicted:  tensor([1, 0, 1, 0, 2, 2, 0, 2, 2, 1, 2, 2, 0, 2, 1, 0, 0, 0, 0, 1, 0, 1, 1, 1,
        2, 2, 2, 0, 1, 2, 1, 2, 1, 0, 1, 1, 1, 1, 2, 2, 0, 0, 1, 0, 0, 0, 2, 2,
        0, 0], device='cuda:0')
tensor([2, 0, 1, 1, 1, 2, 0, 2, 0, 1, 1, 0, 1, 1, 2, 0, 2, 1, 0, 1, 2, 0, 2, 2,
        2, 0, 0, 2, 1, 2, 1, 2, 0, 0, 2, 1, 2, 2, 2, 2, 1, 1, 0, 2, 0, 0, 1, 2,
        1, 2], device='cuda:0')
predicted:  tensor([2, 0, 1, 1, 0, 2, 0, 2, 1, 1, 2, 0, 1, 1, 2, 0, 2, 1, 0, 1, 1, 2, 1, 2,
        2, 0, 0, 2, 1, 2, 1, 2, 0, 0, 2, 2, 2, 2, 2, 2, 1, 1, 0, 2, 0, 0, 1, 2,
        1, 2], device='cuda:0')
tensor([2, 1, 0, 2, 2, 1, 0, 1, 2, 1, 0, 1, 2, 1, 1, 2, 0, 2, 0, 0, 0, 1, 0, 0,
        0, 2, 1, 0, 2, 0, 0, 1, 1, 2, 1, 0, 2, 0, 2, 0, 1, 1, 0, 1, 2, 2, 1, 0,
        1, 2], device='cuda:0')
predicted:  tensor([2, 1, 0, 2, 2, 1, 2, 1, 0, 1, 0, 2, 2, 1, 1, 2, 0, 2, 0, 0, 0, 1, 0, 0,
        1, 0, 1, 0, 2, 0, 0, 1, 1, 2, 0, 2, 2, 0, 2, 0, 1, 0, 1, 1, 2, 2, 1, 0,
        1, 1], device='cuda:0')
tensor([0, 1, 1, 0, 1, 0, 0, 0, 1, 1, 0, 2, 1, 0, 2, 2, 1, 1, 0, 0, 2, 1, 2, 0,
        1, 2, 2, 1, 2, 0, 1, 2, 0, 2, 1, 1, 1, 0, 2, 1, 2, 1, 2, 0, 2, 1, 1, 1,
        2, 0], device='cuda:0')
predicted:  tensor([0, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 0, 2, 1, 1, 1, 0, 1, 1, 0, 2,
        1, 2, 2, 0, 2, 0, 1, 2, 0, 2, 1, 1, 1, 2, 2, 1, 2, 1, 2, 1, 0, 0, 2, 0,
        2, 0], device='cuda:0')
tensor([0, 1, 2, 0, 1, 0, 2, 1, 2, 2, 2, 2, 1, 2, 0, 2, 2, 0, 0, 0, 0, 1, 1, 0,
        1, 0, 1, 2, 0, 1, 0, 2, 2, 1, 2, 2, 2, 2, 2, 0, 2, 1, 1, 1, 0, 0, 0, 2,
        0, 0], device='cuda:0')
predicted:  tensor([1, 1, 2, 1, 1, 2, 2, 1, 2, 2, 2, 2, 1, 2, 0, 2, 2, 0, 2, 0, 0, 1, 0, 0,
        1, 0, 0, 2, 0, 1, 0, 2, 1, 1, 0, 0, 2, 2, 2, 0, 2, 1, 1, 1, 0, 1, 0, 2,
        0, 0], device='cuda:0')
tensor([2, 2, 2, 2, 1, 1, 1, 2, 0, 0, 2, 1, 0, 1, 1, 0, 1, 2, 2, 2, 0, 2, 1, 2,
        0, 2, 0, 1, 0, 2, 2, 0, 0, 0, 2, 0, 2, 0, 1, 2, 0, 2, 2, 1, 0, 1, 0, 0,
        1, 1], device='cuda:0')
predicted:  tensor([2, 2, 2, 2, 0, 1, 1, 2, 0, 0, 2, 1, 0, 1, 1, 0, 1, 2, 1, 2, 0, 2, 0, 2,
        0, 0, 0, 1, 0, 2, 2, 1, 0, 0, 2, 2, 2, 2, 1, 2, 0, 2, 2, 1, 2, 0, 0, 0,
        0, 1], device='cuda:0')
tensor([0, 0, 2, 0, 1, 2, 1, 2, 2, 2, 2, 2, 0, 1, 1, 2, 2, 2, 2, 2, 0, 0, 0, 2,
        0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 1, 2, 0, 1, 0, 2, 2, 1, 1, 2, 0, 2, 0, 0,
        0, 0], device='cuda:0')
predicted:  tensor([1, 0, 2, 0, 0, 1, 1, 2, 2, 2, 2, 2, 0, 1, 1, 2, 0, 2, 2, 2, 2, 0, 0, 2,
        0, 1, 2, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 2, 2, 2, 1, 0, 0, 2, 2, 0,
        1, 0], device='cuda:0')
tensor([1, 1, 2, 0, 1, 2, 0, 2, 2, 1, 0, 1, 1, 2, 1, 1, 0, 0, 1, 2, 2, 0, 0, 2,
        0, 1, 1, 0, 2, 2, 0, 0, 1, 0, 1, 2, 2, 1, 1, 0, 0, 2, 0, 0, 0, 0, 0, 1,
        0, 1], device='cuda:0')
predicted:  tensor([1, 0, 2, 0, 1, 2, 0, 0, 2, 1, 0, 2, 1, 2, 2, 0, 2, 0, 0, 2, 0, 0, 0, 0,
        2, 1, 1, 0, 0, 2, 0, 0, 1, 0, 1, 2, 1, 0, 0, 0, 2, 1, 0, 0, 0, 0, 0, 1,
        0, 1], device='cuda:0')
tensor([0, 0, 0, 1, 2, 0, 1, 2, 2, 1, 1, 1, 0, 1, 1, 2, 1, 0, 1, 2, 1, 0, 0, 1,
        1, 0, 2, 0, 1, 2, 1, 2, 2, 0, 2, 0, 2, 0, 0, 0, 1, 2, 1, 0, 2, 0, 2, 0,
        0, 0], device='cuda:0')
predicted:  tensor([0, 0, 0, 0, 2, 0, 1, 0, 2, 1, 0, 1, 0, 1, 2, 2, 1, 0, 1, 2, 1, 0, 0, 0,
        1, 1, 2, 0, 1, 2, 1, 2, 2, 0, 2, 0, 1, 1, 0, 0, 1, 2, 1, 0, 2, 2, 2, 0,
        1, 0], device='cuda:0')
tensor([0, 0, 0, 1, 2, 0, 0, 2, 0, 1, 0, 1, 0, 2, 2, 2, 1, 2, 0, 2, 0, 2, 1, 1,
        2, 2, 1, 2, 0, 0, 1, 0, 1, 1, 0, 1, 0, 1, 2, 1, 0, 0, 2, 1, 0, 1, 0, 2,
        0, 1], device='cuda:0')
predicted:  tensor([0, 0, 0, 1, 2, 2, 0, 2, 0, 1, 0, 1, 0, 2, 0, 2, 0, 1, 2, 0, 0, 2, 1, 1,
        2, 2, 1, 2, 0, 0, 1, 1, 1, 1, 0, 1, 0, 0, 2, 0, 0, 0, 2, 1, 1, 1, 0, 0,
        0, 0], device='cuda:0')
tensor([0, 1, 0, 0, 1, 1, 2, 0, 1, 0, 2, 1, 1, 2, 1, 0, 0, 1, 2, 0, 0, 2, 2, 2,
        0, 1, 0, 1, 2, 2, 2, 1, 0, 1, 1, 2, 0, 2, 2, 0, 0, 0, 1, 1, 2, 2, 1, 1,
        1, 0], device='cuda:0')
predicted:  tensor([0, 1, 2, 0, 1, 1, 2, 0, 0, 1, 2, 1, 1, 0, 0, 2, 0, 1, 2, 0, 0, 2, 2, 0,
        2, 1, 0, 1, 2, 2, 2, 1, 2, 2, 1, 0, 0, 2, 2, 0, 0, 1, 1, 1, 2, 2, 1, 0,
        1, 2], device='cuda:0')
tensor([1, 1, 1, 2, 1, 0, 2, 2, 0, 1, 2, 0, 1, 1, 2, 0, 1, 2, 2, 0, 0, 1, 0, 0,
        1, 0, 0, 1, 0, 1, 0, 2, 1, 1, 0, 0, 2, 2, 0, 1, 1, 2, 2, 1, 1, 0, 0, 1,
        1, 1], device='cuda:0')
predicted:  tensor([1, 0, 1, 2, 1, 2, 0, 2, 0, 1, 0, 0, 1, 1, 0, 0, 1, 2, 2, 0, 1, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 2, 1, 1, 0, 0, 2, 2, 0, 1, 2, 2, 2, 2, 1, 0, 0, 0,
        1, 1], device='cuda:0')
tensor([1, 2, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 1, 0, 1, 2, 0, 1, 1, 0, 1, 0,
        2, 1, 0, 2, 2, 1, 1, 0, 1, 0, 0, 1, 0, 2, 1, 2, 2, 2, 1, 1, 0, 1, 2, 2,
        2, 0], device='cuda:0')
predicted:  tensor([1, 2, 0, 2, 0, 0, 0, 0, 1, 2, 0, 0, 0, 0, 1, 0, 1, 2, 0, 1, 1, 0, 1, 0,
        2, 0, 0, 2, 2, 1, 1, 0, 0, 0, 0, 1, 0, 2, 1, 2, 2, 0, 1, 1, 0, 1, 2, 2,
        0, 1], device='cuda:0')
tensor([1, 1, 0, 2, 0, 2, 2, 0, 2, 2, 0, 1, 0, 0, 2, 2, 1, 1, 2, 2, 0, 0, 0, 2,
        0, 2, 1, 1, 0, 2, 0, 0, 1, 1, 1, 2, 2, 2, 0, 1, 0, 0, 2, 0, 2, 0, 1, 0,
        0, 2], device='cuda:0')
predicted:  tensor([1, 1, 1, 2, 1, 0, 2, 0, 2, 2, 0, 1, 0, 0, 2, 2, 1, 0, 2, 2, 0, 0, 0, 2,
        1, 0, 1, 1, 0, 2, 1, 0, 1, 0, 1, 2, 2, 2, 0, 2, 0, 0, 2, 0, 2, 0, 0, 0,
        0, 1], device='cuda:0')
tensor([1, 0, 0, 0, 1, 1, 1, 1, 2, 1, 0, 2, 0, 2, 1, 2, 2, 2, 1, 1, 2, 2, 0, 2,
        1, 2, 1, 2, 1, 2, 1, 1, 2, 2, 1, 1, 0, 2, 1, 0, 0, 0, 1, 0, 1, 2, 1, 2,
        1, 2], device='cuda:0')
predicted:  tensor([1, 2, 0, 0, 1, 1, 1, 2, 0, 1, 0, 2, 0, 1, 1, 2, 2, 2, 2, 1, 0, 2, 0, 2,
        1, 2, 1, 0, 1, 2, 1, 1, 2, 2, 1, 0, 0, 1, 1, 0, 0, 2, 1, 0, 1, 2, 1, 2,
        1, 0], device='cuda:0')
tensor([2, 0, 2, 2, 1, 0, 2, 2, 1, 2, 2, 2, 0, 0, 0, 2, 0, 0, 0, 2, 1, 2, 2, 2,
        1, 0, 2, 1, 1, 0, 2, 0, 1, 1, 0, 0, 2, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 1,
        2, 1], device='cuda:0')
predicted:  tensor([2, 0, 2, 2, 1, 1, 2, 2, 1, 2, 2, 1, 0, 0, 0, 2, 0, 2, 0, 2, 0, 2, 2, 2,
        1, 2, 2, 1, 1, 0, 0, 2, 1, 1, 0, 0, 2, 0, 0, 0, 2, 0, 1, 0, 0, 0, 2, 1,
        2, 1], device='cuda:0')
tensor([1, 1, 1, 1, 0, 1, 1, 1, 2, 0, 2, 0, 0, 2, 2, 2, 2, 1, 1, 2, 1, 1, 2, 2,
        0, 0, 2, 2, 1, 1, 1, 2, 0, 1, 1, 0, 1, 0, 1, 1, 0, 0, 0, 2, 0, 2, 0, 1,
        2, 1], device='cuda:0')
predicted:  tensor([1, 1, 1, 1, 0, 1, 1, 0, 0, 0, 2, 1, 0, 2, 2, 0, 2, 1, 1, 0, 1, 1, 2, 2,
        0, 1, 0, 2, 1, 1, 1, 0, 0, 0, 1, 0, 1, 1, 1, 1, 0, 0, 2, 2, 0, 0, 0, 1,
        2, 1], device='cuda:0')
tensor([2, 0, 0, 0, 2, 0, 1, 0, 2, 0, 1, 2, 1, 2, 2, 2, 1, 2, 1, 0, 2, 1, 2, 0,
        0, 0, 0, 2, 1, 0, 2, 1, 2, 1, 2, 1, 2, 2, 2, 1, 0, 1, 2, 0, 1, 0, 1, 1,
        0, 2], device='cuda:0')
predicted:  tensor([0, 0, 0, 0, 2, 1, 1, 0, 2, 0, 1, 2, 1, 2, 2, 2, 1, 2, 2, 1, 1, 0, 1, 2,
        0, 2, 0, 2, 1, 0, 0, 1, 0, 1, 0, 1, 2, 2, 2, 1, 1, 0, 2, 0, 1, 0, 1, 1,
        0, 2], device='cuda:0')
tensor([0, 1, 0, 2, 1, 1, 2, 1, 2, 0, 2, 2, 0, 0, 0, 0, 2, 0, 2, 1, 0, 1, 1, 2,
        0, 0, 0, 0, 1, 0, 1, 1, 1, 2, 2, 1, 0, 0, 2, 1, 2, 1, 0, 1, 1, 0, 0, 2,
        2, 0], device='cuda:0')
predicted:  tensor([1, 1, 0, 2, 1, 1, 2, 1, 1, 0, 2, 2, 0, 0, 0, 0, 0, 0, 2, 1, 0, 1, 1, 2,
        2, 0, 1, 1, 1, 0, 1, 1, 0, 2, 0, 0, 0, 0, 2, 1, 2, 1, 0, 1, 1, 0, 2, 2,
        2, 1], device='cuda:0')
tensor([2, 2, 2, 0, 0, 0, 0, 2, 1, 1, 2, 2, 0, 1, 1, 2, 2, 0, 1, 1, 0, 1, 1, 0,
        2, 0, 2, 1, 2, 2, 1, 1, 1, 0, 1, 1, 0, 2, 1, 1, 2, 1, 2, 0, 1, 2, 2, 0,
        1, 0], device='cuda:0')
predicted:  tensor([2, 2, 2, 1, 0, 0, 0, 1, 1, 1, 2, 1, 0, 1, 1, 2, 2, 0, 1, 1, 1, 1, 1, 2,
        2, 1, 2, 1, 2, 0, 1, 1, 1, 0, 1, 1, 0, 2, 1, 1, 2, 1, 1, 1, 1, 1, 2, 0,
        1, 0], device='cuda:0')
tensor([0, 0, 2, 1, 1, 0, 1, 0, 2, 2, 2, 0, 2, 2, 2, 1, 2, 0, 2, 1, 0, 1, 1, 1,
        0, 2, 1, 1, 2, 2, 0, 1, 2, 2, 1, 1, 2, 2, 0, 0, 2, 0, 2, 0, 0, 0, 0, 0,
        1, 0], device='cuda:0')
predicted:  tensor([0, 0, 2, 1, 1, 0, 0, 0, 0, 2, 2, 0, 2, 2, 2, 1, 2, 2, 2, 0, 1, 1, 1, 1,
        2, 1, 0, 1, 2, 2, 0, 0, 1, 0, 1, 1, 2, 2, 0, 2, 2, 1, 2, 1, 0, 0, 1, 0,
        1, 1], device='cuda:0')
tensor([2, 2, 1, 1, 0, 1, 2, 1, 2, 0, 2, 1, 2, 1, 1, 0, 0, 2, 1, 2, 0, 1, 1, 0,
        1, 1, 2, 1, 2, 0, 0, 0, 2, 1, 0, 0, 2, 2, 1, 2, 0, 1, 1, 1, 1, 2, 0, 2,
        2, 1], device='cuda:0')
predicted:  tensor([0, 2, 1, 1, 2, 0, 2, 2, 2, 0, 0, 1, 2, 0, 1, 0, 1, 2, 1, 2, 0, 1, 1, 0,
        0, 0, 2, 1, 2, 0, 0, 0, 2, 0, 0, 0, 2, 2, 1, 2, 2, 1, 1, 1, 1, 0, 2, 0,
        2, 1], device='cuda:0')
tensor([1, 1, 1, 0, 1, 0, 2, 1, 2, 1, 1, 1, 1, 0, 0, 2, 2, 2, 0, 2, 2, 0, 1, 0,
        2, 1, 0, 1, 0, 0, 2, 2, 2, 0, 2, 0, 0, 2, 1, 2, 0, 0, 2, 1, 0, 0, 1, 2,
        0, 0], device='cuda:0')
predicted:  tensor([1, 1, 1, 0, 1, 2, 2, 1, 2, 2, 1, 1, 1, 0, 0, 2, 2, 1, 2, 2, 2, 0, 1, 0,
        2, 1, 0, 0, 0, 0, 2, 1, 0, 1, 2, 1, 0, 2, 1, 2, 1, 1, 2, 1, 0, 0, 1, 2,
        1, 1], device='cuda:0')
tensor([2, 0, 0, 2, 0, 1, 1, 0, 1, 2, 0, 0, 2, 1, 2, 0, 2, 0, 0, 2, 1, 2, 0, 2,
        0, 1, 0, 0, 1, 2, 0, 1, 1, 0, 2, 0, 0, 0, 2, 0, 1, 1, 1, 1, 0, 0, 2, 1,
        0, 1], device='cuda:0')
predicted:  tensor([0, 0, 1, 0, 0, 1, 1, 1, 1, 2, 0, 0, 2, 0, 2, 1, 1, 0, 0, 2, 1, 2, 0, 2,
        2, 1, 0, 0, 1, 2, 0, 1, 2, 0, 2, 0, 0, 0, 2, 1, 1, 1, 0, 0, 0, 0, 0, 1,
        0, 1], device='cuda:0')
tensor([0, 0, 1, 2, 1, 0, 1, 0, 1, 2, 2, 2, 1, 0, 2, 2, 2, 0, 0, 2, 2, 0, 2, 1,
        1, 1, 2, 1, 1, 1, 2, 2, 1, 2, 1, 0, 0, 1, 0, 2, 2, 2, 0, 0, 1, 1, 0, 1,
        0, 2], device='cuda:0')
predicted:  tensor([1, 0, 1, 1, 1, 2, 1, 0, 1, 0, 2, 2, 1, 0, 2, 0, 2, 0, 0, 2, 2, 0, 1, 1,
        1, 2, 2, 1, 2, 1, 2, 2, 1, 2, 2, 0, 0, 1, 0, 2, 2, 2, 0, 0, 1, 1, 0, 1,
        0, 2], device='cuda:0')
tensor([2, 2, 0, 1, 2, 0, 2, 2, 0, 2, 1, 2, 1, 1, 2, 2, 2, 2, 1, 1, 0, 0, 0, 1,
        1, 0, 2, 1, 0, 0, 0, 0, 2, 1, 1, 2, 1, 1, 1, 2, 0, 1, 0, 2, 2, 2, 0, 2,
        0, 0], device='cuda:0')
predicted:  tensor([2, 2, 1, 1, 0, 0, 2, 2, 0, 2, 1, 0, 1, 0, 2, 2, 2, 1, 0, 1, 2, 0, 2, 1,
        0, 0, 2, 1, 0, 0, 0, 0, 2, 2, 1, 2, 1, 1, 0, 1, 0, 1, 0, 2, 2, 2, 1, 2,
        2, 2], device='cuda:0')
tensor([2, 0, 2, 0, 2, 1, 2, 2, 2, 1, 2, 0, 0, 0, 0, 1, 2, 2, 0, 1, 2, 0, 0, 0,
        1, 2, 0, 1, 2, 1, 2, 0, 0, 0, 1, 0, 0, 0, 1, 2, 2, 0, 1, 2, 1, 1, 0, 2,
        0, 2], device='cuda:0')
predicted:  tensor([2, 0, 2, 2, 2, 1, 2, 2, 2, 1, 2, 1, 0, 0, 0, 1, 0, 2, 0, 1, 2, 0, 1, 0,
        1, 2, 0, 1, 2, 1, 2, 1, 0, 0, 1, 0, 0, 0, 2, 2, 2, 0, 0, 2, 1, 1, 0, 0,
        0, 2], device='cuda:0')
tensor([2, 2, 1, 0, 1, 2, 1, 0, 1, 0, 0, 0, 2, 1, 0, 2, 0, 2, 0, 1, 0, 2, 2, 0,
        0, 0, 2, 2, 0, 2, 2, 0, 1, 0, 2, 2, 0, 2, 1, 1, 0, 0, 2, 2, 2, 2, 2, 1,
        1, 0], device='cuda:0')
predicted:  tensor([2, 0, 1, 0, 1, 2, 2, 2, 0, 2, 0, 0, 2, 1, 0, 2, 0, 2, 0, 1, 2, 2, 1, 0,
        0, 2, 2, 1, 2, 2, 2, 0, 1, 1, 2, 2, 0, 2, 1, 0, 1, 2, 2, 2, 2, 2, 2, 1,
        1, 0], device='cuda:0')
tensor([1, 0, 1, 0, 0, 0, 2, 2, 0, 1, 2, 1, 1, 0, 1, 1, 1, 0, 0, 0, 1, 2, 1, 1,
        0, 0, 0, 1, 1, 2, 2, 2, 2, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 2, 2, 1, 2, 1,
        1, 0], device='cuda:0')
predicted:  tensor([1, 0, 1, 0, 0, 0, 1, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 1, 2, 1, 2,
        0, 0, 0, 0, 1, 2, 2, 2, 1, 2, 0, 1, 0, 0, 1, 0, 0, 1, 1, 1, 2, 1, 0, 1,
        1, 0], device='cuda:0')
tensor([0, 1, 0, 1, 1, 2, 0, 2, 1, 0, 0, 0, 2, 0, 1, 0, 2, 0, 0, 0, 0, 2, 0, 2,
        2, 2, 0, 0, 1, 0, 1, 2, 1, 1, 0, 0, 0, 0, 0, 2, 2, 1, 2, 2, 2, 1, 2, 0,
        0, 1], device='cuda:0')
predicted:  tensor([0, 1, 0, 1, 1, 0, 0, 0, 1, 0, 0, 0, 2, 0, 1, 0, 2, 0, 0, 0, 0, 2, 1, 2,
        0, 2, 1, 0, 1, 0, 1, 2, 0, 1, 2, 0, 1, 2, 0, 2, 0, 1, 0, 2, 1, 2, 2, 2,
        0, 1], device='cuda:0')
tensor([0, 2, 0, 1, 2, 2, 1, 1, 1, 2, 1, 2, 1, 2, 2, 0, 1, 2, 0, 1, 2, 0, 0, 2,
        0, 1, 0, 0, 2, 2, 1, 1, 2, 2, 1, 2, 1, 0, 2, 2, 0, 1, 2, 2, 0, 0, 0, 2,
        1, 2], device='cuda:0')
predicted:  tensor([0, 2, 0, 1, 2, 2, 1, 1, 1, 2, 1, 2, 1, 2, 0, 0, 1, 2, 0, 1, 0, 0, 0, 2,
        0, 1, 0, 0, 0, 2, 1, 1, 0, 2, 1, 2, 1, 1, 2, 2, 0, 1, 1, 2, 0, 0, 0, 2,
        1, 2], device='cuda:0')
tensor([1, 1, 0, 1, 0, 1, 1, 2, 1, 0, 1, 1, 1, 1, 1, 2, 0, 1, 2, 2, 0, 0, 1, 2,
        1, 1, 2, 1, 0, 0, 1, 1, 1, 1, 0, 2, 1, 2, 1, 0, 1, 2, 0, 2, 2, 0, 1, 1,
        2, 0], device='cuda:0')
predicted:  tensor([2, 1, 0, 0, 0, 1, 0, 2, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 2, 2, 0, 0, 1, 2,
        1, 1, 2, 1, 2, 0, 1, 1, 0, 1, 2, 0, 1, 2, 1, 0, 0, 2, 0, 2, 2, 0, 1, 1,
        1, 0], device='cuda:0')
tensor([1, 0, 2, 0, 1, 2, 1, 2, 1, 0, 2, 1, 1, 2, 2, 0, 0, 2, 0, 1, 2, 1, 2, 1,
        1, 1, 0, 2, 2, 2, 2, 1, 0, 1, 0, 1, 2, 2, 1, 2, 2, 2, 2, 2, 2, 0, 0, 1,
        1, 2], device='cuda:0')
predicted:  tensor([1, 0, 2, 0, 1, 2, 1, 2, 1, 0, 2, 0, 1, 0, 2, 0, 0, 0, 0, 2, 2, 1, 0, 1,
        2, 0, 0, 2, 2, 2, 2, 1, 0, 1, 0, 1, 2, 2, 1, 2, 1, 2, 2, 2, 2, 0, 0, 0,
        1, 2], device='cuda:0')
tensor([1, 0, 2, 0, 0, 0, 0, 1, 0, 0, 0, 2, 2, 0, 0, 2, 2, 1, 1, 1, 2, 0, 0, 2,
        1, 2, 0, 1, 0, 1, 2, 2, 0, 0, 2, 2, 0, 1, 0, 2, 0, 2, 1, 2, 0, 1, 1, 2,
        1, 1], device='cuda:0')
predicted:  tensor([2, 2, 0, 0, 1, 0, 0, 1, 0, 0, 2, 2, 1, 0, 0, 2, 2, 2, 1, 0, 2, 0, 0, 2,
        1, 0, 0, 0, 0, 1, 2, 0, 1, 0, 0, 2, 0, 0, 0, 2, 0, 2, 1, 0, 0, 2, 0, 2,
        1, 1], device='cuda:0')
tensor([0, 2, 0, 1, 1, 0, 1, 0, 2, 1, 1, 1, 2, 2, 0, 0, 2, 0, 1, 1, 2, 2, 0, 0,
        0, 1, 0, 1, 2, 0, 1, 1, 1, 1, 1, 0, 0, 1, 0, 2, 1, 0, 0, 2, 1, 0, 0, 0,
        2, 0], device='cuda:0')
predicted:  tensor([1, 1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 1, 0, 2, 0, 0, 2, 0, 1, 1, 2, 2, 0, 0,
        0, 1, 1, 2, 0, 1, 1, 1, 1, 1, 1, 2, 1, 1, 0, 2, 1, 0, 2, 2, 1, 0, 0, 0,
        2, 0], device='cuda:0')
tensor([2, 1, 0, 0, 2, 1, 1, 1, 1, 0, 0, 1, 0, 1, 0, 0, 1, 0, 1, 2, 2, 2, 2, 2,
        0, 1, 2, 0, 0, 0, 1, 1, 0, 1, 2, 0, 0, 1, 1, 0, 2, 2, 2, 1, 1, 2, 2, 0,
        2, 0], device='cuda:0')
predicted:  tensor([0, 1, 1, 0, 2, 1, 1, 1, 0, 0, 0, 1, 0, 1, 0, 0, 1, 1, 1, 2, 0, 2, 2, 2,
        2, 1, 2, 0, 0, 0, 2, 0, 0, 1, 2, 0, 0, 1, 0, 0, 2, 2, 0, 1, 1, 2, 2, 0,
        2, 0], device='cuda:0')
tensor([2, 2, 1, 0, 0, 0, 2, 1, 2, 1, 0, 1, 2, 1, 2, 0, 1, 1, 1, 0, 0, 2, 2, 0,
        1, 1, 1, 1, 0, 0, 1, 1, 0, 2, 1, 0, 0, 2, 0, 2, 2, 1, 0, 0, 2, 2, 2, 1,
        2, 1], device='cuda:0')
predicted:  tensor([2, 0, 1, 0, 0, 0, 2, 1, 0, 1, 0, 0, 2, 1, 2, 0, 1, 1, 1, 0, 0, 2, 2, 2,
        0, 2, 2, 1, 0, 0, 1, 1, 0, 2, 1, 0, 0, 2, 0, 2, 2, 1, 0, 0, 2, 2, 2, 1,
        0, 1], device='cuda:0')
Test accuracy: 76 %</code></pre>
</div>
</div>
<div class="cell" data-outputid="593adc64-ded1-4219-da18-6d5e90bf6ec3">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>cf_matrix <span class="op">=</span> confusion_matrix(y_true_enet, y_pred_enet)</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cf_matrix)</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>classes <span class="op">=</span> [<span class="st">'White'</span>,<span class="st">'Black'</span>,<span class="st">'Asian'</span>]</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>df_cm <span class="op">=</span> pd.DataFrame(cf_matrix <span class="op">/</span> np.<span class="bu">sum</span>(cf_matrix, axis<span class="op">=</span><span class="dv">1</span>)[:, <span class="va">None</span>], index <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> classes],</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>                     columns <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> classes])</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize <span class="op">=</span> (<span class="dv">12</span>,<span class="dv">7</span>))</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="vs">r'Confusion matrix: BWA Equal with Exponential Scheduler, $\gamma = 0.9$, Both genders'</span>)</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>sns.heatmap(df_cm, annot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">'output.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>NameError: ignored</code></pre>
</div>
</div>
<div class="cell" data-outputid="41930907-ef63-42c4-8c86-7160768e345c">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>model_filename <span class="op">=</span> <span class="st">"/content/drive/Shareddrives/CheXpert-v1.0-small/resnet18_bwa_frontal_gamma06.pth"</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>model_saved <span class="op">=</span> models.resnet18(weights<span class="op">=</span><span class="st">'IMAGENET1K_V1'</span>)</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>num_ftrs <span class="op">=</span> model_saved.fc.in_features</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>model_saved.fc <span class="op">=</span> nn.Linear(num_ftrs, <span class="dv">3</span>) </span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>checkpoint <span class="op">=</span> torch.load(model_filename, map_location<span class="op">=</span>device)</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Loading trained model weights...'</span>)</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>model_saved.load_state_dict(checkpoint[<span class="st">'model_state_dict'</span>],strict<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>model_saved <span class="op">=</span> model_saved.to(device)</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>test_dataset <span class="op">=</span> ChestXrayDataset(<span class="st">"/content/drive/Shareddrives/"</span>, df_test_bwa_equal_frontal[:<span class="dv">2000</span>], IMAGE_SIZE, <span class="va">True</span>)</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>test_dataloader <span class="op">=</span> DataLoader(dataset<span class="op">=</span>test_dataset, batch_size<span class="op">=</span><span class="dv">50</span>, shuffle<span class="op">=</span><span class="va">False</span>, num_workers<span class="op">=</span><span class="dv">2</span>, pin_memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>y_pred_enet, y_true_enet <span class="op">=</span> test(model_saved,test_dataloader)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loading trained model weights...
tensor([0, 1, 1, 1, 0, 1, 2, 1, 1, 0, 2, 2, 1, 0, 1, 2, 1, 1, 1, 0, 0, 2, 1, 0,
        2, 1, 1, 2, 0, 1, 0, 2, 0, 2, 0, 2, 0, 2, 2, 1, 0, 2, 0, 1, 2, 0, 0, 1,
        0, 1])
predicted:  tensor([0, 1, 1, 2, 0, 1, 2, 1, 1, 0, 0, 2, 1, 0, 1, 2, 1, 1, 1, 0, 0, 2, 0, 0,
        2, 0, 1, 0, 0, 1, 0, 2, 0, 0, 0, 2, 0, 2, 0, 1, 2, 2, 0, 2, 0, 0, 0, 1,
        1, 1])
tensor([0, 0, 0, 2, 0, 2, 1, 0, 0, 0, 1, 2, 2, 1, 2, 1, 2, 2, 2, 0, 0, 0, 1, 2,
        1, 2, 1, 2, 2, 1, 0, 0, 0, 0, 0, 2, 1, 0, 1, 2, 0, 2, 0, 1, 2, 2, 2, 0,
        0, 1])
predicted:  tensor([0, 0, 0, 2, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 0, 0, 0, 0, 1, 0, 2,
        1, 2, 0, 0, 2, 1, 0, 0, 2, 0, 0, 2, 0, 0, 1, 2, 0, 0, 0, 1, 0, 2, 2, 0,
        2, 1])
tensor([2, 2, 1, 1, 1, 1, 2, 1, 1, 0, 2, 1, 0, 1, 2, 1, 2, 1, 0, 2, 0, 1, 1, 0,
        0, 2, 2, 1, 2, 0, 2, 0, 0, 1, 0, 1, 1, 2, 2, 2, 1, 0, 1, 2, 0, 0, 0, 2,
        2, 1])
predicted:  tensor([2, 2, 1, 0, 1, 1, 2, 1, 1, 0, 2, 0, 0, 0, 0, 1, 0, 1, 0, 2, 0, 1, 2, 0,
        0, 0, 2, 0, 2, 0, 2, 1, 0, 1, 0, 0, 0, 0, 2, 1, 1, 0, 1, 2, 0, 0, 0, 2,
        2, 0])
tensor([1, 0, 1, 0, 2, 2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 0, 1, 2, 1, 0, 1, 1, 1,
        2, 2, 2, 0, 1, 2, 1, 1, 1, 0, 1, 1, 1, 0, 2, 2, 0, 0, 1, 0, 0, 0, 2, 2,
        0, 2])
predicted:  tensor([0, 0, 0, 0, 2, 2, 0, 0, 0, 1, 2, 2, 0, 2, 0, 0, 0, 0, 0, 1, 0, 1, 1, 0,
        2, 2, 2, 0, 1, 2, 1, 0, 1, 0, 0, 0, 1, 0, 2, 2, 0, 0, 1, 0, 0, 0, 2, 2,
        0, 0])
tensor([2, 0, 1, 1, 1, 2, 0, 2, 0, 1, 1, 0, 1, 1, 2, 0, 2, 1, 0, 1, 2, 0, 2, 2,
        2, 0, 0, 2, 1, 2, 1, 2, 0, 0, 2, 1, 2, 2, 2, 2, 1, 1, 0, 2, 0, 0, 1, 2,
        1, 2])
predicted:  tensor([2, 0, 1, 1, 0, 2, 0, 2, 0, 1, 0, 0, 0, 1, 2, 0, 2, 1, 0, 0, 1, 2, 0, 2,
        2, 0, 0, 2, 0, 2, 1, 2, 0, 0, 2, 0, 0, 2, 2, 1, 1, 1, 0, 0, 0, 0, 1, 2,
        1, 2])
tensor([2, 1, 0, 2, 2, 1, 0, 1, 2, 1, 0, 1, 2, 1, 1, 2, 0, 2, 0, 0, 0, 1, 0, 0,
        0, 2, 1, 0, 2, 0, 0, 1, 1, 2, 1, 0, 2, 0, 2, 0, 1, 1, 0, 1, 2, 2, 1, 0,
        1, 2])
predicted:  tensor([2, 1, 0, 2, 2, 1, 0, 1, 0, 1, 0, 0, 2, 1, 1, 2, 0, 2, 0, 0, 0, 1, 0, 0,
        2, 0, 1, 0, 2, 0, 0, 1, 1, 2, 0, 2, 2, 0, 2, 0, 1, 0, 0, 0, 2, 2, 1, 0,
        1, 0])
tensor([0, 1, 1, 0, 1, 0, 0, 0, 1, 1, 0, 2, 1, 0, 2, 2, 1, 1, 0, 0, 2, 1, 2, 0,
        1, 2, 2, 1, 2, 0, 1, 2, 0, 2, 1, 1, 1, 0, 2, 1, 2, 1, 2, 0, 2, 1, 1, 1,
        2, 0])
predicted:  tensor([0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 0, 0, 2, 0, 1, 0, 0, 2, 1, 0, 0,
        1, 2, 0, 0, 2, 0, 1, 2, 0, 2, 0, 1, 0, 0, 2, 1, 2, 1, 2, 0, 0, 0, 1, 0,
        2, 0])
tensor([0, 1, 2, 0, 1, 0, 2, 1, 2, 2, 2, 2, 1, 2, 0, 2, 2, 0, 0, 0, 0, 1, 1, 0,
        1, 0, 1, 2, 0, 1, 0, 2, 2, 1, 2, 2, 2, 2, 2, 0, 2, 1, 1, 1, 0, 0, 0, 2,
        0, 0])
predicted:  tensor([0, 0, 2, 1, 1, 0, 2, 2, 0, 2, 2, 2, 0, 2, 0, 0, 2, 0, 0, 0, 0, 1, 0, 0,
        1, 0, 0, 2, 0, 1, 0, 2, 0, 1, 0, 0, 2, 0, 2, 0, 0, 1, 1, 1, 0, 0, 0, 2,
        0, 0])
tensor([2, 2, 2, 2, 1, 1, 1, 2, 0, 0, 2, 1, 0, 1, 1, 0, 1, 2, 2, 2, 0, 2, 1, 2,
        0, 2, 0, 1, 0, 2, 2, 0, 0, 0, 2, 0, 2, 0, 1, 2, 0, 2, 2, 1, 0, 1, 0, 0,
        1, 1])
predicted:  tensor([2, 0, 2, 0, 0, 1, 1, 2, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 2, 0, 0, 0, 2,
        0, 0, 0, 1, 0, 2, 2, 1, 0, 0, 2, 0, 2, 0, 1, 2, 0, 2, 2, 0, 0, 0, 0, 0,
        0, 1])
tensor([0, 0, 2, 0, 1, 2, 1, 2, 2, 2, 2, 2, 0, 1, 1, 2, 2, 2, 2, 2, 0, 0, 0, 2,
        0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 1, 2, 0, 1, 0, 2, 2, 1, 1, 2, 0, 2, 0, 0,
        0, 0])
predicted:  tensor([1, 0, 2, 0, 0, 0, 0, 2, 2, 0, 2, 0, 0, 1, 1, 2, 0, 2, 2, 0, 2, 0, 0, 2,
        0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 2, 2, 2, 0, 0, 0, 2, 0, 0,
        1, 0])
tensor([1, 1, 2, 0, 1, 2, 0, 2, 2, 1, 0, 1, 1, 2, 1, 1, 0, 0, 1, 2, 2, 0, 0, 2,
        0, 1, 1, 0, 2, 2, 0, 0, 1, 0, 1, 2, 2, 1, 1, 0, 0, 2, 0, 0, 0, 0, 0, 1,
        0, 1])
predicted:  tensor([1, 0, 2, 0, 0, 2, 0, 0, 2, 0, 0, 1, 1, 2, 2, 0, 0, 0, 0, 2, 0, 0, 0, 0,
        0, 1, 1, 0, 0, 2, 1, 0, 1, 0, 1, 2, 2, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0,
        0, 1])
tensor([0, 0, 0, 1, 2, 0, 1, 2, 2, 1, 1, 1, 0, 1, 1, 2, 1, 0, 1, 2, 1, 0, 0, 1,
        1, 0, 2, 0, 1, 2, 1, 2, 2, 0, 2, 0, 2, 0, 0, 0, 1, 2, 1, 0, 2, 0, 2, 0,
        0, 0])
predicted:  tensor([0, 0, 0, 0, 2, 0, 1, 0, 2, 1, 0, 0, 0, 1, 2, 2, 1, 0, 1, 0, 0, 0, 0, 1,
        1, 1, 0, 0, 1, 2, 1, 2, 2, 0, 2, 0, 0, 0, 0, 0, 1, 2, 1, 0, 0, 0, 2, 0,
        0, 0])
tensor([0, 0, 0, 1, 2, 0, 0, 2, 0, 1, 0, 1, 0, 2, 2, 2, 1, 2, 0, 2, 0, 2, 1, 1,
        2, 2, 1, 2, 0, 0, 1, 0, 1, 1, 0, 1, 0, 1, 2, 1, 0, 0, 2, 1, 0, 1, 0, 2,
        0, 1])
predicted:  tensor([0, 0, 0, 1, 2, 0, 0, 0, 0, 1, 0, 1, 0, 2, 0, 2, 0, 0, 2, 0, 0, 0, 0, 0,
        0, 2, 1, 2, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 2, 2, 0, 1, 0, 0,
        0, 0])
tensor([0, 1, 0, 0, 1, 1, 2, 0, 1, 0, 2, 1, 1, 2, 1, 0, 0, 1, 2, 0, 0, 2, 2, 2,
        0, 1, 0, 1, 2, 2, 2, 1, 0, 1, 1, 2, 0, 2, 2, 0, 0, 0, 1, 1, 2, 2, 1, 1,
        1, 0])
predicted:  tensor([0, 1, 0, 0, 1, 1, 2, 0, 0, 1, 2, 1, 1, 0, 0, 0, 0, 0, 2, 0, 0, 0, 2, 0,
        2, 1, 0, 1, 0, 2, 2, 1, 2, 0, 1, 0, 0, 2, 0, 0, 0, 0, 1, 1, 0, 2, 1, 0,
        1, 0])
tensor([1, 1, 1, 2, 1, 0, 2, 2, 0, 1, 2, 0, 1, 1, 2, 0, 1, 2, 2, 0, 0, 1, 0, 0,
        1, 0, 0, 1, 0, 1, 0, 2, 1, 1, 0, 0, 2, 2, 0, 1, 1, 2, 2, 1, 1, 0, 0, 1,
        1, 1])
predicted:  tensor([1, 0, 1, 0, 1, 0, 0, 2, 0, 1, 2, 0, 1, 0, 0, 0, 1, 2, 2, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 2, 1, 1, 0, 0, 2, 2, 0, 0, 1, 0, 2, 2, 1, 0, 0, 0,
        1, 1])
tensor([1, 2, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 1, 0, 1, 2, 0, 1, 1, 0, 1, 0,
        2, 1, 0, 2, 2, 1, 1, 0, 1, 0, 0, 1, 0, 2, 1, 2, 2, 2, 1, 1, 0, 1, 2, 2,
        2, 0])
predicted:  tensor([1, 2, 0, 2, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 1, 0, 1, 2, 0, 0, 1, 0, 1, 0,
        2, 0, 0, 2, 0, 1, 1, 0, 0, 0, 0, 1, 0, 0, 1, 2, 2, 2, 1, 1, 0, 1, 0, 2,
        0, 0])
tensor([1, 1, 0, 2, 0, 2, 2, 0, 2, 2, 0, 1, 0, 0, 2, 2, 1, 1, 2, 2, 0, 0, 0, 2,
        0, 2, 1, 1, 0, 2, 0, 0, 1, 1, 1, 2, 2, 2, 0, 1, 0, 0, 2, 0, 2, 0, 1, 0,
        0, 2])
predicted:  tensor([1, 1, 0, 0, 0, 2, 0, 0, 2, 2, 0, 0, 0, 0, 2, 2, 1, 0, 2, 2, 0, 0, 0, 2,
        1, 0, 1, 1, 0, 2, 0, 0, 0, 0, 1, 2, 2, 2, 0, 2, 0, 0, 2, 0, 2, 0, 0, 0,
        0, 2])
tensor([1, 0, 0, 0, 1, 1, 1, 1, 2, 1, 0, 2, 0, 2, 1, 2, 2, 2, 1, 1, 2, 2, 0, 2,
        1, 2, 1, 2, 1, 2, 1, 1, 2, 2, 1, 1, 0, 2, 1, 0, 0, 0, 1, 0, 1, 2, 1, 2,
        1, 2])
predicted:  tensor([0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 0, 2, 0, 1, 0, 1, 0, 2, 0, 1, 0, 2, 0, 2,
        1, 2, 0, 0, 1, 2, 1, 1, 2, 2, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 1, 2,
        0, 0])
tensor([2, 0, 2, 2, 1, 0, 2, 2, 1, 2, 2, 2, 0, 0, 0, 2, 0, 0, 0, 2, 1, 2, 2, 2,
        1, 0, 2, 1, 1, 0, 2, 0, 1, 1, 0, 0, 2, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 1,
        2, 1])
predicted:  tensor([2, 0, 0, 2, 1, 1, 1, 2, 1, 2, 2, 2, 0, 0, 0, 2, 0, 0, 0, 2, 0, 2, 2, 0,
        1, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 2, 0, 0, 0, 2, 0, 0, 0, 0, 0, 2, 1,
        2, 1])
tensor([1, 1, 1, 1, 0, 1, 1, 1, 2, 0, 2, 0, 0, 2, 2, 2, 2, 1, 1, 2, 1, 1, 2, 2,
        0, 0, 2, 2, 1, 1, 1, 2, 0, 1, 1, 0, 1, 0, 1, 1, 0, 0, 0, 2, 0, 2, 0, 1,
        2, 1])
predicted:  tensor([0, 1, 1, 1, 0, 1, 1, 0, 0, 0, 0, 2, 0, 2, 0, 0, 2, 1, 1, 0, 0, 1, 2, 2,
        0, 0, 0, 2, 1, 1, 1, 2, 0, 1, 1, 0, 1, 0, 1, 0, 0, 0, 2, 0, 0, 0, 0, 0,
        2, 1])
tensor([2, 0, 0, 0, 2, 0, 1, 0, 2, 0, 1, 2, 1, 2, 2, 2, 1, 2, 1, 0, 2, 1, 2, 0,
        0, 0, 0, 2, 1, 0, 2, 1, 2, 1, 2, 1, 2, 2, 2, 1, 0, 1, 2, 0, 1, 0, 1, 1,
        0, 2])
predicted:  tensor([0, 0, 0, 0, 2, 0, 1, 0, 2, 0, 0, 2, 1, 0, 2, 2, 1, 2, 2, 0, 0, 0, 2, 2,
        0, 0, 0, 2, 0, 0, 0, 0, 2, 1, 2, 1, 2, 2, 2, 1, 0, 0, 2, 0, 1, 0, 1, 1,
        0, 0])
tensor([0, 1, 0, 2, 1, 1, 2, 1, 2, 0, 2, 2, 0, 0, 0, 0, 2, 0, 2, 1, 0, 1, 1, 2,
        0, 0, 0, 0, 1, 0, 1, 1, 1, 2, 2, 1, 0, 0, 2, 1, 2, 1, 0, 1, 1, 0, 0, 2,
        2, 0])
predicted:  tensor([0, 1, 0, 2, 1, 1, 2, 0, 2, 0, 0, 2, 0, 0, 0, 0, 0, 0, 2, 1, 0, 1, 1, 0,
        0, 0, 0, 0, 1, 0, 1, 1, 0, 2, 0, 0, 0, 0, 2, 1, 2, 1, 0, 0, 1, 0, 0, 2,
        2, 1])
tensor([2, 2, 2, 0, 0, 0, 0, 2, 1, 1, 2, 2, 0, 1, 1, 2, 2, 0, 1, 1, 0, 1, 1, 0,
        2, 0, 2, 1, 2, 2, 1, 1, 1, 0, 1, 1, 0, 2, 1, 1, 2, 1, 2, 0, 1, 2, 2, 0,
        1, 0])
predicted:  tensor([0, 2, 2, 0, 0, 0, 0, 1, 1, 2, 2, 1, 0, 1, 1, 0, 2, 0, 0, 1, 2, 2, 1, 0,
        2, 0, 2, 1, 2, 0, 1, 1, 1, 0, 1, 1, 0, 2, 0, 1, 2, 0, 0, 0, 1, 0, 2, 0,
        1, 0])
tensor([0, 0, 2, 1, 1, 0, 1, 0, 2, 2, 2, 0, 2, 2, 2, 1, 2, 0, 2, 1, 0, 1, 1, 1,
        0, 2, 1, 1, 2, 2, 0, 1, 2, 2, 1, 1, 2, 2, 0, 0, 2, 0, 2, 0, 0, 0, 0, 0,
        1, 0])
predicted:  tensor([0, 0, 2, 0, 1, 0, 0, 0, 0, 2, 2, 0, 0, 2, 0, 1, 2, 0, 2, 0, 1, 0, 0, 1,
        0, 0, 0, 1, 0, 2, 0, 0, 2, 0, 0, 1, 0, 2, 0, 0, 0, 0, 2, 0, 0, 0, 1, 0,
        1, 0])
tensor([2, 2, 1, 1, 0, 1, 2, 1, 2, 0, 2, 1, 2, 1, 1, 0, 0, 2, 1, 2, 0, 1, 1, 0,
        1, 1, 2, 1, 2, 0, 0, 0, 2, 1, 0, 0, 2, 2, 1, 2, 0, 1, 1, 1, 1, 2, 0, 2,
        2, 1])
predicted:  tensor([0, 2, 1, 1, 0, 0, 2, 0, 2, 0, 0, 1, 2, 0, 1, 0, 0, 2, 1, 2, 0, 1, 0, 0,
        0, 0, 2, 1, 2, 0, 0, 0, 0, 1, 0, 0, 2, 2, 1, 0, 0, 0, 1, 1, 1, 0, 2, 0,
        2, 1])
tensor([1, 1, 1, 0, 1, 0, 2, 1, 2, 1, 1, 1, 1, 0, 0, 2, 2, 2, 0, 2, 2, 0, 1, 0,
        2, 1, 0, 1, 0, 0, 2, 2, 2, 0, 2, 0, 0, 2, 1, 2, 0, 0, 2, 1, 0, 0, 1, 2,
        0, 0])
predicted:  tensor([0, 1, 1, 0, 1, 2, 2, 0, 2, 0, 1, 1, 1, 0, 0, 2, 0, 0, 0, 2, 2, 0, 1, 0,
        2, 1, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0, 0, 1, 0, 0, 1, 0,
        0, 0])
tensor([2, 0, 0, 2, 0, 1, 1, 0, 1, 2, 0, 0, 2, 1, 2, 0, 2, 0, 0, 2, 1, 2, 0, 2,
        0, 1, 0, 0, 1, 2, 0, 1, 1, 0, 2, 0, 0, 0, 2, 0, 1, 1, 1, 1, 0, 0, 2, 1,
        0, 1])
predicted:  tensor([0, 0, 0, 0, 0, 1, 1, 0, 1, 2, 0, 0, 2, 0, 2, 0, 0, 0, 0, 2, 1, 0, 0, 0,
        0, 1, 0, 0, 1, 2, 0, 1, 0, 0, 0, 0, 0, 0, 2, 0, 1, 1, 0, 0, 0, 0, 0, 0,
        0, 0])
tensor([0, 0, 1, 2, 1, 0, 1, 0, 1, 2, 2, 2, 1, 0, 2, 2, 2, 0, 0, 2, 2, 0, 2, 1,
        1, 1, 2, 1, 1, 1, 2, 2, 1, 2, 1, 0, 0, 1, 0, 2, 2, 2, 0, 0, 1, 1, 0, 1,
        0, 2])
predicted:  tensor([0, 0, 1, 0, 1, 0, 1, 0, 1, 0, 0, 2, 1, 0, 0, 2, 2, 0, 0, 2, 2, 0, 1, 1,
        1, 2, 2, 1, 2, 1, 2, 0, 0, 2, 2, 0, 0, 1, 0, 0, 0, 2, 0, 0, 1, 1, 0, 1,
        0, 2])
tensor([2, 2, 0, 1, 2, 0, 2, 2, 0, 2, 1, 2, 1, 1, 2, 2, 2, 2, 1, 1, 0, 0, 0, 1,
        1, 0, 2, 1, 0, 0, 0, 0, 2, 1, 1, 2, 1, 1, 1, 2, 0, 1, 0, 2, 2, 2, 0, 2,
        0, 0])
predicted:  tensor([2, 2, 0, 1, 0, 0, 2, 2, 0, 2, 1, 0, 1, 0, 2, 2, 0, 0, 0, 1, 0, 0, 0, 0,
        0, 0, 2, 1, 0, 0, 0, 0, 2, 0, 0, 2, 0, 1, 0, 1, 0, 1, 0, 0, 2, 0, 0, 0,
        2, 0])
tensor([2, 0, 2, 0, 2, 1, 2, 2, 2, 1, 2, 0, 0, 0, 0, 1, 2, 2, 0, 1, 2, 0, 0, 0,
        1, 2, 0, 1, 2, 1, 2, 0, 0, 0, 1, 0, 0, 0, 1, 2, 2, 0, 1, 2, 1, 1, 0, 2,
        0, 2])
predicted:  tensor([0, 0, 2, 0, 2, 1, 2, 2, 2, 1, 0, 0, 0, 0, 0, 1, 2, 2, 0, 1, 2, 0, 0, 0,
        0, 2, 0, 1, 2, 1, 2, 0, 0, 0, 1, 0, 0, 0, 0, 2, 2, 0, 0, 2, 1, 1, 0, 0,
        0, 2])
tensor([2, 2, 1, 0, 1, 2, 1, 0, 1, 0, 0, 0, 2, 1, 0, 2, 0, 2, 0, 1, 0, 2, 2, 0,
        0, 0, 2, 2, 0, 2, 2, 0, 1, 0, 2, 2, 0, 2, 1, 1, 0, 0, 2, 2, 2, 2, 2, 1,
        1, 0])
predicted:  tensor([2, 0, 1, 0, 1, 2, 2, 2, 0, 0, 0, 2, 0, 1, 0, 2, 0, 2, 0, 1, 0, 2, 2, 0,
        0, 0, 2, 0, 0, 2, 0, 0, 1, 0, 0, 2, 0, 2, 0, 0, 1, 0, 2, 2, 2, 2, 2, 1,
        1, 0])
tensor([1, 0, 1, 0, 0, 0, 2, 2, 0, 1, 2, 1, 1, 0, 1, 1, 1, 0, 0, 0, 1, 2, 1, 1,
        0, 0, 0, 1, 1, 2, 2, 2, 2, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 2, 2, 1, 2, 1,
        1, 0])
predicted:  tensor([1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1, 2, 1, 2,
        0, 0, 0, 0, 1, 2, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 1, 0, 2, 1, 0, 1,
        1, 0])
tensor([0, 1, 0, 1, 1, 2, 0, 2, 1, 0, 0, 0, 2, 0, 1, 0, 2, 0, 0, 0, 0, 2, 0, 2,
        2, 2, 0, 0, 1, 0, 1, 2, 1, 1, 0, 0, 0, 0, 0, 2, 2, 1, 2, 2, 2, 1, 2, 0,
        0, 1])
predicted:  tensor([0, 1, 0, 1, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 1, 0, 1, 0, 0, 2, 0, 1, 0, 0, 0, 0, 2, 2, 0, 1, 0, 0, 2, 2, 0, 2,
        0, 1])
tensor([0, 2, 0, 1, 2, 2, 1, 1, 1, 2, 1, 2, 1, 2, 2, 0, 1, 2, 0, 1, 2, 0, 0, 2,
        0, 1, 0, 0, 2, 2, 1, 1, 2, 2, 1, 2, 1, 0, 2, 2, 0, 1, 2, 2, 0, 0, 0, 2,
        1, 2])
predicted:  tensor([0, 2, 0, 1, 2, 0, 1, 1, 1, 2, 0, 2, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 2,
        0, 0, 0, 0, 2, 2, 1, 1, 0, 2, 1, 2, 0, 0, 2, 2, 0, 1, 0, 0, 0, 0, 0, 2,
        1, 2])
tensor([1, 1, 0, 1, 0, 1, 1, 2, 1, 0, 1, 1, 1, 1, 1, 2, 0, 1, 2, 2, 0, 0, 1, 2,
        1, 1, 2, 1, 0, 0, 1, 1, 1, 1, 0, 2, 1, 2, 1, 0, 1, 2, 0, 2, 2, 0, 1, 1,
        2, 0])
predicted:  tensor([2, 0, 0, 0, 0, 1, 0, 2, 1, 0, 1, 1, 2, 1, 1, 0, 2, 1, 2, 2, 0, 0, 1, 2,
        0, 1, 2, 1, 0, 2, 1, 1, 0, 1, 0, 0, 1, 2, 1, 0, 0, 0, 0, 2, 2, 0, 0, 1,
        2, 0])
tensor([1, 0, 2, 0, 1, 2, 1, 2, 1, 0, 2, 1, 1, 2, 2, 0, 0, 2, 0, 1, 2, 1, 2, 1,
        1, 1, 0, 2, 2, 2, 2, 1, 0, 1, 0, 1, 2, 2, 1, 2, 2, 2, 2, 2, 2, 0, 0, 1,
        1, 2])
predicted:  tensor([1, 0, 0, 0, 1, 2, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 2, 0, 2, 2, 1, 0, 1,
        0, 0, 0, 0, 2, 0, 2, 1, 0, 1, 0, 0, 2, 0, 0, 2, 0, 2, 2, 2, 2, 0, 0, 0,
        1, 2])
tensor([1, 0, 2, 0, 0, 0, 0, 1, 0, 0, 0, 2, 2, 0, 0, 2, 2, 1, 1, 1, 2, 0, 0, 2,
        1, 2, 0, 1, 0, 1, 2, 2, 0, 0, 2, 2, 0, 1, 0, 2, 0, 2, 1, 2, 0, 1, 1, 2,
        1, 1])
predicted:  tensor([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 1, 0, 0, 0, 0, 2,
        1, 0, 0, 0, 0, 1, 2, 0, 0, 0, 0, 2, 0, 0, 0, 2, 0, 2, 1, 0, 0, 2, 0, 2,
        1, 1])
tensor([0, 2, 0, 1, 1, 0, 1, 0, 2, 1, 1, 1, 2, 2, 0, 0, 2, 0, 1, 1, 2, 2, 0, 0,
        0, 1, 0, 1, 2, 0, 1, 1, 1, 1, 1, 0, 0, 1, 0, 2, 1, 0, 0, 2, 1, 0, 0, 0,
        2, 0])
predicted:  tensor([0, 1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 2, 0, 1, 1, 2, 2, 0, 0,
        0, 1, 0, 2, 0, 1, 1, 1, 1, 1, 1, 2, 0, 1, 0, 2, 1, 0, 2, 2, 1, 0, 0, 0,
        2, 0])
tensor([2, 1, 0, 0, 2, 1, 1, 1, 1, 0, 0, 1, 0, 1, 0, 0, 1, 0, 1, 2, 2, 2, 2, 2,
        0, 1, 2, 0, 0, 0, 1, 1, 0, 1, 2, 0, 0, 1, 1, 0, 2, 2, 2, 1, 1, 2, 2, 0,
        2, 0])
predicted:  tensor([0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 2, 0, 2, 2, 2,
        0, 1, 2, 0, 0, 0, 2, 0, 0, 1, 2, 0, 0, 1, 0, 0, 2, 2, 2, 1, 1, 2, 2, 0,
        2, 0])
tensor([2, 2, 1, 0, 0, 0, 2, 1, 2, 1, 0, 1, 2, 1, 2, 0, 1, 1, 1, 0, 0, 2, 2, 0,
        1, 1, 1, 1, 0, 0, 1, 1, 0, 2, 1, 0, 0, 2, 0, 2, 2, 1, 0, 0, 2, 2, 2, 1,
        2, 1])
predicted:  tensor([2, 0, 1, 0, 0, 0, 2, 1, 0, 0, 0, 0, 2, 1, 2, 0, 1, 1, 1, 0, 0, 2, 2, 0,
        0, 1, 1, 0, 0, 0, 1, 1, 0, 2, 1, 0, 0, 2, 0, 2, 2, 1, 0, 0, 2, 0, 0, 1,
        0, 1])
Test accuracy: 73 %</code></pre>
</div>
</div>
<div class="cell" data-outputid="03109ee1-407f-4b77-f4d5-99242d15ec17">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>cf_matrix <span class="op">=</span> confusion_matrix(y_true_enet, y_pred_enet)</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="co"># cm_normalized = cf_matrix.astype('float') / cf_matrix.sum(axis=1)[:, np.newaxis]</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a><span class="co"># sns.heatmap(cm_normalized, annot=True, linewidths = 0.01)</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a><span class="co"># print(cf_matrix)</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>classes <span class="op">=</span> [<span class="st">'White'</span>,<span class="st">'Black'</span>,<span class="st">'Asian'</span>]</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>df_cm <span class="op">=</span> pd.DataFrame(cf_matrix <span class="op">/</span> np.<span class="bu">sum</span>(cf_matrix, axis<span class="op">=</span><span class="dv">1</span>)[:, <span class="va">None</span>], index <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> classes],</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>                     columns <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> classes])</span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize <span class="op">=</span> (<span class="dv">12</span>,<span class="dv">7</span>))</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="vs">r'Confusion matrix: BWA Equal with Exponential Scheduler, $\gamma = 0.6$, Both genders'</span>)</span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>sns.heatmap(df_cm, annot<span class="op">=</span><span class="va">True</span>, linewidths <span class="op">=</span> <span class="fl">0.01</span>)</span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">'output.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-47-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="2584b10c-be15-467c-ec8d-37aead55494c">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>lr_params <span class="op">=</span> [<span class="fl">0.0001</span>,<span class="fl">0.001</span>,<span class="fl">0.005</span>,<span class="fl">0.01</span>]</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>epoch_list <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">15</span>)]</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>color <span class="op">=</span> [<span class="st">'b'</span>, <span class="st">'g'</span>, <span class="st">'r'</span>, <span class="st">'c'</span>]</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>fig1, ax1 <span class="op">=</span> plt.subplots()</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>fig2, ax2 <span class="op">=</span> plt.subplots()</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>):</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>  ax1.scatter(epoch_list,train_loss_history[i], color <span class="op">=</span> color[i],  label <span class="op">=</span> <span class="vs">r'$\alpha = $'</span> <span class="op">+</span> <span class="bu">str</span>(lr_params[i]))</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>  ax1.scatter(epoch_list,val_loss_history[i], marker <span class="op">=</span> <span class="st">'&gt;'</span>,color <span class="op">=</span> color[i])</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>  ax2.scatter(epoch_list,train_acc_history[i], color <span class="op">=</span> color[i], label <span class="op">=</span> <span class="vs">r'$\alpha = $'</span> <span class="op">+</span> <span class="bu">str</span>(lr_params[i]))</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>  ax2.scatter(epoch_list,val_acc_history[i], marker <span class="op">=</span> <span class="st">'&gt;'</span>,color <span class="op">=</span> color[i])</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'Epoch'</span>)</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'Loss'</span>)</span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>ax2.set_xlabel(<span class="st">'Epoch'</span>)</span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'Score'</span>)</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="vs">r'Loss: BWA Equal, Resnet18, $\gamma = 0.6$'</span>)</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="vs">r'Score: BWA Equal, Resnet18, $\gamma = 0.6$'</span>)</span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>ax1.legend()</span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>ax2.legend()</span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-48-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-48-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="visualizing-feature-maps-of-self-implemented-resnet18" class="level1">
<h1>Visualizing Feature Maps of Self-implemented Resnet18</h1>
<div class="cell" data-outputid="79c17522-202d-4582-fb72-24ce8a578218">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Code influenced from: https://debuggercafe.com/visualizing-filters-and-feature-maps-in-convolutional-neural-networks-using-pytorch/</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="co"># image dir: '/content/drive/Shareddrives/CheXpert-v1.0-small/train/patient00001/study1/view1_frontal.jpg'</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Patient used for demonstration: Patient00002 -&gt; Female, classified as white</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="co"># script dir: '/content/drive/Shareddrives/CheXpert-v1.0-small/filters_and_maps.py'</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile <span class="st">'/content/drive/Shareddrives/CheXpert-v1.0-small/filters_and_maps.py'</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2 <span class="im">as</span> cv</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> models, transforms</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>model_filename <span class="op">=</span> <span class="st">'/content/drive/Shareddrives/CheXpert-v1.0-small/self_resnet18_bwa_frontal_exp_lr(3).pth'</span></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>model_saved <span class="op">=</span> torchvision.models.resnet18(num_classes<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">'cuda:0'</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">'cpu'</span>)</span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>model_saved <span class="op">=</span> model_saved.to(device)</span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_model(filename, model, device):</span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">"""</span></span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a><span class="co">  Takes an untrained model as input, filename to saved model, and the device</span></span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a><span class="co">  """</span></span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a>  checkpoint <span class="op">=</span> checkpoint <span class="op">=</span> torch.load(filename, map_location<span class="op">=</span>device)</span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a>  model.load_state_dict(checkpoint[<span class="st">'model_state_dict'</span>],strict<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a>  model <span class="op">=</span> model.to(device)</span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> model</span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-35"><a href="#cb77-35" aria-hidden="true" tabindex="-1"></a>model_saved <span class="op">=</span> load_model(model_filename, model_saved, device)</span>
<span id="cb77-36"><a href="#cb77-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-37"><a href="#cb77-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Save layers and weights in an array</span></span>
<span id="cb77-38"><a href="#cb77-38" aria-hidden="true" tabindex="-1"></a>model_weights <span class="op">=</span> []</span>
<span id="cb77-39"><a href="#cb77-39" aria-hidden="true" tabindex="-1"></a>conv_layers <span class="op">=</span> []</span>
<span id="cb77-40"><a href="#cb77-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-41"><a href="#cb77-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Get all model children</span></span>
<span id="cb77-42"><a href="#cb77-42" aria-hidden="true" tabindex="-1"></a>model_children <span class="op">=</span> <span class="bu">list</span>(model_saved.children())</span>
<span id="cb77-43"><a href="#cb77-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-44"><a href="#cb77-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-45"><a href="#cb77-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve convolutional layers and their weights</span></span>
<span id="cb77-46"><a href="#cb77-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Counter to keep count of the conv layers</span></span>
<span id="cb77-47"><a href="#cb77-47" aria-hidden="true" tabindex="-1"></a>counter <span class="op">=</span> <span class="dv">0</span> </span>
<span id="cb77-48"><a href="#cb77-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Append all the conv layers and their respective weights to the list</span></span>
<span id="cb77-49"><a href="#cb77-49" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(model_children)):</span>
<span id="cb77-50"><a href="#cb77-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">type</span>(model_children[i]) <span class="op">==</span> nn.Conv2d:</span>
<span id="cb77-51"><a href="#cb77-51" aria-hidden="true" tabindex="-1"></a>        counter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb77-52"><a href="#cb77-52" aria-hidden="true" tabindex="-1"></a>        model_weights.append(model_children[i].weight)</span>
<span id="cb77-53"><a href="#cb77-53" aria-hidden="true" tabindex="-1"></a>        conv_layers.append(model_children[i])</span>
<span id="cb77-54"><a href="#cb77-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">type</span>(model_children[i]) <span class="op">==</span> nn.Sequential:</span>
<span id="cb77-55"><a href="#cb77-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(model_children[i])):</span>
<span id="cb77-56"><a href="#cb77-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> child <span class="kw">in</span> model_children[i][j].children():</span>
<span id="cb77-57"><a href="#cb77-57" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">type</span>(child) <span class="op">==</span> nn.Conv2d:</span>
<span id="cb77-58"><a href="#cb77-58" aria-hidden="true" tabindex="-1"></a>                    counter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb77-59"><a href="#cb77-59" aria-hidden="true" tabindex="-1"></a>                    model_weights.append(child.weight)</span>
<span id="cb77-60"><a href="#cb77-60" aria-hidden="true" tabindex="-1"></a>                    conv_layers.append(child)</span>
<span id="cb77-61"><a href="#cb77-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-62"><a href="#cb77-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualizing conv layer filters</span></span>
<span id="cb77-63"><a href="#cb77-63" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">20</span>))</span>
<span id="cb77-64"><a href="#cb77-64" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, <span class="bu">filter</span> <span class="kw">in</span> <span class="bu">enumerate</span>(model_weights[<span class="dv">0</span>]):</span>
<span id="cb77-65"><a href="#cb77-65" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">8</span>, <span class="dv">8</span>, i<span class="op">+</span><span class="dv">1</span>) <span class="co"># (8, 8) because in conv0 we have 7x7 filters and total of 64 (see printed shapes)</span></span>
<span id="cb77-66"><a href="#cb77-66" aria-hidden="true" tabindex="-1"></a>    plt.imshow(<span class="bu">filter</span>[<span class="dv">0</span>, :, :].detach().cpu().numpy(), cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb77-67"><a href="#cb77-67" aria-hidden="true" tabindex="-1"></a>    plt.axis(<span class="st">'off'</span>)</span>
<span id="cb77-68"><a href="#cb77-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store image in project directory</span></span>
<span id="cb77-69"><a href="#cb77-69" aria-hidden="true" tabindex="-1"></a>    images_dir <span class="op">=</span> <span class="st">"/content/drive/Shareddrives/CheXpert-v1.0-small/outputs/white"</span></span>
<span id="cb77-70"><a href="#cb77-70" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="ss">f"</span><span class="sc">{</span>images_dir<span class="sc">}</span><span class="ss">/filter.png"</span>)</span>
<span id="cb77-71"><a href="#cb77-71" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb77-72"><a href="#cb77-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-73"><a href="#cb77-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading image and defining transforms</span></span>
<span id="cb77-74"><a href="#cb77-74" aria-hidden="true" tabindex="-1"></a>image_dir <span class="op">=</span> <span class="st">'/content/drive/Shareddrives/CheXpert-v1.0-small/train/patient00002/study1/view1_frontal.jpg'</span></span>
<span id="cb77-75"><a href="#cb77-75" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> cv.imread(image_dir)</span>
<span id="cb77-76"><a href="#cb77-76" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> cv.cvtColor(img, cv.COLOR_BGR2RGB)</span>
<span id="cb77-77"><a href="#cb77-77" aria-hidden="true" tabindex="-1"></a>plt.imshow(img)</span>
<span id="cb77-78"><a href="#cb77-78" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb77-79"><a href="#cb77-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-80"><a href="#cb77-80" aria-hidden="true" tabindex="-1"></a><span class="co"># define the transforms</span></span>
<span id="cb77-81"><a href="#cb77-81" aria-hidden="true" tabindex="-1"></a>transform <span class="op">=</span> transforms.Compose([</span>
<span id="cb77-82"><a href="#cb77-82" aria-hidden="true" tabindex="-1"></a>    transforms.ToPILImage(),</span>
<span id="cb77-83"><a href="#cb77-83" aria-hidden="true" tabindex="-1"></a>    transforms.Resize((<span class="dv">512</span>, <span class="dv">512</span>)),</span>
<span id="cb77-84"><a href="#cb77-84" aria-hidden="true" tabindex="-1"></a>    transforms.ToTensor(),</span>
<span id="cb77-85"><a href="#cb77-85" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb77-86"><a href="#cb77-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-87"><a href="#cb77-87" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> np.array(img)</span>
<span id="cb77-88"><a href="#cb77-88" aria-hidden="true" tabindex="-1"></a><span class="co"># apply the transforms</span></span>
<span id="cb77-89"><a href="#cb77-89" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> transform(img)</span>
<span id="cb77-90"><a href="#cb77-90" aria-hidden="true" tabindex="-1"></a><span class="co"># print(img.size())</span></span>
<span id="cb77-91"><a href="#cb77-91" aria-hidden="true" tabindex="-1"></a><span class="co"># unsqueeze to add a batch dimension</span></span>
<span id="cb77-92"><a href="#cb77-92" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> img.unsqueeze(<span class="dv">0</span>)</span>
<span id="cb77-93"><a href="#cb77-93" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(img.size())</span>
<span id="cb77-94"><a href="#cb77-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-95"><a href="#cb77-95" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> img.to(device)</span>
<span id="cb77-96"><a href="#cb77-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-97"><a href="#cb77-97" aria-hidden="true" tabindex="-1"></a><span class="co"># Passing input through each conv layer</span></span>
<span id="cb77-98"><a href="#cb77-98" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> [conv_layers[<span class="dv">0</span>](img)]</span>
<span id="cb77-99"><a href="#cb77-99" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(conv_layers)):</span>
<span id="cb77-100"><a href="#cb77-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pass the result from the last layer to the next layer</span></span>
<span id="cb77-101"><a href="#cb77-101" aria-hidden="true" tabindex="-1"></a>    results.append(conv_layers[i](results[<span class="op">-</span><span class="dv">1</span>]))</span>
<span id="cb77-102"><a href="#cb77-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-103"><a href="#cb77-103" aria-hidden="true" tabindex="-1"></a><span class="co"># make a copy of the `results`</span></span>
<span id="cb77-104"><a href="#cb77-104" aria-hidden="true" tabindex="-1"></a>outputs <span class="op">=</span> results</span>
<span id="cb77-105"><a href="#cb77-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-106"><a href="#cb77-106" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualizing feature map</span></span>
<span id="cb77-107"><a href="#cb77-107" aria-hidden="true" tabindex="-1"></a><span class="co"># (although there are more feature maps in the upper layers)</span></span>
<span id="cb77-108"><a href="#cb77-108" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> num_layer <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(outputs)):</span>
<span id="cb77-109"><a href="#cb77-109" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">17</span>))</span>
<span id="cb77-110"><a href="#cb77-110" aria-hidden="true" tabindex="-1"></a>    layer_viz <span class="op">=</span> outputs[num_layer][<span class="dv">0</span>, :, :, :]</span>
<span id="cb77-111"><a href="#cb77-111" aria-hidden="true" tabindex="-1"></a>    layer_viz <span class="op">=</span> layer_viz.data</span>
<span id="cb77-112"><a href="#cb77-112" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(layer_viz.size())</span>
<span id="cb77-113"><a href="#cb77-113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, <span class="bu">filter</span> <span class="kw">in</span> <span class="bu">enumerate</span>(layer_viz):</span>
<span id="cb77-114"><a href="#cb77-114" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">==</span> <span class="dv">64</span>: <span class="co"># we will visualize only 8x8 blocks from each layer</span></span>
<span id="cb77-115"><a href="#cb77-115" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb77-116"><a href="#cb77-116" aria-hidden="true" tabindex="-1"></a>        plt.subplot(<span class="dv">8</span>, <span class="dv">8</span>, i <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb77-117"><a href="#cb77-117" aria-hidden="true" tabindex="-1"></a>        plt.imshow(<span class="bu">filter</span>.cpu(), cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb77-118"><a href="#cb77-118" aria-hidden="true" tabindex="-1"></a>        plt.axis(<span class="st">"off"</span>)</span>
<span id="cb77-119"><a href="#cb77-119" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Saving layer </span><span class="sc">{</span>num_layer<span class="sc">}</span><span class="ss"> feature maps..."</span>)</span>
<span id="cb77-120"><a href="#cb77-120" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="ss">f"/content/drive/Shareddrives/CheXpert-v1.0-small/outputs/white/layer </span><span class="sc">{</span>num_layer<span class="sc">}</span><span class="ss">.png"</span>)</span>
<span id="cb77-121"><a href="#cb77-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plt.show()</span></span>
<span id="cb77-122"><a href="#cb77-122" aria-hidden="true" tabindex="-1"></a>    plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overwriting /content/drive/Shareddrives/CheXpert-v1.0-small/filters_and_maps.py</code></pre>
</div>
</div>
<div class="cell" data-outputid="64eca411-ec85-42c9-8bdc-154da1cb3dcd">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>python <span class="st">'/content/drive/Shareddrives/CheXpert-v1.0-small/filters_and_maps.py'</span> <span class="op">--</span>image <span class="st">'/content/drive/Shareddrives/CheXpert-v1.0-small/train/patient00002/study1/view1_frontal.jpg'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Figure(2000x2000)
Figure(640x480)
torch.Size([1, 3, 512, 512])
torch.Size([64, 256, 256])
Saving layer 0 feature maps...
torch.Size([64, 256, 256])
Saving layer 1 feature maps...
torch.Size([64, 256, 256])
Saving layer 2 feature maps...
torch.Size([64, 256, 256])
Saving layer 3 feature maps...
torch.Size([64, 256, 256])
Saving layer 4 feature maps...
torch.Size([128, 128, 128])
Saving layer 5 feature maps...
torch.Size([128, 128, 128])
Saving layer 6 feature maps...
torch.Size([128, 128, 128])
Saving layer 7 feature maps...
torch.Size([128, 128, 128])
Saving layer 8 feature maps...
torch.Size([256, 64, 64])
Saving layer 9 feature maps...
torch.Size([256, 64, 64])
Saving layer 10 feature maps...
torch.Size([256, 64, 64])
Saving layer 11 feature maps...
torch.Size([256, 64, 64])
Saving layer 12 feature maps...
torch.Size([512, 32, 32])
Saving layer 13 feature maps...
torch.Size([512, 32, 32])
Saving layer 14 feature maps...
torch.Size([512, 32, 32])
Saving layer 15 feature maps...
torch.Size([512, 32, 32])
Saving layer 16 feature maps...</code></pre>
</div>
</div>
<div class="cell" data-outputid="e4d3a98b-22bc-4992-cdef-0a175f5a0b9a">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>lr_params <span class="op">=</span> [<span class="fl">0.0001</span>,<span class="fl">0.001</span>,<span class="fl">0.005</span>,<span class="fl">0.01</span>]</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>epoch_list <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">15</span>)]</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>color <span class="op">=</span> [<span class="st">'b'</span>, <span class="st">'g'</span>, <span class="st">'r'</span>, <span class="st">'c'</span>]</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>fig1, ax1 <span class="op">=</span> plt.subplots()</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>fig2, ax2 <span class="op">=</span> plt.subplots()</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>):</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>  ax1.scatter(epoch_list,train_loss_history[i], color <span class="op">=</span> color[i],  label <span class="op">=</span> <span class="vs">r'$\alpha = $'</span> <span class="op">+</span> <span class="bu">str</span>(lr_params[i]))</span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>  ax1.scatter(epoch_list,val_loss_history[i], marker <span class="op">=</span> <span class="st">'&gt;'</span>,color <span class="op">=</span> color[i])</span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>  ax2.scatter(epoch_list,train_acc_history[i], color <span class="op">=</span> color[i], label <span class="op">=</span> <span class="vs">r'$\alpha = $'</span> <span class="op">+</span> <span class="bu">str</span>(lr_params[i]))</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>  ax2.scatter(epoch_list,val_acc_history[i], marker <span class="op">=</span> <span class="st">'&gt;'</span>,color <span class="op">=</span> color[i])</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'Epoch'</span>)</span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'Loss'</span>)</span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>ax2.set_xlabel(<span class="st">'Epoch'</span>)</span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'Score'</span>)</span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="vs">r'Loss: BWA Equal, Resnet18, $\gamma = 0.9$'</span>)</span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="vs">r'Score: BWA Equal, Resnet18, $\gamma = 0.9$'</span>)</span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>ax1.legend()</span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>ax2.legend()</span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-51-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-51-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Just for safety I’ve commented out the destination filenames</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>torch.save({</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>                <span class="st">'epoch'</span>: <span class="dv">15</span>,</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>                <span class="st">'model_state_dict'</span>: model.state_dict()</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>                }, <span class="ss">f"/content/drive/Shareddrives/CheXpert-v1.0-small/resnet18_bwa_frontal_gamma09.pth"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co">#save the losses</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>torch.save({<span class="st">"train_loss_history"</span>: train_loss_history, <span class="st">"train_acc_history"</span>:train_acc_history, <span class="st">"val_loss_history"</span>: val_loss_history, <span class="st">"val_acc_history"</span>: val_acc_history}, <span class="st">'/content/drive/Shareddrives/CheXpert-v1.0-small/resnet18_bwa_frontal_gamma09.pt'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="a02f0da6-ef82-41c7-c872-f17760b78458">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="co">#loss_file = '/content/drive/Shareddrives/CheXpert-v1.0-small/efficientb0_10000_losses.pt'</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>loss_file <span class="op">=</span> <span class="st">'/content/drive/Shareddrives/CheXpert-v1.0-small/efficientb0_10000_bwa_equal_exponential_scheduler_losses.pt'</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>loss_dict <span class="op">=</span> torch.load(loss_file,map_location<span class="op">=</span>torch.device(<span class="st">'cpu'</span>))</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>train_loss_history_file <span class="op">=</span> loss_dict[<span class="st">'train_loss_history'</span>]</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>val_loss_history_file <span class="op">=</span> loss_dict[<span class="st">'val_loss_history'</span>]</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>train_acc_history_file <span class="op">=</span> loss_dict[<span class="st">'train_acc_history'</span>]</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>val_acc_history_file <span class="op">=</span> loss_dict[<span class="st">'val_acc_history'</span>]</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>epoch_list <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">15</span>)]</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>plt.scatter(epoch_list,train_loss_history_file,c<span class="op">=</span><span class="st">'Red'</span>, label <span class="op">=</span> <span class="st">'Training loss'</span>)</span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>plt.scatter(epoch_list,val_loss_history_file,c<span class="op">=</span><span class="st">'Green'</span>, label <span class="op">=</span> <span class="st">'Validation loss'</span>)</span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Epoch'</span>)</span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Loss'</span>)</span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="vs">r'Loss: BWA Equal with Exponential Scheduler, $\gamma=0.735$'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="73">
<pre><code>Text(0.5, 1.0, 'Loss: BWA Equal with Exponential Scheduler, $\\gamma=0.735$')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-54-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="1f34c151-dd73-411f-81ac-cc57e9850056">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(epoch_list,train_acc_history_file,c<span class="op">=</span><span class="st">'Red'</span>, label <span class="op">=</span> <span class="st">'Training Score'</span>)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>plt.scatter(epoch_list,val_acc_history_file,c<span class="op">=</span><span class="st">'Green'</span>, label <span class="op">=</span> <span class="st">'Validation Score'</span>)</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Epoch'</span>)</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Accuracy'</span>)</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="vs">r'Accuracy: BWA Equal with Exponential Scheduler, $\gamma=0.735$'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="74">
<pre><code>Text(0.5, 1.0, 'Accuracy: BWA Equal with Exponential Scheduler, $\\gamma=0.735$')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-55-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="099fcb49-090c-4f96-8042-6919e9c77532">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>loss_file <span class="op">=</span> <span class="st">'/content/drive/Shareddrives/CheXpert-v1.0-small/efficientb0_10000_losses.pt'</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="co">#loss_file = '/content/drive/Shareddrives/CheXpert-v1.0-small/efficientb0_10000_bwa_equal_exponential_scheduler_losses.pt'</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>loss_dict <span class="op">=</span> torch.load(loss_file,map_location<span class="op">=</span>torch.device(<span class="st">'cpu'</span>))</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>train_loss_history_file <span class="op">=</span> loss_dict[<span class="st">'train_loss_history'</span>]</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>val_loss_history_file <span class="op">=</span> loss_dict[<span class="st">'val_loss_history'</span>]</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>train_acc_history_file <span class="op">=</span> loss_dict[<span class="st">'train_acc_history'</span>]</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>val_acc_history_file <span class="op">=</span> loss_dict[<span class="st">'val_acc_history'</span>]</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>epoch_list <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">12</span>)]</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>plt.scatter(epoch_list,train_loss_history_file,c<span class="op">=</span><span class="st">'Red'</span>, label <span class="op">=</span> <span class="st">'Training loss'</span>)</span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>plt.scatter(epoch_list,val_loss_history_file,c<span class="op">=</span><span class="st">'Green'</span>, label <span class="op">=</span> <span class="st">'Validation loss'</span>)</span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Epoch'</span>)</span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Loss'</span>)</span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Loss: BWA Equal with Learning Plateau Scheduler'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="75">
<pre><code>Text(0.5, 1.0, 'Loss: BWA Equal with Learning Plateau Scheduler')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-56-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="a3dd5b52-8968-4d8a-9856-f0c406eacd65">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(epoch_list,train_acc_history_file,c<span class="op">=</span><span class="st">'Red'</span>, label <span class="op">=</span> <span class="st">'Training Score'</span>)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>plt.scatter(epoch_list,val_acc_history_file,c<span class="op">=</span><span class="st">'Green'</span>, label <span class="op">=</span> <span class="st">'Validation Score'</span>)</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Epoch'</span>)</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Score'</span>)</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Score: BWA Equal with Learning Plateau Scheduler'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="76">
<pre><code>Text(0.5, 1.0, 'Score: BWA Equal with Learning Plateau Scheduler')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-57-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="7a876a80-2880-4801-f4ba-6656160b41da">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>loss_file <span class="op">=</span> <span class="st">'/content/drive/Shareddrives/CheXpert-v1.0-small/efficientb0_10000_bwa_equal_exponential_scheduler_losses(2).pt'</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>loss_dict <span class="op">=</span> torch.load(loss_file,map_location<span class="op">=</span>torch.device(<span class="st">'cpu'</span>))</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>train_loss_history_file <span class="op">=</span> loss_dict[<span class="st">'train_loss_history'</span>]</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>val_loss_history_file <span class="op">=</span> loss_dict[<span class="st">'val_loss_history'</span>]</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>train_acc_history_file <span class="op">=</span> loss_dict[<span class="st">'train_acc_history'</span>]</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>val_acc_history_file <span class="op">=</span> loss_dict[<span class="st">'val_acc_history'</span>]</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>epoch_list <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">15</span>)]</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>plt.scatter(epoch_list,train_loss_history_file,c<span class="op">=</span><span class="st">'Red'</span>, label <span class="op">=</span> <span class="st">'Training loss'</span>)</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>plt.scatter(epoch_list,val_loss_history_file,c<span class="op">=</span><span class="st">'Green'</span>, label <span class="op">=</span> <span class="st">'Validation loss'</span>)</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Epoch'</span>)</span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Loss'</span>)</span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="vs">r'Loss: BWA Equal with Exponential Scheduler, $\gamma=0.8$'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="79">
<pre><code>Text(0.5, 1.0, 'Loss: BWA Equal with Exponential Scheduler, $\\gamma=0.8$')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-58-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="d1037281-d732-4ff3-b72f-44f6d2e4b442">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(epoch_list,train_acc_history_file,c<span class="op">=</span><span class="st">'Red'</span>, label <span class="op">=</span> <span class="st">'Training Score'</span>)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>plt.scatter(epoch_list,val_acc_history_file,c<span class="op">=</span><span class="st">'Green'</span>, label <span class="op">=</span> <span class="st">'Validation Score'</span>)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Epoch'</span>)</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Accuracy'</span>)</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="vs">r'Accuracy: BWA Equal with Exponential Scheduler, $\gamma=0.8$'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="80">
<pre><code>Text(0.5, 1.0, 'Accuracy: BWA Equal with Exponential Scheduler, $\\gamma=0.8$')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-59-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>So maybe we should ignore the model without a scheduler in our analysis because of its erratic loss evolution.</p>
<div class="cell" data-outputid="4fc9d3e2-aead-45e6-f89d-8131f48ffb43">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>df_test_bwa_equal_male <span class="op">=</span> df_test_bwa_equal_frontal[df_test_bwa_equal_frontal[<span class="st">'Sex'</span>] <span class="op">==</span> <span class="st">'Male'</span>]</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>df_test_bwa_equal_female <span class="op">=</span> df_test_bwa_equal_frontal[df_test_bwa_equal_frontal[<span class="st">'Sex'</span>] <span class="op">==</span> <span class="st">'Female'</span>]</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>df_test_bwa_equal_female</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">


  <div id="df-3524e6f4-0188-4b87-aaa7-7ef2059b6f21">
    <div class="colab-df-container">
      <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Unnamed: 0.1</th>
      <th>Unnamed: 0</th>
      <th>Path</th>
      <th>Sex</th>
      <th>Age</th>
      <th>Frontal/Lateral</th>
      <th>AP/PA</th>
      <th>No Finding</th>
      <th>Enlarged Cardiomediastinum</th>
      <th>Cardiomegaly</th>
      <th>...</th>
      <th>Pleural Effusion</th>
      <th>Pleural Other</th>
      <th>Fracture</th>
      <th>Support Devices</th>
      <th>PATIENT</th>
      <th>GENDER</th>
      <th>AGE_AT_CXR</th>
      <th>PRIMARY_RACE</th>
      <th>ETHNICITY</th>
      <th>RACE_NUM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>3766</td>
      <td>104243</td>
      <td>CheXpert-v1.0-small/train/patient25254/study4/...</td>
      <td>Female</td>
      <td>90</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient25254</td>
      <td>Female</td>
      <td>92</td>
      <td>Black or African American</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>9666</td>
      <td>112659</td>
      <td>CheXpert-v1.0-small/train/patient27288/study2/...</td>
      <td>Female</td>
      <td>41</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>patient27288</td>
      <td>Female</td>
      <td>42</td>
      <td>Black, non-Hispanic</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>1</td>
    </tr>
    <tr>
      <th>11</th>
      <td>12601</td>
      <td>116650</td>
      <td>CheXpert-v1.0-small/train/patient28228/study1/...</td>
      <td>Female</td>
      <td>21</td>
      <td>Frontal</td>
      <td>PA</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient28228</td>
      <td>Female</td>
      <td>19</td>
      <td>Black or African American</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>1</td>
    </tr>
    <tr>
      <th>16</th>
      <td>536</td>
      <td>99614</td>
      <td>CheXpert-v1.0-small/train/patient24193/study5/...</td>
      <td>Female</td>
      <td>90</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>patient24193</td>
      <td>Female</td>
      <td>101</td>
      <td>White</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>0</td>
    </tr>
    <tr>
      <th>19</th>
      <td>1032</td>
      <td>100253</td>
      <td>CheXpert-v1.0-small/train/patient24344/study12...</td>
      <td>Female</td>
      <td>37</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>patient24344</td>
      <td>Female</td>
      <td>37</td>
      <td>Asian</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>2</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2985</th>
      <td>1366</td>
      <td>100729</td>
      <td>CheXpert-v1.0-small/train/patient24431/study1/...</td>
      <td>Female</td>
      <td>74</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient24431</td>
      <td>Female</td>
      <td>74</td>
      <td>Asian</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2986</th>
      <td>7206</td>
      <td>109367</td>
      <td>CheXpert-v1.0-small/train/patient26501/study3/...</td>
      <td>Female</td>
      <td>53</td>
      <td>Frontal</td>
      <td>PA</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>patient26501</td>
      <td>Female</td>
      <td>55</td>
      <td>Black or African American</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2995</th>
      <td>1237</td>
      <td>100534</td>
      <td>CheXpert-v1.0-small/train/patient24400/study1/...</td>
      <td>Female</td>
      <td>29</td>
      <td>Frontal</td>
      <td>PA</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient24400</td>
      <td>Female</td>
      <td>29</td>
      <td>Asian</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2996</th>
      <td>4244</td>
      <td>104980</td>
      <td>CheXpert-v1.0-small/train/patient25459/study1/...</td>
      <td>Female</td>
      <td>31</td>
      <td>Frontal</td>
      <td>PA</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>patient25459</td>
      <td>Female</td>
      <td>31</td>
      <td>Black, non-Hispanic</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2997</th>
      <td>2001</td>
      <td>101622</td>
      <td>CheXpert-v1.0-small/train/patient24646/study4/...</td>
      <td>Female</td>
      <td>57</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient24646</td>
      <td>Female</td>
      <td>50</td>
      <td>Black or African American</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
<p>932 rows × 27 columns</p>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-3524e6f4-0188-4b87-aaa7-7ef2059b6f21')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-3524e6f4-0188-4b87-aaa7-7ef2059b6f21 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-3524e6f4-0188-4b87-aaa7-7ef2059b6f21');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<div class="cell" data-outputid="d4a3fb2c-8959-4c85-8226-bf1a612e9347">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>model_filename <span class="op">=</span> <span class="st">'/content/drive/Shareddrives/CheXpert-v1.0-small/efficientb0_10000_bwa_equal_exponential_scheduler.pth'</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>model_saved <span class="op">=</span> EfficientNet.from_pretrained(<span class="st">'efficientnet-b0'</span>,num_classes<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>checkpoint <span class="op">=</span> torch.load(model_filename, map_location<span class="op">=</span>device)</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Loading trained model weights...'</span>)</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>model_saved.load_state_dict(checkpoint[<span class="st">'model_state_dict'</span>],strict<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>model_saved <span class="op">=</span> model_saved.to(device)</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>test_dataset_male <span class="op">=</span> ChestXrayDataset(<span class="st">"/content/drive/Shareddrives/"</span>, df_test_bwa_equal_male[:<span class="dv">500</span>], IMAGE_SIZE, <span class="va">True</span>)</span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>test_dataloader_male <span class="op">=</span> DataLoader(dataset<span class="op">=</span>test_dataset_male, batch_size<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">False</span>, num_workers<span class="op">=</span><span class="dv">2</span>, pin_memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>test_dataset_female <span class="op">=</span> ChestXrayDataset(<span class="st">"/content/drive/Shareddrives/"</span>, df_test_bwa_equal_female[:<span class="dv">500</span>], IMAGE_SIZE, <span class="va">True</span>)</span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>test_dataloader_female <span class="op">=</span> DataLoader(dataset<span class="op">=</span>test_dataset_female, batch_size<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">False</span>, num_workers<span class="op">=</span><span class="dv">2</span>, pin_memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a>y_pred_enet_male, y_true_enet_male <span class="op">=</span> test(model_saved,test_dataloader_male)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: "https://github.com/lukemelas/EfficientNet-PyTorch/releases/download/1.0/efficientnet-b0-355c32eb.pth" to /root/.cache/torch/hub/checkpoints/efficientnet-b0-355c32eb.pth
100%|██████████| 20.4M/20.4M [00:00&lt;00:00, 22.2MB/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded pretrained weights for efficientnet-b0
Loading trained model weights...</code></pre>
</div>
<div class="cell-output cell-output-error">
<pre><code>NameError: ignored</code></pre>
</div>
</div>
<div class="cell" data-outputid="c42ddc67-aa97-439f-b221-5545baee3e1b">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>cf_matrix <span class="op">=</span> confusion_matrix(y_true_enet_male, y_pred_enet_male)</span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cf_matrix)</span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>classes <span class="op">=</span> [<span class="st">'White'</span>,<span class="st">'Black'</span>,<span class="st">'Asian'</span>]</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>df_cm <span class="op">=</span> pd.DataFrame(cf_matrix <span class="op">/</span> np.<span class="bu">sum</span>(cf_matrix, axis<span class="op">=</span><span class="dv">1</span>)[:, <span class="va">None</span>], index <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> classes],</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>                     columns <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> classes])</span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize <span class="op">=</span> (<span class="dv">12</span>,<span class="dv">7</span>))</span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="vs">r'Confusion matrix: BWA Equal with Exponential Scheduler, $\gamma = 0.735$, Male'</span>)</span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>sns.heatmap(df_cm, annot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">'output.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[159  26  22]
 [ 27 101   7]
 [ 23  13 122]]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Exception ignored in: &lt;function _ConnectionBase.__del__ at 0x7f1875e66dd0&gt;
Traceback (most recent call last):
  File "/usr/lib/python3.10/multiprocessing/connection.py", line 132, in __del__
    self._close()
  File "/usr/lib/python3.10/multiprocessing/connection.py", line 361, in _close
    _close(self._handle)
OSError: [Errno 9] Bad file descriptor</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-62-output-3.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="5991c9cb-9ab6-4db1-c6a8-662274f9e9ca">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>y_pred_enet_female, y_true_enet_female <span class="op">=</span> test(model_saved,test_dataloader_female)</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>cf_matrix <span class="op">=</span> confusion_matrix(y_true_enet_female, y_pred_enet_female)</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cf_matrix)</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>classes <span class="op">=</span> [<span class="st">'White'</span>,<span class="st">'Black'</span>,<span class="st">'Asian'</span>]</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>df_cm <span class="op">=</span> pd.DataFrame(cf_matrix <span class="op">/</span> np.<span class="bu">sum</span>(cf_matrix, axis<span class="op">=</span><span class="dv">1</span>)[:, <span class="va">None</span>], index <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> classes],</span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>                     columns <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> classes])</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize <span class="op">=</span> (<span class="dv">12</span>,<span class="dv">7</span>))</span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="vs">r'Confusion matrix: BWA Equal with Exponential Scheduler, $\gamma = 0.735$, Female'</span>)</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>sns.heatmap(df_cm, annot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">'output.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tensor([1, 1, 1, 0, 2, 2, 1, 1, 2, 2, 1, 2, 0, 2, 1, 0, 0, 1, 1, 0, 2, 0, 2, 2,
        1, 2, 1, 0, 1, 0, 0, 1, 1, 0, 2, 0, 1, 2, 1, 1, 1, 0, 2, 1, 2, 1, 1, 0,
        1, 2, 1, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 2, 0, 1, 1, 2, 2, 1, 1, 2, 1, 0,
        0, 0, 2, 0, 1, 0, 1, 2, 1, 0, 2, 2, 0, 2, 1, 1, 0, 0, 2, 1, 2, 1, 1, 2,
        1, 2, 1, 2, 1, 2, 1, 0, 2, 1, 1, 1, 0, 0, 1, 0, 1, 2, 1, 0, 0, 1, 1, 2,
        2, 2, 0, 1, 0, 1, 2, 1, 1, 1, 2, 1, 0, 1, 2, 1, 1, 2, 2, 1, 1, 2, 1, 2,
        2, 2, 1, 1, 1, 2, 1, 2, 0, 2, 1, 0, 2, 2, 1, 1, 0, 2, 1, 1, 0, 2, 1, 2,
        1, 0, 2, 2, 0, 2, 0, 1, 2, 2, 1, 0, 1, 0, 1, 1, 2, 2, 2, 0, 1, 2, 2, 2,
        0, 2, 0, 1, 0, 1, 2, 0, 1, 2, 0, 2, 0, 0, 0, 1, 0, 1, 2, 0, 2, 1, 1, 2,
        1, 1, 0, 1, 2, 2, 2, 0, 1, 2, 0, 0, 0, 0, 0, 1, 0, 2, 1, 1, 1, 2, 0, 2,
        0, 1, 0, 2, 0, 2, 0, 0, 2, 0, 1, 0, 2, 0, 1, 0, 1, 0, 1, 1, 1, 0, 1, 1,
        1, 2, 0, 1, 2, 1, 1, 2, 0, 2, 1, 1, 0, 0, 1, 1, 2, 2, 1, 2, 2, 0, 1, 2,
        2, 1, 1, 2, 1, 1, 1, 1, 2, 2, 1, 0, 1, 1, 0, 0, 2, 0, 0, 0, 2, 0, 1, 0,
        1, 2, 1, 1, 0, 1, 1, 2, 2, 1, 2, 0, 1, 0, 2, 2, 2, 0, 1, 1, 2, 0, 0, 1,
        0, 1, 1, 2, 2, 1, 0, 1, 0, 1, 1, 2, 1, 0, 2, 2, 1, 2, 2, 1, 2, 1, 2, 1,
        1, 1, 1, 2, 1, 2, 2, 1, 2, 2, 0, 0, 2, 1, 2, 2, 1, 0, 2, 1, 1, 1, 0, 0,
        0, 2, 1, 1, 1, 1, 1, 1, 2, 2, 2, 1, 1, 2, 0, 0, 2, 2, 1, 1, 1, 0, 0, 2,
        2, 0, 1, 0, 0, 0, 2, 0, 2, 1, 2, 2, 1, 2, 2, 1, 0, 0, 2, 1, 1, 2, 2, 1,
        1, 2, 1, 1, 1, 0, 1, 2, 1, 0, 2, 2, 1, 0, 0, 0, 0, 2, 2, 1, 2, 0, 2, 1,
        2, 0, 1, 0, 1, 1, 2, 1, 1, 2, 2, 1, 2, 1, 0, 2, 2, 0, 1, 1, 1, 2, 2, 2,
        2, 2, 2, 0, 1, 0, 2, 2, 1, 2, 0, 2, 2, 1, 2, 1, 1, 1, 2, 1],
       device='cuda:0')
predicted:  tensor([1, 1, 1, 0, 2, 2, 1, 0, 2, 2, 1, 2, 0, 2, 1, 2, 2, 1, 1, 0, 2, 0, 2, 0,
        0, 0, 1, 0, 1, 0, 1, 0, 1, 0, 0, 2, 1, 2, 0, 1, 1, 0, 2, 0, 2, 1, 1, 0,
        0, 2, 1, 2, 2, 1, 1, 2, 2, 2, 2, 2, 2, 0, 2, 1, 0, 2, 2, 1, 2, 2, 1, 0,
        0, 0, 2, 1, 1, 0, 0, 2, 1, 0, 2, 2, 0, 2, 1, 1, 0, 0, 2, 1, 2, 1, 1, 2,
        1, 2, 2, 2, 1, 2, 1, 2, 2, 1, 1, 1, 1, 2, 1, 1, 1, 2, 1, 0, 0, 0, 1, 2,
        2, 1, 0, 0, 0, 1, 0, 1, 1, 1, 2, 1, 0, 1, 2, 1, 0, 2, 0, 2, 1, 2, 1, 2,
        1, 2, 0, 1, 0, 2, 1, 2, 0, 0, 1, 0, 2, 2, 0, 1, 0, 1, 1, 1, 1, 2, 1, 2,
        1, 0, 2, 1, 0, 0, 0, 0, 2, 2, 1, 0, 0, 0, 0, 1, 2, 2, 2, 0, 1, 2, 2, 0,
        0, 2, 0, 1, 0, 1, 0, 0, 1, 2, 2, 0, 2, 0, 0, 1, 1, 1, 2, 2, 0, 1, 2, 2,
        2, 0, 0, 0, 2, 0, 2, 2, 1, 1, 0, 0, 1, 0, 0, 1, 0, 2, 0, 1, 1, 2, 0, 2,
        0, 1, 0, 1, 2, 0, 0, 2, 2, 0, 1, 0, 1, 2, 2, 0, 1, 0, 1, 0, 1, 2, 1, 1,
        1, 2, 0, 1, 1, 1, 1, 2, 2, 0, 1, 2, 2, 0, 0, 1, 1, 2, 1, 2, 0, 0, 2, 2,
        2, 1, 2, 2, 1, 1, 1, 2, 2, 0, 0, 0, 0, 1, 2, 0, 2, 0, 2, 0, 2, 0, 1, 0,
        1, 2, 1, 0, 0, 1, 1, 2, 2, 1, 0, 1, 1, 2, 2, 2, 2, 0, 2, 0, 2, 0, 0, 1,
        0, 1, 1, 2, 2, 2, 0, 1, 2, 1, 1, 0, 1, 0, 2, 2, 1, 2, 2, 1, 2, 1, 2, 0,
        2, 1, 1, 1, 1, 2, 2, 1, 2, 2, 0, 0, 2, 0, 2, 2, 1, 2, 2, 1, 1, 1, 0, 0,
        1, 2, 1, 1, 1, 1, 1, 1, 0, 2, 2, 1, 1, 2, 0, 0, 1, 2, 1, 1, 1, 0, 2, 1,
        0, 0, 1, 0, 0, 1, 0, 0, 2, 1, 2, 2, 1, 2, 1, 0, 0, 0, 2, 1, 1, 2, 2, 1,
        0, 2, 1, 1, 1, 0, 1, 2, 1, 0, 0, 2, 1, 2, 0, 0, 0, 2, 2, 1, 2, 1, 0, 1,
        2, 2, 0, 2, 0, 1, 2, 0, 1, 1, 2, 0, 1, 1, 0, 0, 0, 1, 0, 1, 1, 0, 2, 2,
        2, 2, 2, 2, 1, 0, 0, 2, 1, 2, 0, 0, 2, 2, 2, 1, 1, 0, 2, 1],
       device='cuda:0')
Test accuracy: 73 %
[[ 88  12  26]
 [ 36 148  14]
 [ 29  15 132]]</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-63-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Bias for the set that Jay-U trained the 0.735 scheduler model on.</p>
<div class="cell" data-outputid="6601c971-7ecb-4793-ddbe-907bde8485a3">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>df_check <span class="op">=</span> df_train_bwa_equal[:<span class="dv">10000</span>]</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>df_male <span class="op">=</span> df_check[df_check[<span class="st">'Sex'</span>] <span class="op">==</span> <span class="st">'Male'</span>]</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>df_female <span class="op">=</span> df_check[df_check[<span class="st">'Sex'</span>] <span class="op">==</span> <span class="st">'Female'</span>]</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>male_no <span class="op">=</span> <span class="bu">len</span>(df_male)</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>fem_no <span class="op">=</span> <span class="bu">len</span>(df_female)</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>male_ratio <span class="op">=</span> male_no<span class="op">/</span>(male_no<span class="op">+</span>fem_no)<span class="op">*</span><span class="dv">100</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>fem_ratio <span class="op">=</span> fem_no<span class="op">/</span>(male_no<span class="op">+</span>fem_no)<span class="op">*</span><span class="dv">100</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Ratio of men to women in the training set for the model with the 0.735 gamma scheduler is: '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(male_no<span class="op">/</span>fem_no, <span class="dv">3</span>)) <span class="op">+</span> <span class="st">', or '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(male_ratio, <span class="dv">3</span>)) <span class="op">+</span> <span class="st">'% men and '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(fem_ratio, <span class="dv">3</span>)) <span class="op">+</span><span class="st">'% women.'</span>)</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>frontal_male <span class="op">=</span> <span class="bu">len</span>(df_male[df_male[<span class="st">'Path'</span>].<span class="bu">str</span>.contains(<span class="st">'frontal'</span>)])<span class="op">/</span>male_no</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>frontal_female <span class="op">=</span> <span class="bu">len</span>(df_female[df_female[<span class="st">'Path'</span>].<span class="bu">str</span>.contains(<span class="st">'frontal'</span>)])<span class="op">/</span>fem_no</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'There are on average '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(frontal_male, <span class="dv">3</span>)) <span class="op">+</span> <span class="st">' frontal images for each male patient, and '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(frontal_female, <span class="dv">3</span>)) <span class="op">+</span> <span class="st">' for each female patient.'</span>)</span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>lateral_male <span class="op">=</span> <span class="bu">len</span>(df_male[df_male[<span class="st">'Path'</span>].<span class="bu">str</span>.contains(<span class="st">'lateral'</span>)])<span class="op">/</span>male_no</span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>lateral_female <span class="op">=</span> <span class="bu">len</span>(df_female[df_female[<span class="st">'Path'</span>].<span class="bu">str</span>.contains(<span class="st">'lateral'</span>)])<span class="op">/</span>fem_no</span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'There are on average '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(lateral_male, <span class="dv">3</span>)) <span class="op">+</span> <span class="st">' lateral images for each male patient, and '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(lateral_female, <span class="dv">3</span>)) <span class="op">+</span> <span class="st">' for each female patient.'</span>)</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>white_no <span class="op">=</span> (df_check[<span class="st">'PRIMARY_RACE'</span>].<span class="bu">str</span>.contains(<span class="st">'White'</span>)).<span class="bu">sum</span>()</span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a>black_no <span class="op">=</span> (df_check[<span class="st">'PRIMARY_RACE'</span>].<span class="bu">str</span>.contains(<span class="st">'Black'</span>)).<span class="bu">sum</span>()</span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a>asian_no <span class="op">=</span> (df_check[<span class="st">'PRIMARY_RACE'</span>].<span class="bu">str</span>.contains(<span class="st">'Asian'</span>)).<span class="bu">sum</span>()</span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> [<span class="st">'White'</span>, <span class="st">'Asian'</span>, <span class="st">'Black'</span>]</span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a>sizes <span class="op">=</span> [white_no, asian_no, black_no]</span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a>fig1, ax1 <span class="op">=</span> plt.subplots()</span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a>fig2, ax2 <span class="op">=</span> plt.subplots()</span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a>ax1.pie(sizes, labels <span class="op">=</span> labels, autopct<span class="op">=</span><span class="st">'</span><span class="sc">%1.1f%%</span><span class="st">'</span>,</span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a>       pctdistance<span class="op">=</span><span class="fl">1.25</span>, labeldistance<span class="op">=</span><span class="fl">1.6</span>)</span>
<span id="cb106-27"><a href="#cb106-27" aria-hidden="true" tabindex="-1"></a>ax2.pie([male_no, fem_no], labels <span class="op">=</span> [<span class="st">'Men'</span>, <span class="st">'Women'</span>] , autopct<span class="op">=</span><span class="st">'</span><span class="sc">%1.1f%%</span><span class="st">'</span>,</span>
<span id="cb106-28"><a href="#cb106-28" aria-hidden="true" tabindex="-1"></a>       pctdistance<span class="op">=</span><span class="fl">1.25</span>, labeldistance<span class="op">=</span><span class="fl">1.6</span>)</span>
<span id="cb106-29"><a href="#cb106-29" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Ratio of men to women in the training set for the model with the 0.735 gamma scheduler is: 1.335, or 57.18% men and 42.82% women.
There are on average 0.787 frontal images for each male patient, and 0.805 for each female patient.
There are on average 0.213 lateral images for each male patient, and 0.195 for each female patient.</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-64-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-64-output-3.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="be4d6e99-e9bf-473c-ad54-9a5a9b406968">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>df_test_bwa_equal_male <span class="op">=</span> df_test_bwa_equal_frontal[df_test_bwa_equal[<span class="st">'Sex'</span>] <span class="op">==</span> <span class="st">'Male'</span>]</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>df_test_bwa_equal_female <span class="op">=</span> df_test_bwa_equal_frontal[df_test_bwa_equal[<span class="st">'Sex'</span>] <span class="op">==</span> <span class="st">'Female'</span>]</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>df_test_bwa_equal_female</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>UserWarning: Boolean Series key will be reindexed to match DataFrame index.
  df_test_bwa_equal_male = df_test_bwa_equal_frontal[df_test_bwa_equal['Sex'] == 'Male']
&lt;ipython-input-12-4ccdc779abab&gt;:2: UserWarning: Boolean Series key will be reindexed to match DataFrame index.
  df_test_bwa_equal_female = df_test_bwa_equal_frontal[df_test_bwa_equal['Sex'] == 'Female']</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="12">


  <div id="df-217a7628-fc29-4db1-b392-37b3a2c4a25d">
    <div class="colab-df-container">
      <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Unnamed: 0.1</th>
      <th>Unnamed: 0</th>
      <th>Path</th>
      <th>Sex</th>
      <th>Age</th>
      <th>Frontal/Lateral</th>
      <th>AP/PA</th>
      <th>No Finding</th>
      <th>Enlarged Cardiomediastinum</th>
      <th>Cardiomegaly</th>
      <th>...</th>
      <th>Pleural Effusion</th>
      <th>Pleural Other</th>
      <th>Fracture</th>
      <th>Support Devices</th>
      <th>PATIENT</th>
      <th>GENDER</th>
      <th>AGE_AT_CXR</th>
      <th>PRIMARY_RACE</th>
      <th>ETHNICITY</th>
      <th>RACE_NUM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>3766</td>
      <td>104243</td>
      <td>CheXpert-v1.0-small/train/patient25254/study4/...</td>
      <td>Female</td>
      <td>90</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient25254</td>
      <td>Female</td>
      <td>92</td>
      <td>Black or African American</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>9666</td>
      <td>112659</td>
      <td>CheXpert-v1.0-small/train/patient27288/study2/...</td>
      <td>Female</td>
      <td>41</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>patient27288</td>
      <td>Female</td>
      <td>42</td>
      <td>Black, non-Hispanic</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>1</td>
    </tr>
    <tr>
      <th>11</th>
      <td>12601</td>
      <td>116650</td>
      <td>CheXpert-v1.0-small/train/patient28228/study1/...</td>
      <td>Female</td>
      <td>21</td>
      <td>Frontal</td>
      <td>PA</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient28228</td>
      <td>Female</td>
      <td>19</td>
      <td>Black or African American</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>1</td>
    </tr>
    <tr>
      <th>16</th>
      <td>536</td>
      <td>99614</td>
      <td>CheXpert-v1.0-small/train/patient24193/study5/...</td>
      <td>Female</td>
      <td>90</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>patient24193</td>
      <td>Female</td>
      <td>101</td>
      <td>White</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>0</td>
    </tr>
    <tr>
      <th>19</th>
      <td>1032</td>
      <td>100253</td>
      <td>CheXpert-v1.0-small/train/patient24344/study12...</td>
      <td>Female</td>
      <td>37</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>patient24344</td>
      <td>Female</td>
      <td>37</td>
      <td>Asian</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>2</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2985</th>
      <td>1366</td>
      <td>100729</td>
      <td>CheXpert-v1.0-small/train/patient24431/study1/...</td>
      <td>Female</td>
      <td>74</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient24431</td>
      <td>Female</td>
      <td>74</td>
      <td>Asian</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2986</th>
      <td>7206</td>
      <td>109367</td>
      <td>CheXpert-v1.0-small/train/patient26501/study3/...</td>
      <td>Female</td>
      <td>53</td>
      <td>Frontal</td>
      <td>PA</td>
      <td>NaN</td>
      <td>-1.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>patient26501</td>
      <td>Female</td>
      <td>55</td>
      <td>Black or African American</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2995</th>
      <td>1237</td>
      <td>100534</td>
      <td>CheXpert-v1.0-small/train/patient24400/study1/...</td>
      <td>Female</td>
      <td>29</td>
      <td>Frontal</td>
      <td>PA</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient24400</td>
      <td>Female</td>
      <td>29</td>
      <td>Asian</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2996</th>
      <td>4244</td>
      <td>104980</td>
      <td>CheXpert-v1.0-small/train/patient25459/study1/...</td>
      <td>Female</td>
      <td>31</td>
      <td>Frontal</td>
      <td>PA</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>patient25459</td>
      <td>Female</td>
      <td>31</td>
      <td>Black, non-Hispanic</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2997</th>
      <td>2001</td>
      <td>101622</td>
      <td>CheXpert-v1.0-small/train/patient24646/study4/...</td>
      <td>Female</td>
      <td>57</td>
      <td>Frontal</td>
      <td>AP</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>patient24646</td>
      <td>Female</td>
      <td>50</td>
      <td>Black or African American</td>
      <td>Non-Hispanic/Non-Latino</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
<p>932 rows × 27 columns</p>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-217a7628-fc29-4db1-b392-37b3a2c4a25d')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-217a7628-fc29-4db1-b392-37b3a2c4a25d button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-217a7628-fc29-4db1-b392-37b3a2c4a25d');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<div class="cell" data-outputid="d8483421-1c1e-44d0-f146-3e925beed429">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>model_filename <span class="op">=</span> <span class="st">'/content/drive/Shareddrives/CheXpert-v1.0-small/efficientb0_10000_bwa_equal_exponential_scheduler.pth'</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>model_saved <span class="op">=</span> EfficientNet.from_pretrained(<span class="st">'efficientnet-b0'</span>,num_classes<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>checkpoint <span class="op">=</span> torch.load(model_filename, map_location<span class="op">=</span>device)</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Loading trained model weights...'</span>)</span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>model_saved.load_state_dict(checkpoint[<span class="st">'model_state_dict'</span>],strict<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>model_saved <span class="op">=</span> model_saved.to(device)</span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>test_dataset_male <span class="op">=</span> ChestXrayDataset(<span class="st">"/content/drive/Shareddrives/"</span>, df_test_bwa_equal_male[:<span class="dv">2500</span>], IMAGE_SIZE, <span class="va">True</span>)</span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>test_dataloader_male <span class="op">=</span> DataLoader(dataset<span class="op">=</span>test_dataset_male, batch_size<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">False</span>, num_workers<span class="op">=</span><span class="dv">2</span>, pin_memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a>test_dataset_female <span class="op">=</span> ChestXrayDataset(<span class="st">"/content/drive/Shareddrives/"</span>, df_test_bwa_equal_female[:<span class="dv">2500</span>], IMAGE_SIZE, <span class="va">True</span>)</span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a>test_dataloader_female <span class="op">=</span> DataLoader(dataset<span class="op">=</span>test_dataset_female, batch_size<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">False</span>, num_workers<span class="op">=</span><span class="dv">2</span>, pin_memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true" tabindex="-1"></a>y_pred_enet_male, y_true_enet_male <span class="op">=</span> test(model_saved,test_dataloader_male)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded pretrained weights for efficientnet-b0
Loading trained model weights...
tensor([0, 1, 0, 1, 2, 1, 2, 1, 0, 1, 1, 0, 0, 1, 0, 1, 1, 2, 0, 0],
       device='cuda:0')
predicted:  tensor([0, 1, 0, 1, 2, 0, 2, 1, 0, 1, 1, 0, 0, 1, 0, 0, 1, 1, 0, 2],
       device='cuda:0')
tensor([2, 0, 2, 0, 2, 2, 0, 1, 2, 0, 0, 0, 0, 0, 2, 1, 0, 0, 1, 2],
       device='cuda:0')
predicted:  tensor([0, 0, 2, 0, 2, 2, 2, 1, 2, 0, 1, 0, 0, 2, 2, 1, 0, 1, 1, 2],
       device='cuda:0')
tensor([2, 2, 0, 0, 2, 1, 2, 1, 2, 2, 1, 0, 0, 0, 2, 0, 2, 0, 1, 2],
       device='cuda:0')
predicted:  tensor([1, 2, 0, 2, 2, 1, 2, 0, 2, 2, 1, 0, 0, 0, 2, 0, 2, 2, 1, 0],
       device='cuda:0')
tensor([2, 2, 0, 2, 1, 1, 2, 1, 0, 1, 2, 1, 2, 1, 0, 0, 0, 0, 2, 2],
       device='cuda:0')
predicted:  tensor([2, 2, 0, 2, 0, 1, 2, 1, 0, 0, 0, 1, 1, 1, 0, 2, 2, 1, 2, 2],
       device='cuda:0')
tensor([1, 2, 0, 2, 0, 1, 0, 1, 2, 2, 0, 1, 2, 0, 0, 0, 1, 0, 0, 2],
       device='cuda:0')
predicted:  tensor([1, 2, 0, 2, 0, 1, 1, 1, 0, 1, 0, 1, 2, 1, 0, 0, 1, 0, 0, 2],
       device='cuda:0')
tensor([2, 2, 1, 2, 0, 1, 2, 1, 1, 2, 0, 1, 2, 1, 1, 1, 0, 1, 0, 2],
       device='cuda:0')
predicted:  tensor([0, 0, 1, 2, 0, 0, 2, 1, 1, 2, 0, 1, 1, 1, 0, 1, 0, 1, 2, 2],
       device='cuda:0')
tensor([0, 0, 0, 0, 2, 2, 2, 2, 1, 1, 1, 2, 0, 1, 1, 2, 0, 0, 1, 2],
       device='cuda:0')
predicted:  tensor([0, 0, 0, 0, 2, 2, 2, 2, 1, 1, 0, 2, 0, 0, 1, 2, 2, 0, 0, 2],
       device='cuda:0')
tensor([2, 0, 2, 2, 2, 2, 2, 0, 0, 0, 2, 0, 2, 1, 1, 0, 2, 1, 2, 0],
       device='cuda:0')
predicted:  tensor([1, 0, 2, 2, 2, 2, 2, 2, 0, 1, 0, 0, 2, 1, 1, 0, 2, 1, 2, 0],
       device='cuda:0')
tensor([2, 0, 0, 0, 0, 2, 0, 2, 0, 1, 2, 2, 0, 1, 0, 1, 0, 1, 0, 1],
       device='cuda:0')
predicted:  tensor([2, 0, 0, 0, 0, 0, 1, 2, 0, 1, 2, 2, 1, 1, 0, 1, 0, 1, 0, 1],
       device='cuda:0')
tensor([1, 0, 0, 1, 0, 0, 2, 2, 1, 0, 0, 2, 0, 2, 2, 1, 2, 0, 2, 1],
       device='cuda:0')
predicted:  tensor([1, 0, 0, 1, 2, 0, 0, 2, 1, 1, 0, 0, 2, 2, 2, 0, 2, 0, 2, 1],
       device='cuda:0')
tensor([0, 2, 1, 2, 1, 0, 1, 1, 2, 0, 0, 0, 0, 1, 2, 2, 2, 0, 2, 2],
       device='cuda:0')
predicted:  tensor([0, 2, 1, 2, 1, 2, 1, 0, 2, 0, 0, 0, 0, 1, 2, 2, 2, 0, 0, 2],
       device='cuda:0')
tensor([0, 0, 0, 0, 1, 1, 0, 0, 2, 0, 1, 0, 2, 2, 2, 2, 2, 1, 1, 0],
       device='cuda:0')
predicted:  tensor([0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 2, 2, 2, 2, 2, 1, 1, 1],
       device='cuda:0')
tensor([0, 0, 0, 2, 2, 2, 1, 2, 0, 1, 0, 1, 2, 2, 2, 0, 2, 0, 0, 0],
       device='cuda:0')
predicted:  tensor([0, 0, 0, 2, 2, 2, 1, 2, 0, 1, 0, 0, 2, 1, 2, 0, 2, 0, 0, 1],
       device='cuda:0')
tensor([0, 0, 2, 0, 2, 0, 0, 1, 1, 0, 2, 0, 2, 2, 2, 1, 2, 2, 0, 0],
       device='cuda:0')
predicted:  tensor([0, 2, 0, 1, 2, 0, 0, 2, 1, 1, 2, 0, 0, 2, 2, 1, 0, 0, 2, 0],
       device='cuda:0')
tensor([0, 1, 0, 0, 0, 1, 0, 0, 2, 2, 1, 1, 0, 1, 2, 2, 0, 1, 0, 0],
       device='cuda:0')
predicted:  tensor([0, 1, 2, 1, 0, 1, 0, 0, 2, 2, 1, 0, 0, 0, 2, 0, 0, 1, 0, 0],
       device='cuda:0')
tensor([0, 1, 1, 0, 2, 2, 0, 0, 1, 0, 2, 1, 1, 2, 0, 0, 1, 0, 0, 0],
       device='cuda:0')
predicted:  tensor([0, 1, 1, 0, 2, 2, 0, 0, 1, 0, 2, 0, 0, 1, 0, 0, 1, 0, 0, 0],
       device='cuda:0')
tensor([1, 2, 0, 1, 2, 1, 1, 0, 1, 2, 1, 0, 1, 0, 0, 1, 1, 2, 0, 1],
       device='cuda:0')
predicted:  tensor([0, 2, 0, 1, 0, 1, 0, 0, 2, 2, 1, 0, 1, 1, 0, 1, 0, 2, 0, 1],
       device='cuda:0')
tensor([1, 2, 2, 0, 2, 2, 0, 0, 0, 2, 1, 0, 0, 0, 0, 0, 1, 2, 0, 1],
       device='cuda:0')
predicted:  tensor([2, 2, 2, 0, 2, 0, 0, 0, 1, 2, 1, 0, 0, 0, 0, 2, 1, 0, 0, 1],
       device='cuda:0')
tensor([0, 2, 2, 2, 1, 2, 0, 2, 1, 2, 2, 1, 2, 0, 1, 1, 0, 0, 1, 2],
       device='cuda:0')
predicted:  tensor([2, 2, 0, 0, 1, 0, 0, 2, 2, 2, 2, 1, 2, 0, 1, 1, 0, 0, 0, 2],
       device='cuda:0')
tensor([0, 0, 2, 0, 1, 2, 0, 0, 0, 0, 1, 0, 1, 2, 1, 0, 0, 0, 0, 2],
       device='cuda:0')
predicted:  tensor([1, 0, 2, 0, 1, 0, 0, 0, 2, 0, 1, 0, 1, 0, 1, 2, 0, 0, 0, 2],
       device='cuda:0')
tensor([2, 2, 1, 0, 1, 2, 2, 0, 1, 2, 2, 2, 0, 0, 2, 1, 1, 1, 0, 1],
       device='cuda:0')
predicted:  tensor([2, 0, 1, 0, 1, 2, 2, 2, 1, 2, 2, 2, 0, 0, 2, 1, 1, 1, 0, 1],
       device='cuda:0')
tensor([1, 1, 0, 2, 0, 1, 0, 1, 1, 2, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0],
       device='cuda:0')
predicted:  tensor([2, 1, 1, 0, 0, 1, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0],
       device='cuda:0')
tensor([0, 0, 2, 2, 0, 1, 0, 1, 1, 2, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1],
       device='cuda:0')
predicted:  tensor([0, 1, 2, 2, 0, 1, 0, 1, 1, 2, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1],
       device='cuda:0')
tensor([0, 2, 1, 0, 2, 1, 0, 0, 0, 2, 2, 1, 0, 1, 2, 2, 1, 0, 0, 2],
       device='cuda:0')
predicted:  tensor([1, 2, 1, 0, 2, 1, 0, 0, 0, 2, 2, 1, 0, 1, 2, 2, 1, 1, 0, 2],
       device='cuda:0')
tensor([2, 0, 1, 0, 2, 2, 2, 0, 2, 0, 2, 1, 2, 0, 0, 1, 2, 0, 0, 0],
       device='cuda:0')
predicted:  tensor([2, 0, 1, 0, 2, 2, 2, 0, 2, 1, 0, 1, 2, 0, 0, 0, 2, 0, 0, 0],
       device='cuda:0')
tensor([2, 0, 2, 0, 1, 0, 2, 0, 0, 1, 1, 2, 0, 2, 1, 2, 1, 2, 2, 0],
       device='cuda:0')
predicted:  tensor([2, 0, 0, 1, 0, 1, 1, 2, 0, 1, 0, 2, 0, 1, 1, 1, 0, 0, 2, 0],
       device='cuda:0')
tensor([1, 1, 2, 1, 2, 1, 0, 2, 0, 0, 0, 0, 1, 2, 2, 0, 2, 0, 2, 2],
       device='cuda:0')
predicted:  tensor([1, 1, 2, 1, 2, 1, 0, 2, 0, 0, 2, 0, 1, 2, 2, 0, 0, 1, 2, 2],
       device='cuda:0')
tensor([1, 2, 0, 2, 0, 0, 0, 2, 1, 0, 2, 0, 0, 0, 2, 0, 0, 0, 1, 2],
       device='cuda:0')
predicted:  tensor([1, 2, 0, 2, 0, 0, 0, 2, 1, 0, 0, 2, 0, 0, 2, 0, 0, 0, 1, 0],
       device='cuda:0')
tensor([2, 2, 1, 1, 0, 1, 2, 0, 0, 0, 2, 2, 1, 2, 1, 2, 1, 1, 2, 0],
       device='cuda:0')
predicted:  tensor([0, 2, 1, 0, 0, 1, 1, 0, 2, 0, 0, 2, 1, 0, 2, 2, 1, 1, 2, 0],
       device='cuda:0')
tensor([1, 0, 0, 1, 1, 0, 0, 2, 1, 2, 0, 2, 0, 1, 1, 2, 1, 0, 2, 0],
       device='cuda:0')
predicted:  tensor([1, 2, 0, 1, 1, 2, 0, 2, 1, 0, 0, 2, 0, 1, 1, 2, 2, 0, 2, 0],
       device='cuda:0')
tensor([0, 1, 0, 2, 2, 1, 2, 2, 0, 0, 0, 2, 0, 0, 1, 1, 2, 2, 0, 2],
       device='cuda:0')
predicted:  tensor([0, 1, 0, 0, 0, 1, 2, 2, 0, 0, 0, 2, 0, 0, 1, 1, 2, 1, 0, 2],
       device='cuda:0')
tensor([2, 0, 0, 0, 0, 1, 1, 2, 0, 0, 1, 1, 1, 1, 1, 0, 0, 2, 2, 1],
       device='cuda:0')
predicted:  tensor([0, 2, 2, 0, 0, 1, 1, 2, 0, 1, 1, 1, 1, 0, 1, 0, 0, 2, 2, 1],
       device='cuda:0')
tensor([0, 1, 1, 0, 0, 2, 2, 2, 0, 0, 0, 0, 2, 1, 2, 1, 1, 2, 2, 0],
       device='cuda:0')
predicted:  tensor([0, 1, 1, 0, 0, 2, 2, 0, 1, 0, 0, 0, 1, 1, 2, 2, 1, 2, 2, 0],
       device='cuda:0')
tensor([1, 0, 0, 2, 1, 2, 2, 1, 1, 0, 1, 0, 1, 1, 0, 1, 2, 2, 0, 0],
       device='cuda:0')
predicted:  tensor([1, 2, 0, 2, 1, 2, 0, 1, 1, 0, 1, 0, 1, 1, 0, 1, 2, 2, 0, 0],
       device='cuda:0')
tensor([0, 0, 2, 1, 1, 0, 1, 0, 2, 2, 2, 2, 1, 2, 0, 2, 1, 1, 0, 2],
       device='cuda:0')
predicted:  tensor([0, 0, 2, 0, 1, 0, 1, 2, 0, 2, 1, 0, 0, 2, 2, 2, 1, 1, 1, 2],
       device='cuda:0')
tensor([1, 0, 1, 1, 1, 0, 2, 0, 2, 0, 0, 0, 0, 0, 1, 0, 1, 2, 1, 1],
       device='cuda:0')
predicted:  tensor([0, 2, 0, 1, 1, 2, 2, 0, 2, 0, 0, 0, 1, 0, 0, 2, 0, 2, 1, 1],
       device='cuda:0')
tensor([1, 0, 0, 2, 0, 1, 0, 1, 0, 0, 0, 2, 0, 2, 2, 1, 0, 1, 2, 0],
       device='cuda:0')
predicted:  tensor([1, 0, 0, 2, 0, 0, 1, 0, 0, 0, 0, 2, 0, 0, 2, 1, 0, 1, 0, 2],
       device='cuda:0')
tensor([2, 1, 1, 1, 0, 1, 0, 2, 1, 1, 0, 2, 2, 2, 2, 0, 1, 0, 1, 0],
       device='cuda:0')
predicted:  tensor([2, 1, 1, 1, 0, 1, 2, 2, 1, 1, 1, 2, 1, 2, 2, 2, 2, 0, 0, 0],
       device='cuda:0')
tensor([0, 0, 0, 0, 1, 2, 0, 2, 0, 0, 1, 0, 0, 2, 0, 0, 0, 1, 0, 0],
       device='cuda:0')
predicted:  tensor([0, 1, 1, 0, 2, 2, 0, 1, 0, 0, 1, 0, 1, 2, 2, 1, 1, 1, 1, 0],
       device='cuda:0')
tensor([0, 2, 0, 2, 0, 1, 0, 0, 1, 0, 1, 0, 0, 2, 0, 0, 0, 2, 0, 1],
       device='cuda:0')
predicted:  tensor([0, 2, 0, 2, 0, 1, 0, 0, 1, 0, 1, 0, 0, 2, 0, 0, 0, 2, 1, 0],
       device='cuda:0')
tensor([0, 1, 0, 0, 1, 1, 0, 1, 0, 2, 2, 2, 2, 0, 0, 2, 0, 2, 1, 1],
       device='cuda:0')
predicted:  tensor([2, 0, 2, 2, 1, 1, 0, 1, 0, 2, 2, 2, 0, 0, 0, 2, 0, 1, 1, 0],
       device='cuda:0')
tensor([1, 1, 2, 2, 0, 0, 1, 0, 2, 2, 2, 0, 0, 1, 0, 1, 2, 2, 2, 2],
       device='cuda:0')
predicted:  tensor([1, 1, 2, 2, 0, 0, 0, 2, 2, 0, 2, 0, 0, 1, 1, 1, 2, 2, 2, 0],
       device='cuda:0')
tensor([0, 2, 2, 1, 2, 0, 1, 1, 0, 1, 1, 1, 1, 1, 2, 0, 1, 0, 2, 2],
       device='cuda:0')
predicted:  tensor([0, 2, 2, 1, 2, 0, 1, 0, 0, 2, 1, 1, 1, 0, 2, 0, 1, 2, 0, 2],
       device='cuda:0')
tensor([2, 0, 2, 0, 0, 1, 2, 2, 2, 1, 2, 0, 0, 0, 0, 1, 2, 2, 0, 2],
       device='cuda:0')
predicted:  tensor([0, 2, 1, 0, 0, 1, 2, 2, 2, 1, 2, 0, 0, 0, 0, 1, 2, 2, 0, 2],
       device='cuda:0')
tensor([0, 1, 0, 1, 1, 2, 0, 0, 1, 0, 0, 0, 1, 1, 1, 0, 2, 2, 2, 1],
       device='cuda:0')
predicted:  tensor([0, 1, 2, 1, 1, 2, 1, 0, 1, 0, 0, 0, 1, 1, 1, 2, 2, 2, 0, 1],
       device='cuda:0')
tensor([2, 0, 1, 0, 0, 2, 0, 2, 0, 2, 0, 2, 2, 0, 2, 2, 1, 0, 2, 2],
       device='cuda:0')
predicted:  tensor([2, 2, 1, 2, 0, 2, 0, 2, 0, 2, 0, 2, 0, 0, 2, 2, 1, 0, 1, 2],
       device='cuda:0')
tensor([1, 0, 2, 2, 1, 1, 0, 1, 0, 0, 2, 0, 1, 2, 1, 1, 0, 0, 2, 1],
       device='cuda:0')
predicted:  tensor([1, 0, 2, 2, 1, 1, 0, 1, 0, 0, 2, 1, 1, 2, 1, 1, 0, 0, 2, 1],
       device='cuda:0')
tensor([1, 0, 0, 1, 2, 1, 0, 0, 1, 1, 0, 1, 1, 2, 1, 1, 0, 1, 0, 1],
       device='cuda:0')
predicted:  tensor([2, 0, 0, 0, 2, 0, 0, 0, 1, 0, 0, 1, 1, 2, 1, 1, 0, 1, 0, 1],
       device='cuda:0')
tensor([0, 0, 0, 1, 0, 0, 0, 2, 0, 2, 2, 0, 0, 1, 1, 0, 0, 0, 2, 2],
       device='cuda:0')
predicted:  tensor([0, 0, 0, 1, 0, 0, 1, 1, 2, 0, 2, 0, 0, 0, 1, 0, 0, 0, 2, 0],
       device='cuda:0')
tensor([1, 2, 2, 0, 0, 0, 1, 2, 2, 2, 1, 2, 1, 0, 1, 0, 2, 0, 2, 1],
       device='cuda:0')
predicted:  tensor([1, 0, 2, 0, 1, 0, 1, 2, 2, 2, 0, 2, 1, 0, 1, 0, 0, 0, 2, 1],
       device='cuda:0')
tensor([0, 0, 2, 2, 1, 0, 2, 0, 1, 2, 0, 0, 1, 2, 1, 0, 0, 1, 1, 2],
       device='cuda:0')
predicted:  tensor([0, 0, 2, 0, 2, 0, 2, 2, 2, 2, 0, 0, 1, 2, 2, 0, 0, 1, 1, 2],
       device='cuda:0')
tensor([1, 1, 2, 1, 2, 2, 0, 0, 2, 1, 2, 1, 1, 1, 1, 2, 2, 0, 1, 0],
       device='cuda:0')
predicted:  tensor([1, 1, 1, 1, 2, 0, 0, 0, 2, 1, 2, 1, 1, 0, 2, 2, 2, 0, 1, 1],
       device='cuda:0')
tensor([2, 2, 0, 1, 0, 1, 0, 0, 1, 2, 1, 2, 1, 0, 2, 1, 1, 2, 2, 0],
       device='cuda:0')
predicted:  tensor([2, 2, 0, 1, 0, 1, 2, 0, 1, 2, 0, 2, 1, 2, 2, 2, 1, 0, 2, 0],
       device='cuda:0')
tensor([2, 1, 2, 1, 1, 1, 0, 2, 2, 2, 1, 2, 2, 0, 2, 2, 0, 0, 0, 0],
       device='cuda:0')
predicted:  tensor([1, 1, 2, 1, 0, 1, 0, 2, 2, 2, 0, 2, 2, 0, 2, 2, 0, 0, 0, 0],
       device='cuda:0')
tensor([1, 0, 2, 0, 0, 2, 2, 1, 1, 2, 0, 0, 1, 2, 1, 0, 0, 2, 1, 2],
       device='cuda:0')
predicted:  tensor([0, 0, 2, 0, 0, 2, 2, 1, 0, 0, 0, 0, 0, 2, 0, 0, 0, 2, 0, 2],
       device='cuda:0')
tensor([0, 2, 1, 0, 1, 1, 1, 0, 2, 0, 1, 0, 1, 1, 1, 2, 2, 0, 2, 0],
       device='cuda:0')
predicted:  tensor([0, 2, 1, 0, 2, 1, 1, 0, 1, 0, 1, 0, 1, 1, 0, 2, 2, 0, 2, 0],
       device='cuda:0')
tensor([1, 2, 0, 0, 0, 1, 2, 1, 0, 0, 0, 2, 1, 0, 1, 0, 0, 2, 0, 2],
       device='cuda:0')
predicted:  tensor([1, 2, 0, 0, 0, 1, 1, 1, 2, 0, 0, 2, 1, 0, 1, 0, 0, 2, 0, 0],
       device='cuda:0')
tensor([1, 0, 0, 2, 1, 1, 1, 0, 0, 1, 1, 0, 0, 2, 2, 2, 0, 0, 0, 1],
       device='cuda:0')
predicted:  tensor([1, 1, 0, 2, 0, 1, 1, 2, 2, 1, 1, 0, 0, 2, 2, 2, 0, 0, 0, 0],
       device='cuda:0')
tensor([1, 2, 0, 1, 0, 2, 2, 1, 2, 2, 0, 2, 2, 0, 0, 0, 1, 2, 0, 2],
       device='cuda:0')
predicted:  tensor([1, 2, 0, 1, 2, 2, 2, 1, 2, 2, 0, 2, 2, 0, 1, 0, 1, 2, 0, 2],
       device='cuda:0')
tensor([1, 2, 0, 1, 1, 0, 0, 1, 1, 1, 0, 0, 1, 1, 2, 0, 0, 2, 0, 2],
       device='cuda:0')
predicted:  tensor([1, 2, 0, 1, 1, 0, 2, 0, 1, 2, 0, 0, 1, 1, 2, 0, 0, 2, 0, 2],
       device='cuda:0')
tensor([2, 0, 0, 2, 2, 2, 1, 2, 2, 2, 0, 0, 0, 0, 1, 1, 0, 2, 1, 2],
       device='cuda:0')
predicted:  tensor([2, 0, 0, 2, 2, 0, 1, 2, 2, 0, 0, 0, 2, 0, 1, 0, 0, 2, 1, 2],
       device='cuda:0')
tensor([2, 2, 1, 1, 0, 2, 0, 1, 0, 2, 2, 0, 2, 2, 0, 2, 1, 2, 0, 0],
       device='cuda:0')
predicted:  tensor([2, 2, 1, 1, 0, 2, 0, 0, 0, 2, 2, 0, 0, 2, 2, 2, 1, 2, 0, 0],
       device='cuda:0')
tensor([2, 1, 0, 2, 1, 2, 2, 0, 1, 1, 2, 1, 2, 1, 1, 2, 1, 0, 2, 2],
       device='cuda:0')
predicted:  tensor([1, 1, 0, 2, 1, 2, 2, 0, 0, 1, 0, 1, 2, 0, 1, 0, 1, 1, 2, 2],
       device='cuda:0')
tensor([0, 0, 2, 1, 2, 1, 0, 2, 1, 0, 2, 0, 1, 2, 1, 0, 1, 0, 2, 2],
       device='cuda:0')
predicted:  tensor([0, 0, 2, 0, 1, 1, 0, 2, 1, 2, 2, 0, 0, 2, 1, 2, 0, 0, 2, 2],
       device='cuda:0')
tensor([2, 1, 2, 0, 0, 0, 1, 0, 2, 0, 0, 0, 2, 2, 0, 0, 2, 1, 2, 2],
       device='cuda:0')
predicted:  tensor([2, 2, 0, 0, 0, 0, 1, 1, 2, 0, 0, 0, 2, 2, 0, 0, 0, 1, 2, 2],
       device='cuda:0')
tensor([0, 0, 0, 0, 2, 0, 2, 0, 0, 0, 0, 0, 0, 2, 2, 2, 0, 2, 0, 0],
       device='cuda:0')
predicted:  tensor([1, 0, 0, 0, 2, 0, 2, 0, 0, 0, 0, 0, 0, 2, 2, 2, 0, 2, 0, 0],
       device='cuda:0')
tensor([1, 2, 0, 1, 1, 1, 0, 0, 1, 0, 0, 0, 0, 1, 2, 1, 0, 0, 0, 0],
       device='cuda:0')
predicted:  tensor([1, 2, 2, 1, 1, 1, 0, 2, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 0],
       device='cuda:0')
tensor([1, 1, 1, 1, 0, 1, 2, 0, 1, 0, 2, 0, 0, 0, 0, 0, 1, 0, 0, 1],
       device='cuda:0')
predicted:  tensor([1, 2, 1, 2, 0, 1, 2, 0, 1, 2, 0, 0, 0, 1, 0, 1, 1, 1, 0, 1],
       device='cuda:0')
tensor([1, 2, 2, 1, 0, 2, 2, 2, 0, 0, 1, 1, 1, 1, 1, 0, 2, 1, 1, 1],
       device='cuda:0')
predicted:  tensor([1, 0, 1, 0, 0, 2, 2, 0, 0, 0, 1, 0, 0, 1, 1, 1, 2, 1, 1, 1],
       device='cuda:0')
tensor([0, 0, 2, 0, 1, 0, 1, 2, 2, 0, 2, 0, 2, 2, 0, 2, 0, 1, 2, 0],
       device='cuda:0')
predicted:  tensor([0, 2, 2, 0, 1, 0, 0, 0, 0, 2, 0, 0, 2, 0, 0, 2, 0, 1, 2, 0],
       device='cuda:0')
tensor([2, 1, 2, 0, 1, 2, 0, 1, 2, 1, 2, 0, 2, 2, 2, 1, 2, 2, 0],
       device='cuda:0')
predicted:  tensor([0, 0, 2, 0, 1, 2, 1, 0, 2, 1, 2, 0, 2, 1, 2, 2, 0, 2, 0],
       device='cuda:0')
Test accuracy: 76 %</code></pre>
</div>
</div>
<div class="cell" data-outputid="84eef459-34ab-49c9-a717-4c73fff9eb7d">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>cf_matrix <span class="op">=</span> confusion_matrix(y_true_enet_male, y_pred_enet_male)</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cf_matrix)</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>classes <span class="op">=</span> [<span class="st">'White'</span>,<span class="st">'Black'</span>,<span class="st">'Asian'</span>]</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>df_cm <span class="op">=</span> pd.DataFrame(cf_matrix <span class="op">/</span> np.<span class="bu">sum</span>(cf_matrix, axis<span class="op">=</span><span class="dv">1</span>)[:, <span class="va">None</span>], index <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> classes],</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>                     columns <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> classes])</span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>                     </span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize <span class="op">=</span> (<span class="dv">12</span>,<span class="dv">7</span>))</span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="vs">r'Confusion matrix: BWA Equal with Exponential Scheduler, $\gamma = 0.735$, 2500 male patients, both frontal and lateral'</span>)</span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a>sns.heatmap(df_cm, annot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">'output.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>NameError: ignored</code></pre>
</div>
</div>
<div class="cell" data-outputid="f56e568b-6ef6-4b3f-b13f-91f3704c790b">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>y_pred_enet_female, y_true_enet_female <span class="op">=</span> test(model_saved,test_dataloader_female)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tensor([1, 1, 1, 0, 2, 2, 1, 1, 2, 2, 1, 2, 0, 2, 1, 0, 0, 1, 1, 0],
       device='cuda:0')
predicted:  tensor([1, 1, 1, 0, 2, 2, 1, 0, 2, 2, 1, 2, 0, 2, 1, 2, 2, 1, 1, 0],
       device='cuda:0')
tensor([2, 0, 2, 2, 1, 2, 1, 0, 1, 0, 0, 1, 1, 0, 2, 0, 1, 2, 1, 1],
       device='cuda:0')
predicted:  tensor([2, 0, 2, 2, 0, 0, 1, 0, 1, 0, 1, 0, 1, 0, 2, 2, 1, 2, 0, 1],
       device='cuda:0')
tensor([1, 0, 2, 1, 2, 1, 1, 0, 1, 2, 1, 2, 2, 1, 1, 2, 2, 2, 2, 2],
       device='cuda:0')
predicted:  tensor([1, 0, 2, 0, 2, 1, 1, 0, 0, 2, 1, 2, 2, 1, 1, 2, 0, 2, 2, 2],
       device='cuda:0')
tensor([2, 2, 0, 1, 1, 2, 2, 1, 1, 2, 1, 0, 0, 0, 2, 0, 1, 0, 1, 2],
       device='cuda:0')
predicted:  tensor([2, 0, 2, 1, 0, 2, 2, 1, 2, 2, 1, 0, 0, 0, 2, 1, 1, 0, 0, 2],
       device='cuda:0')
tensor([1, 0, 2, 2, 0, 2, 1, 1, 0, 0, 2, 1, 2, 1, 1, 2, 1, 2, 1, 2],
       device='cuda:0')
predicted:  tensor([1, 2, 2, 2, 0, 2, 1, 1, 0, 0, 2, 1, 2, 1, 1, 2, 1, 2, 1, 2],
       device='cuda:0')
tensor([1, 2, 1, 0, 2, 1, 1, 1, 0, 0, 1, 0, 1, 2, 1, 0, 0, 1, 1, 2],
       device='cuda:0')
predicted:  tensor([1, 2, 1, 2, 2, 1, 1, 1, 1, 2, 1, 1, 1, 2, 2, 1, 0, 0, 1, 2],
       device='cuda:0')
tensor([2, 2, 0, 1, 0, 1, 2, 1, 1, 1, 2, 1, 0, 1, 2, 1, 1, 2, 2, 1],
       device='cuda:0')
predicted:  tensor([2, 1, 0, 0, 0, 1, 0, 1, 0, 1, 2, 1, 0, 1, 2, 1, 1, 2, 2, 0],
       device='cuda:0')
tensor([1, 2, 1, 2, 2, 2, 1, 1, 1, 2, 1, 2, 0, 2, 1, 0, 2, 2, 1, 1],
       device='cuda:0')
predicted:  tensor([1, 2, 1, 2, 2, 2, 0, 1, 0, 1, 1, 2, 0, 0, 1, 2, 2, 2, 0, 1],
       device='cuda:0')
tensor([0, 2, 1, 1, 0, 2, 1, 2, 1, 0, 2, 2, 0, 2, 0, 1, 2, 2, 1, 0],
       device='cuda:0')
predicted:  tensor([0, 2, 1, 1, 1, 2, 1, 0, 1, 0, 2, 2, 0, 0, 0, 0, 1, 2, 1, 2],
       device='cuda:0')
tensor([1, 0, 1, 1, 2, 2, 2, 0, 1, 2, 2, 2, 0, 2, 0, 1, 0, 1, 2, 0],
       device='cuda:0')
predicted:  tensor([0, 0, 0, 1, 2, 2, 2, 0, 1, 2, 2, 2, 0, 2, 0, 1, 0, 1, 2, 0],
       device='cuda:0')
tensor([1, 2, 0, 2, 0, 0, 0, 1, 0, 1, 2, 0, 2, 1, 1, 2, 1, 1, 0, 1],
       device='cuda:0')
predicted:  tensor([1, 2, 2, 2, 2, 0, 0, 1, 1, 1, 2, 2, 0, 1, 2, 2, 2, 0, 0, 0],
       device='cuda:0')
tensor([2, 2, 2, 0, 1, 2, 0, 0, 0, 0, 0, 1, 0, 2, 1, 1, 1, 2, 0, 2],
       device='cuda:0')
predicted:  tensor([2, 0, 2, 2, 1, 1, 0, 0, 0, 0, 0, 1, 0, 2, 1, 1, 1, 2, 0, 2],
       device='cuda:0')
tensor([0, 1, 0, 2, 0, 2, 0, 0, 2, 0, 1, 0, 2, 0, 1, 0, 1, 0, 1, 1],
       device='cuda:0')
predicted:  tensor([0, 1, 0, 1, 0, 0, 0, 0, 2, 0, 1, 0, 1, 1, 1, 0, 1, 0, 1, 0],
       device='cuda:0')
tensor([1, 0, 1, 1, 1, 2, 0, 1, 2, 1, 1, 2, 0, 2, 1, 1, 0, 0, 1, 1],
       device='cuda:0')
predicted:  tensor([2, 0, 1, 1, 1, 2, 0, 0, 2, 1, 1, 2, 1, 0, 1, 1, 0, 0, 0, 1],
       device='cuda:0')
tensor([2, 2, 1, 2, 2, 0, 1, 2, 2, 1, 1, 2, 1, 1, 1, 1, 2, 2, 1, 0],
       device='cuda:0')
predicted:  tensor([1, 2, 1, 2, 0, 0, 2, 2, 2, 1, 2, 2, 1, 1, 1, 2, 2, 2, 2, 0],
       device='cuda:0')
tensor([1, 1, 0, 0, 2, 0, 0, 0, 2, 0, 1, 0, 1, 2, 1, 1, 0, 1, 1, 2],
       device='cuda:0')
predicted:  tensor([0, 1, 2, 0, 2, 1, 2, 0, 2, 0, 1, 0, 1, 2, 2, 0, 0, 1, 1, 2],
       device='cuda:0')
tensor([2, 1, 2, 0, 1, 0, 2, 2, 2, 0, 1, 1, 2, 0, 0, 1, 0, 1, 1, 2],
       device='cuda:0')
predicted:  tensor([2, 1, 0, 1, 1, 0, 2, 2, 2, 0, 2, 0, 2, 0, 0, 1, 0, 1, 1, 2],
       device='cuda:0')
tensor([2, 1, 0, 1, 0, 1, 1, 2, 1, 0, 2, 2, 1, 2, 2, 1, 2, 1, 2, 1],
       device='cuda:0')
predicted:  tensor([2, 2, 0, 1, 2, 1, 1, 2, 1, 0, 2, 0, 1, 2, 2, 1, 2, 1, 2, 0],
       device='cuda:0')
tensor([1, 1, 1, 2, 1, 2, 2, 1, 2, 2, 0, 0, 2, 1, 2, 2, 1, 0, 2, 1],
       device='cuda:0')
predicted:  tensor([1, 1, 1, 1, 0, 2, 1, 1, 2, 2, 0, 0, 2, 0, 2, 2, 1, 2, 0, 0],
       device='cuda:0')
tensor([1, 1, 0, 0, 0, 2, 1, 1, 1, 1, 1, 1, 2, 2, 2, 1, 1, 2, 0, 0],
       device='cuda:0')
predicted:  tensor([1, 1, 0, 0, 2, 2, 1, 1, 1, 1, 1, 1, 1, 2, 2, 1, 0, 2, 0, 0],
       device='cuda:0')
tensor([2, 2, 1, 1, 1, 0, 0, 2, 2, 0, 1, 0, 0, 0, 2, 0, 2, 1, 2, 2],
       device='cuda:0')
predicted:  tensor([2, 2, 1, 1, 1, 0, 2, 0, 2, 0, 1, 0, 0, 0, 0, 0, 2, 1, 2, 2],
       device='cuda:0')
tensor([1, 2, 2, 1, 0, 0, 2, 1, 1, 2, 2, 1, 1, 2, 1, 1, 1, 0, 1, 2],
       device='cuda:0')
predicted:  tensor([1, 2, 1, 0, 2, 0, 0, 1, 1, 2, 2, 1, 0, 2, 1, 1, 1, 0, 1, 2],
       device='cuda:0')
tensor([1, 0, 2, 2, 1, 0, 0, 0, 0, 2, 2, 1, 2, 0, 2, 1, 2, 0, 1, 0],
       device='cuda:0')
predicted:  tensor([1, 0, 0, 2, 1, 2, 0, 0, 0, 2, 2, 1, 2, 1, 0, 2, 2, 2, 1, 1],
       device='cuda:0')
tensor([1, 1, 2, 1, 1, 2, 2, 1, 2, 1, 0, 2, 2, 0, 1, 1, 1, 2, 2, 2],
       device='cuda:0')
predicted:  tensor([0, 1, 2, 0, 1, 2, 2, 1, 0, 1, 0, 0, 0, 1, 0, 1, 1, 1, 2, 1],
       device='cuda:0')
tensor([2, 2, 2, 0, 1, 0, 2, 2, 1, 2, 0, 2, 2, 1, 2, 1, 1, 1, 2, 1],
       device='cuda:0')
predicted:  tensor([2, 2, 2, 2, 1, 0, 0, 2, 1, 2, 0, 0, 2, 2, 2, 1, 1, 0, 2, 1],
       device='cuda:0')
tensor([2, 1, 0, 2, 1, 1, 1, 2, 1, 2, 1, 1, 1, 0, 2, 0, 2, 1, 0, 2],
       device='cuda:0')
predicted:  tensor([2, 1, 0, 0, 1, 1, 1, 0, 2, 2, 1, 1, 1, 1, 2, 0, 2, 1, 0, 2],
       device='cuda:0')
tensor([2, 2, 2, 2, 0, 1, 2, 2, 1, 1, 2, 2, 1, 0, 2, 2, 2, 0, 2, 1],
       device='cuda:0')
predicted:  tensor([0, 0, 0, 2, 1, 1, 2, 2, 1, 1, 2, 1, 0, 0, 2, 0, 2, 0, 2, 1],
       device='cuda:0')
tensor([1, 1, 1, 1, 0, 2, 1, 0, 2, 1, 2, 1, 0, 2, 2, 1, 2, 1, 2, 1],
       device='cuda:0')
predicted:  tensor([0, 0, 1, 0, 2, 2, 1, 1, 0, 1, 0, 1, 0, 2, 0, 1, 2, 1, 0, 1],
       device='cuda:0')
tensor([1, 1, 0, 0, 1, 2, 0, 2, 1, 1, 2, 2, 2, 1, 1, 0, 0, 0, 2, 1],
       device='cuda:0')
predicted:  tensor([1, 1, 0, 1, 1, 2, 0, 2, 1, 2, 2, 2, 2, 1, 1, 0, 2, 2, 2, 1],
       device='cuda:0')
tensor([0, 0, 0, 2, 2, 2, 0, 0, 2, 2, 1, 0, 0, 2, 2, 0, 0, 1, 2, 2],
       device='cuda:0')
predicted:  tensor([0, 0, 0, 2, 2, 2, 0, 0, 0, 2, 1, 0, 0, 2, 2, 0, 0, 0, 2, 2],
       device='cuda:0')
tensor([2, 0, 2, 0, 1, 1, 0, 2, 1, 0, 1, 0, 2, 0, 0, 0, 0, 2, 1, 0],
       device='cuda:0')
predicted:  tensor([2, 0, 2, 0, 1, 2, 2, 2, 1, 0, 1, 2, 2, 0, 0, 0, 2, 2, 0, 0],
       device='cuda:0')
tensor([2, 2, 2, 1, 0, 0, 2, 1, 0, 1, 1, 0, 1, 0, 1, 2, 2, 2, 1, 1],
       device='cuda:0')
predicted:  tensor([2, 2, 2, 1, 0, 0, 2, 1, 2, 1, 1, 0, 1, 0, 1, 2, 2, 1, 1, 1],
       device='cuda:0')
tensor([2, 1, 2, 0, 1, 0, 1, 2, 2, 0, 2, 2, 0, 0, 2, 1, 0, 1, 2, 0],
       device='cuda:0')
predicted:  tensor([0, 1, 2, 0, 1, 1, 1, 2, 0, 0, 2, 2, 0, 0, 2, 1, 0, 1, 2, 0],
       device='cuda:0')
tensor([0, 2, 1, 2, 0, 1, 2, 1, 1, 1, 2, 2, 2, 1, 0, 0, 2, 1, 1, 2],
       device='cuda:0')
predicted:  tensor([2, 0, 2, 2, 2, 1, 2, 1, 1, 1, 0, 2, 0, 1, 0, 0, 2, 0, 1, 2],
       device='cuda:0')
tensor([1, 2, 2, 2, 0, 2, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 0, 0],
       device='cuda:0')
predicted:  tensor([1, 2, 2, 0, 0, 2, 2, 0, 1, 0, 1, 1, 1, 2, 1, 1, 1, 0, 2, 0],
       device='cuda:0')
tensor([1, 1, 2, 1, 2, 2, 0, 0, 2, 1, 2, 1, 0, 1, 0, 1, 2, 2, 2, 2],
       device='cuda:0')
predicted:  tensor([1, 1, 2, 1, 2, 2, 1, 1, 0, 1, 2, 1, 0, 1, 0, 1, 2, 2, 2, 2],
       device='cuda:0')
tensor([2, 2, 0, 1, 1, 1, 0, 0, 0, 2, 1, 2, 0, 1, 2, 2, 0, 2, 0, 0],
       device='cuda:0')
predicted:  tensor([2, 2, 0, 0, 1, 0, 2, 0, 2, 1, 2, 2, 0, 1, 2, 2, 0, 2, 0, 0],
       device='cuda:0')
tensor([2, 1, 2, 1, 0, 2, 1, 0, 1, 2, 0, 1, 0, 1, 1, 1, 1, 1, 0, 2],
       device='cuda:0')
predicted:  tensor([2, 2, 2, 1, 0, 2, 1, 0, 1, 2, 0, 2, 1, 1, 1, 1, 1, 2, 0, 2],
       device='cuda:0')
tensor([0, 1, 0, 1, 0, 1, 2, 2, 2, 0, 1, 1, 0, 0, 1, 2, 1, 2, 0, 1],
       device='cuda:0')
predicted:  tensor([0, 1, 0, 0, 0, 1, 2, 2, 2, 0, 1, 1, 0, 0, 1, 2, 1, 2, 1, 1],
       device='cuda:0')
tensor([2, 1, 1, 1, 0, 2, 2, 1, 0, 1, 1, 1, 2, 2, 1, 0, 0, 1, 0, 2],
       device='cuda:0')
predicted:  tensor([2, 1, 2, 1, 0, 2, 2, 1, 0, 1, 1, 1, 0, 0, 1, 1, 1, 0, 0, 2],
       device='cuda:0')
tensor([2, 2, 0, 1, 1, 1, 2, 1, 1, 2, 2, 1, 2, 1, 0, 1, 2, 1, 2, 0],
       device='cuda:0')
predicted:  tensor([2, 2, 1, 0, 0, 1, 2, 0, 1, 2, 2, 1, 2, 1, 2, 0, 1, 1, 2, 0],
       device='cuda:0')
tensor([0, 0, 0, 0, 2, 1, 0, 1, 2, 2, 0, 2, 2, 2, 0, 0, 1, 1, 1, 2],
       device='cuda:0')
predicted:  tensor([0, 0, 1, 0, 1, 1, 0, 1, 0, 2, 1, 2, 0, 2, 2, 0, 1, 1, 1, 0],
       device='cuda:0')
tensor([0, 0, 2, 1, 1, 0, 1, 1, 2, 1, 2, 0, 0, 0, 1, 2, 0, 0, 0, 0],
       device='cuda:0')
predicted:  tensor([2, 0, 2, 1, 0, 0, 0, 1, 2, 1, 2, 0, 1, 0, 1, 2, 2, 0, 0, 0],
       device='cuda:0')
tensor([0, 1, 1, 2, 1, 1, 2, 0, 1, 2, 1, 1, 1, 2, 2, 2, 0, 0, 2, 1],
       device='cuda:0')
predicted:  tensor([0, 1, 1, 2, 1, 0, 2, 0, 1, 2, 1, 1, 1, 2, 2, 2, 1, 0, 2, 1],
       device='cuda:0')
tensor([2, 2, 0, 2, 2, 0, 2, 0, 2, 1, 2, 0, 2, 1, 2, 0, 2, 2, 0, 0],
       device='cuda:0')
predicted:  tensor([2, 2, 0, 2, 2, 0, 0, 0, 2, 0, 2, 1, 2, 1, 1, 0, 0, 2, 0, 2],
       device='cuda:0')
tensor([1, 1, 1, 0, 2, 1, 1, 0, 2, 2, 2, 1, 1, 0, 1, 2, 0, 2, 1, 0],
       device='cuda:0')
predicted:  tensor([1, 1, 1, 0, 2, 1, 1, 0, 2, 2, 2, 1, 0, 0, 1, 2, 0, 2, 1, 1],
       device='cuda:0')
tensor([1, 1, 0, 1, 0, 0, 1, 2, 1, 2, 1, 1], device='cuda:0')
predicted:  tensor([2, 2, 0, 1, 0, 0, 0, 2, 1, 1, 0, 1], device='cuda:0')
Test accuracy: 75 %</code></pre>
</div>
</div>
<div class="cell" data-outputid="ebb177cf-dadf-4a3e-83a0-1532690a0a60">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>cf_matrix <span class="op">=</span> confusion_matrix(y_true_enet_female, y_pred_enet_female)</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cf_matrix)</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>classes <span class="op">=</span> [<span class="st">'White'</span>,<span class="st">'Black'</span>,<span class="st">'Asian'</span>]</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>df_cm <span class="op">=</span> pd.DataFrame(cf_matrix <span class="op">/</span> np.<span class="bu">sum</span>(cf_matrix, axis<span class="op">=</span><span class="dv">1</span>)[:, <span class="va">None</span>], index <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> classes],</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>                     columns <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> classes])</span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize <span class="op">=</span> (<span class="dv">12</span>,<span class="dv">7</span>))</span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="vs">r'Confusion matrix: BWA Equal with Exponential Scheduler, $\gamma = 0.735$, 2500 female patients, both frontal and lateral'</span>)</span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a>sns.heatmap(df_cm, annot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">'output.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[179  32  41]
 [ 60 268  26]
 [ 50  20 256]]</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-69-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="9ccf147b-578e-451c-8412-f2e24bd745a4">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>model_filename <span class="op">=</span> <span class="st">'/content/drive/Shareddrives/CheXpert-v1.0-small/efficientb0_10000_bwa_equal_exponential_scheduler(2).pth'</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>model_saved <span class="op">=</span> EfficientNet.from_pretrained(<span class="st">'efficientnet-b0'</span>,num_classes<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>checkpoint <span class="op">=</span> torch.load(model_filename, map_location<span class="op">=</span>device)</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Loading trained model weights...'</span>)</span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>model_saved.load_state_dict(checkpoint[<span class="st">'model_state_dict'</span>],strict<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>model_saved <span class="op">=</span> model_saved.to(device)</span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>test_dataset_male <span class="op">=</span> ChestXrayDataset(<span class="st">"/content/drive/Shareddrives/"</span>, df_test_bwa_equal_male[:<span class="dv">500</span>], IMAGE_SIZE, <span class="va">True</span>)</span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>test_dataloader_male <span class="op">=</span> DataLoader(dataset<span class="op">=</span>test_dataset_male, batch_size<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">False</span>, num_workers<span class="op">=</span><span class="dv">2</span>, pin_memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>test_dataset_female <span class="op">=</span> ChestXrayDataset(<span class="st">"/content/drive/Shareddrives/"</span>, df_test_bwa_equal_female[:<span class="dv">500</span>], IMAGE_SIZE, <span class="va">True</span>)</span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>test_dataloader_female <span class="op">=</span> DataLoader(dataset<span class="op">=</span>test_dataset_female, batch_size<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">False</span>, num_workers<span class="op">=</span><span class="dv">2</span>, pin_memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>y_pred_enet_male, y_true_enet_male <span class="op">=</span> test(model_saved,test_dataloader_male)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded pretrained weights for efficientnet-b0
Loading trained model weights...
tensor([0, 1, 0, 1, 2, 1, 2, 1, 0, 1, 1, 0, 0, 1, 0, 1, 1, 2, 0, 0],
       device='cuda:0')
predicted:  tensor([0, 1, 0, 1, 2, 0, 1, 1, 0, 1, 1, 0, 1, 1, 0, 0, 1, 0, 0, 2],
       device='cuda:0')
tensor([2, 0, 2, 0, 2, 2, 0, 1, 2, 0, 0, 0, 0, 0, 2, 1, 0, 0, 1, 2],
       device='cuda:0')
predicted:  tensor([0, 0, 2, 0, 2, 0, 1, 1, 2, 0, 1, 0, 1, 2, 2, 1, 0, 0, 1, 2],
       device='cuda:0')
tensor([2, 2, 0, 0, 2, 1, 2, 1, 2, 2, 1, 0, 0, 0, 2, 0, 2, 0, 1, 2],
       device='cuda:0')
predicted:  tensor([2, 2, 0, 0, 2, 1, 2, 0, 0, 2, 1, 0, 0, 2, 2, 0, 2, 0, 1, 0],
       device='cuda:0')
tensor([2, 2, 0, 2, 1, 1, 2, 1, 0, 1, 2, 1, 2, 1, 0, 0, 0, 0, 2, 2],
       device='cuda:0')
predicted:  tensor([2, 2, 0, 2, 1, 0, 2, 1, 1, 0, 2, 1, 1, 1, 0, 0, 0, 0, 0, 0],
       device='cuda:0')
tensor([1, 2, 0, 2, 0, 1, 0, 1, 2, 2, 0, 1, 2, 0, 0, 0, 1, 0, 0, 2],
       device='cuda:0')
predicted:  tensor([1, 2, 0, 2, 1, 1, 0, 1, 0, 1, 0, 1, 2, 1, 0, 0, 1, 0, 0, 2],
       device='cuda:0')
tensor([2, 2, 1, 2, 0, 1, 2, 1, 1, 2, 0, 1, 2, 1, 1, 1, 0, 1, 0, 2],
       device='cuda:0')
predicted:  tensor([0, 2, 1, 2, 0, 0, 2, 1, 1, 2, 1, 1, 0, 1, 0, 1, 2, 1, 0, 2],
       device='cuda:0')
tensor([0, 0, 0, 0, 2, 2, 2, 2, 1, 1, 1, 2, 0, 1, 1, 2, 0, 0, 1, 2],
       device='cuda:0')
predicted:  tensor([0, 0, 0, 0, 2, 2, 0, 2, 1, 1, 0, 2, 0, 0, 1, 2, 0, 0, 1, 2],
       device='cuda:0')
tensor([2, 0, 2, 2, 2, 2, 2, 0, 0, 0, 2, 0, 2, 1, 1, 0, 2, 1, 2, 0],
       device='cuda:0')
predicted:  tensor([1, 0, 2, 2, 2, 2, 2, 2, 0, 0, 2, 0, 2, 1, 1, 0, 2, 1, 2, 0],
       device='cuda:0')
tensor([2, 0, 0, 0, 0, 2, 0, 2, 0, 1, 2, 2, 0, 1, 0, 1, 0, 1, 0, 1],
       device='cuda:0')
predicted:  tensor([2, 0, 0, 0, 0, 0, 0, 2, 0, 1, 0, 2, 1, 1, 0, 1, 0, 1, 0, 1],
       device='cuda:0')
tensor([1, 0, 0, 1, 0, 0, 2, 2, 1, 0, 0, 2, 0, 2, 2, 1, 2, 0, 2, 1],
       device='cuda:0')
predicted:  tensor([1, 0, 0, 1, 1, 0, 1, 2, 1, 1, 0, 0, 2, 2, 2, 0, 2, 0, 2, 1],
       device='cuda:0')
tensor([0, 2, 1, 2, 1, 0, 1, 1, 2, 0, 0, 0, 0, 1, 2, 2, 2, 0, 2, 2],
       device='cuda:0')
predicted:  tensor([2, 2, 1, 2, 1, 2, 1, 0, 1, 0, 0, 0, 0, 1, 2, 2, 2, 0, 0, 2],
       device='cuda:0')
tensor([0, 0, 0, 0, 1, 1, 0, 0, 2, 0, 1, 0, 2, 2, 2, 2, 2, 1, 1, 0],
       device='cuda:0')
predicted:  tensor([2, 0, 0, 0, 1, 0, 0, 0, 2, 0, 1, 0, 2, 2, 0, 2, 2, 1, 1, 1],
       device='cuda:0')
tensor([0, 0, 0, 2, 2, 2, 1, 2, 0, 1, 0, 1, 2, 2, 2, 0, 2, 0, 0, 0],
       device='cuda:0')
predicted:  tensor([0, 0, 0, 1, 2, 1, 1, 2, 0, 1, 0, 0, 0, 1, 2, 0, 2, 0, 0, 0],
       device='cuda:0')
tensor([0, 0, 2, 0, 2, 0, 0, 1, 1, 0, 2, 0, 2, 2, 2, 1, 2, 2, 0, 0],
       device='cuda:0')
predicted:  tensor([0, 2, 0, 0, 2, 0, 0, 1, 1, 1, 2, 0, 0, 2, 2, 1, 2, 0, 2, 2],
       device='cuda:0')
tensor([0, 1, 0, 0, 0, 1, 0, 0, 2, 2, 1, 1, 0, 1, 2, 2, 0, 1, 0, 0],
       device='cuda:0')
predicted:  tensor([0, 1, 2, 1, 0, 1, 0, 1, 2, 2, 1, 0, 0, 0, 2, 2, 0, 1, 0, 0],
       device='cuda:0')
tensor([0, 1, 1, 0, 2, 2, 0, 0, 1, 0, 2, 1, 1, 2, 0, 0, 1, 0, 0, 0],
       device='cuda:0')
predicted:  tensor([0, 1, 1, 0, 2, 1, 0, 0, 1, 0, 2, 2, 0, 1, 0, 0, 0, 0, 0, 0],
       device='cuda:0')
tensor([1, 2, 0, 1, 2, 1, 1, 0, 1, 2, 1, 0, 1, 0, 0, 1, 1, 2, 0, 1],
       device='cuda:0')
predicted:  tensor([0, 2, 0, 1, 0, 1, 0, 0, 1, 2, 1, 0, 1, 0, 0, 1, 0, 2, 0, 1],
       device='cuda:0')
tensor([1, 2, 2, 0, 2, 2, 0, 0, 0, 2, 1, 0, 0, 0, 0, 0, 1, 2, 0, 1],
       device='cuda:0')
predicted:  tensor([1, 2, 0, 0, 2, 0, 1, 0, 0, 2, 1, 0, 0, 0, 0, 2, 1, 1, 0, 1],
       device='cuda:0')
tensor([0, 2, 2, 2, 1, 2, 0, 2, 1, 2, 2, 1, 2, 0, 1, 1, 0, 0, 1, 2],
       device='cuda:0')
predicted:  tensor([0, 2, 2, 0, 1, 0, 0, 2, 0, 0, 2, 1, 2, 0, 1, 1, 0, 0, 0, 2],
       device='cuda:0')
tensor([0, 0, 2, 0, 1, 2, 0, 0, 0, 0, 1, 0, 1, 2, 1, 0, 0, 0, 0, 2],
       device='cuda:0')
predicted:  tensor([0, 0, 2, 0, 1, 2, 1, 0, 2, 0, 1, 1, 1, 0, 0, 2, 0, 0, 0, 2],
       device='cuda:0')
tensor([2, 2, 1, 0, 1, 2, 2, 0, 1, 2, 2, 2, 0, 0, 2, 1, 1, 1, 0, 1],
       device='cuda:0')
predicted:  tensor([2, 0, 1, 0, 1, 2, 0, 2, 1, 2, 2, 2, 0, 0, 0, 1, 1, 1, 2, 1],
       device='cuda:0')
tensor([1, 1, 0, 2, 0, 1, 0, 1, 1, 2, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0],
       device='cuda:0')
predicted:  tensor([0, 1, 0, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 2, 0, 0, 0, 0, 0],
       device='cuda:0')
tensor([0, 0, 2, 2, 0, 1, 0, 1, 1, 2, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1],
       device='cuda:0')
predicted:  tensor([0, 0, 2, 2, 0, 1, 2, 2, 1, 2, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1],
       device='cuda:0')
tensor([0, 2, 1, 0, 2, 1, 0, 0, 0, 2, 2, 1, 0, 1, 2, 2, 1, 0, 0, 2],
       device='cuda:0')
predicted:  tensor([0, 2, 0, 0, 2, 1, 0, 0, 0, 2, 2, 1, 0, 1, 2, 2, 1, 1, 0, 2],
       device='cuda:0')
tensor([2, 0, 1, 0, 2, 2, 2, 0, 2, 0, 2, 1, 2, 0, 0, 1, 2, 0, 0, 0],
       device='cuda:0')
predicted:  tensor([2, 0, 1, 0, 2, 2, 2, 0, 2, 0, 0, 1, 2, 0, 0, 0, 2, 0, 0, 0],
       device='cuda:0')
Test accuracy: 77 %</code></pre>
</div>
</div>
<div class="cell" data-outputid="cb0c64db-c123-4cfd-a195-473cf166334a">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>cf_matrix <span class="op">=</span> confusion_matrix(y_true_enet_male, y_pred_enet_male)</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cf_matrix)</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>classes <span class="op">=</span> [<span class="st">'White'</span>,<span class="st">'Black'</span>,<span class="st">'Asian'</span>]</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>df_cm <span class="op">=</span> pd.DataFrame(cf_matrix <span class="op">/</span> np.<span class="bu">sum</span>(cf_matrix, axis<span class="op">=</span><span class="dv">1</span>)[:, <span class="va">None</span>], index <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> classes],</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>                     columns <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> classes])</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize <span class="op">=</span> (<span class="dv">12</span>,<span class="dv">7</span>))</span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="vs">r'Confusion matrix: BWA Equal with Exponential Scheduler, $\gamma = 0.8$, 2500 male patients, both frontal and lateral'</span>)</span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>sns.heatmap(df_cm, annot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">'output.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[168  20  19]
 [ 27 105   3]
 [ 33  12 113]]</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-71-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="e1f9e707-cf5e-4523-9987-20127cf02058">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>y_pred_enet_female, y_true_enet_female <span class="op">=</span> test(model_saved,test_dataloader_female)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tensor([1, 1, 1, 0, 2, 2, 1, 1, 2, 2, 1, 2, 0, 2, 1, 0, 0, 1, 1, 0],
       device='cuda:0')
predicted:  tensor([1, 1, 1, 0, 2, 2, 1, 0, 2, 2, 1, 2, 0, 2, 1, 2, 0, 1, 1, 0],
       device='cuda:0')
tensor([2, 0, 2, 2, 1, 2, 1, 0, 1, 0, 0, 1, 1, 0, 2, 0, 1, 2, 1, 1],
       device='cuda:0')
predicted:  tensor([1, 1, 2, 0, 0, 0, 1, 0, 1, 0, 1, 2, 2, 0, 0, 2, 1, 2, 1, 1],
       device='cuda:0')
tensor([1, 0, 2, 1, 2, 1, 1, 0, 1, 2, 1, 2, 2, 1, 1, 2, 2, 2, 2, 2],
       device='cuda:0')
predicted:  tensor([1, 1, 2, 0, 2, 1, 1, 0, 2, 2, 1, 2, 2, 1, 1, 2, 0, 2, 2, 2],
       device='cuda:0')
tensor([2, 2, 0, 1, 1, 2, 2, 1, 1, 2, 1, 0, 0, 0, 2, 0, 1, 0, 1, 2],
       device='cuda:0')
predicted:  tensor([2, 0, 0, 1, 1, 2, 2, 1, 2, 2, 1, 0, 0, 0, 2, 0, 1, 0, 1, 0],
       device='cuda:0')
tensor([1, 0, 2, 2, 0, 2, 1, 1, 0, 0, 2, 1, 2, 1, 1, 2, 1, 2, 1, 2],
       device='cuda:0')
predicted:  tensor([1, 0, 2, 2, 0, 2, 1, 1, 0, 0, 2, 1, 2, 1, 1, 2, 1, 2, 1, 2],
       device='cuda:0')
tensor([1, 2, 1, 0, 2, 1, 1, 1, 0, 0, 1, 0, 1, 2, 1, 0, 0, 1, 1, 2],
       device='cuda:0')
predicted:  tensor([1, 2, 1, 2, 0, 1, 1, 1, 1, 2, 1, 1, 1, 2, 0, 0, 0, 0, 1, 2],
       device='cuda:0')
tensor([2, 2, 0, 1, 0, 1, 2, 1, 1, 1, 2, 1, 0, 1, 2, 1, 1, 2, 2, 1],
       device='cuda:0')
predicted:  tensor([2, 2, 0, 1, 2, 1, 0, 1, 0, 1, 0, 1, 0, 1, 2, 1, 1, 2, 0, 2],
       device='cuda:0')
tensor([1, 2, 1, 2, 2, 2, 1, 1, 1, 2, 1, 2, 0, 2, 1, 0, 2, 2, 1, 1],
       device='cuda:0')
predicted:  tensor([1, 2, 1, 2, 1, 2, 0, 1, 0, 1, 1, 2, 0, 1, 1, 0, 2, 0, 0, 1],
       device='cuda:0')
tensor([0, 2, 1, 1, 0, 2, 1, 2, 1, 0, 2, 2, 0, 2, 0, 1, 2, 2, 1, 0],
       device='cuda:0')
predicted:  tensor([0, 0, 1, 1, 2, 2, 1, 2, 1, 0, 2, 1, 0, 0, 0, 2, 2, 2, 1, 0],
       device='cuda:0')
tensor([1, 0, 1, 1, 2, 2, 2, 0, 1, 2, 2, 2, 0, 2, 0, 1, 0, 1, 2, 0],
       device='cuda:0')
predicted:  tensor([0, 0, 0, 1, 2, 2, 2, 0, 1, 2, 2, 0, 0, 2, 0, 1, 0, 1, 2, 0],
       device='cuda:0')
tensor([1, 2, 0, 2, 0, 0, 0, 1, 0, 1, 2, 0, 2, 1, 1, 2, 1, 1, 0, 1],
       device='cuda:0')
predicted:  tensor([1, 2, 0, 2, 2, 0, 0, 1, 1, 1, 2, 2, 2, 1, 1, 2, 2, 0, 0, 0],
       device='cuda:0')
tensor([2, 2, 2, 0, 1, 2, 0, 0, 0, 0, 0, 1, 0, 2, 1, 1, 1, 2, 0, 2],
       device='cuda:0')
predicted:  tensor([2, 0, 0, 0, 1, 2, 0, 0, 2, 0, 0, 1, 0, 2, 0, 0, 1, 2, 1, 2],
       device='cuda:0')
tensor([0, 1, 0, 2, 0, 2, 0, 0, 2, 0, 1, 0, 2, 0, 1, 0, 1, 0, 1, 1],
       device='cuda:0')
predicted:  tensor([1, 1, 0, 0, 2, 0, 0, 0, 2, 0, 1, 0, 2, 1, 1, 1, 1, 0, 1, 0],
       device='cuda:0')
tensor([1, 0, 1, 1, 1, 2, 0, 1, 2, 1, 1, 2, 0, 2, 1, 1, 0, 0, 1, 1],
       device='cuda:0')
predicted:  tensor([1, 0, 1, 1, 1, 2, 2, 1, 2, 2, 1, 2, 2, 2, 1, 1, 1, 0, 1, 1],
       device='cuda:0')
tensor([2, 2, 1, 2, 2, 0, 1, 2, 2, 1, 1, 2, 1, 1, 1, 1, 2, 2, 1, 0],
       device='cuda:0')
predicted:  tensor([2, 2, 1, 2, 2, 0, 1, 0, 2, 0, 2, 2, 1, 1, 1, 1, 0, 1, 0, 0],
       device='cuda:0')
tensor([1, 1, 0, 0, 2, 0, 0, 0, 2, 0, 1, 0, 1, 2, 1, 1, 0, 1, 1, 2],
       device='cuda:0')
predicted:  tensor([0, 1, 0, 0, 2, 0, 2, 0, 2, 0, 1, 1, 1, 2, 2, 0, 0, 1, 1, 2],
       device='cuda:0')
tensor([2, 1, 2, 0, 1, 0, 2, 2, 2, 0, 1, 1, 2, 0, 0, 1, 0, 1, 1, 2],
       device='cuda:0')
predicted:  tensor([2, 1, 2, 1, 1, 0, 2, 2, 2, 0, 1, 0, 2, 0, 0, 1, 1, 1, 1, 2],
       device='cuda:0')
tensor([2, 1, 0, 1, 0, 1, 1, 2, 1, 0, 2, 2, 1, 2, 2, 1, 2, 1, 2, 1],
       device='cuda:0')
predicted:  tensor([2, 2, 0, 1, 0, 1, 1, 0, 1, 0, 2, 1, 1, 0, 2, 1, 2, 1, 2, 0],
       device='cuda:0')
tensor([1, 1, 1, 2, 1, 2, 2, 1, 2, 2, 0, 0, 2, 1, 2, 2, 1, 0, 2, 1],
       device='cuda:0')
predicted:  tensor([2, 0, 1, 2, 1, 2, 0, 1, 2, 2, 0, 2, 2, 0, 2, 2, 1, 0, 2, 0],
       device='cuda:0')
tensor([1, 1, 0, 0, 0, 2, 1, 1, 1, 1, 1, 1, 2, 2, 2, 1, 1, 2, 0, 0],
       device='cuda:0')
predicted:  tensor([1, 0, 0, 0, 0, 2, 1, 1, 1, 1, 0, 0, 1, 2, 2, 1, 1, 2, 0, 0],
       device='cuda:0')
tensor([2, 2, 1, 1, 1, 0, 0, 2, 2, 0, 1, 0, 0, 0, 2, 0, 2, 1, 2, 2],
       device='cuda:0')
predicted:  tensor([2, 2, 1, 1, 1, 0, 2, 1, 0, 0, 1, 0, 0, 0, 0, 0, 2, 1, 2, 2],
       device='cuda:0')
tensor([1, 2, 2, 1, 0, 0, 2, 1, 1, 2, 2, 1, 1, 2, 1, 1, 1, 0, 1, 2],
       device='cuda:0')
predicted:  tensor([1, 2, 1, 0, 2, 0, 2, 1, 1, 2, 2, 1, 0, 1, 1, 1, 1, 0, 1, 2],
       device='cuda:0')
tensor([1, 0, 2, 2, 1, 0, 0, 0, 0, 2, 2, 1, 2, 0, 2, 1, 2, 0, 1, 0],
       device='cuda:0')
predicted:  tensor([1, 0, 0, 2, 1, 0, 0, 0, 0, 2, 1, 1, 2, 1, 2, 1, 1, 0, 1, 2],
       device='cuda:0')
tensor([1, 1, 2, 1, 1, 2, 2, 1, 2, 1, 0, 2, 2, 0, 1, 1, 1, 2, 2, 2],
       device='cuda:0')
predicted:  tensor([0, 1, 2, 1, 1, 2, 2, 1, 0, 1, 0, 0, 0, 1, 0, 1, 1, 1, 2, 1],
       device='cuda:0')
tensor([2, 2, 2, 0, 1, 0, 2, 2, 1, 2, 0, 2, 2, 1, 2, 1, 1, 1, 2, 1],
       device='cuda:0')
predicted:  tensor([0, 2, 2, 2, 1, 0, 0, 2, 1, 2, 0, 0, 2, 1, 2, 1, 1, 0, 2, 1],
       device='cuda:0')
Test accuracy: 74 %</code></pre>
</div>
</div>
<div class="cell" data-outputid="eab0366e-8144-456d-eae0-f81774315d33">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>cf_matrix <span class="op">=</span> confusion_matrix(y_true_enet_female, y_pred_enet_female)</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cf_matrix)</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>classes <span class="op">=</span> [<span class="st">'White'</span>,<span class="st">'Black'</span>,<span class="st">'Asian'</span>]</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>df_cm <span class="op">=</span> pd.DataFrame(cf_matrix <span class="op">/</span> np.<span class="bu">sum</span>(cf_matrix, axis<span class="op">=</span><span class="dv">1</span>)[:, <span class="va">None</span>], index <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> classes],</span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>                     columns <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> classes])</span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize <span class="op">=</span> (<span class="dv">12</span>,<span class="dv">7</span>))</span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="vs">r'Confusion matrix: BWA Equal with Exponential Scheduler, $\gamma = 0.8$, 2500 female patients, both frontal and lateral'</span>)</span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>sns.heatmap(df_cm, annot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">'output.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[ 92  16  18]
 [ 33 153  12]
 [ 32  15 129]]</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="training_files/figure-html/cell-73-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="0c4badd7-7a00-407d-a327-d16b86611ed7">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>lr_params <span class="op">=</span> [<span class="fl">0.0001</span>,<span class="fl">0.0005</span>,<span class="fl">0.001</span>,<span class="fl">0.005</span>,<span class="fl">0.01</span>]</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>optimize(train_dataset,lr_params,max_epochs<span class="op">=</span><span class="dv">25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Param value:  0.0001
Fold:  0</code></pre>
</div>
</div>
<p>Resnet Self-Implementation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F <span class="co">#this is for relu</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ConvNet(nn.Module): <span class="co">#inherits from nn.module</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">super</span>().<span class="fu">__init__</span>() <span class="co">#run init method of parent class</span></span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Let's just define the functions we'll use later for forward</span></span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.conv1 <span class="op">=</span> nn.Conv2d(<span class="dv">3</span>, <span class="dv">100</span>, <span class="dv">5</span>) <span class="co">#3 input channels for rgb, 100 convolutional kernels, all size 5 by 5</span></span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.conv2 <span class="op">=</span> nn.Conv2d(<span class="dv">100</span>, <span class="dv">50</span>, <span class="dv">3</span>)</span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.conv3 <span class="op">=</span> nn.Conv2d(<span class="dv">50</span>, <span class="dv">20</span>, <span class="dv">3</span>)</span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-17"><a href="#cb128-17" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.pool <span class="op">=</span> nn.MaxPool2d(<span class="dv">2</span>,<span class="dv">2</span>) <span class="co">#largest pixel value from each 2 by 2 window</span></span>
<span id="cb128-18"><a href="#cb128-18" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.fc1 <span class="op">=</span> nn.Linear(<span class="dv">13520</span>,<span class="dv">80</span>)</span>
<span id="cb128-19"><a href="#cb128-19" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.fc2 <span class="op">=</span> nn.Linear(<span class="dv">80</span>,<span class="dv">40</span>)</span>
<span id="cb128-20"><a href="#cb128-20" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.fc3 <span class="op">=</span> nn.Linear(<span class="dv">40</span>,<span class="dv">2</span>) <span class="co">#only two outputs for the binary cat/dog label</span></span>
<span id="cb128-21"><a href="#cb128-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-22"><a href="#cb128-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> forward(<span class="va">self</span>,x):</span>
<span id="cb128-23"><a href="#cb128-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'x_shape:'</span>,x.shape)</span>
<span id="cb128-24"><a href="#cb128-24" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.pool(F.relu(<span class="va">self</span>.conv1(x))) <span class="co">#do kernel convolution to x, then do relu, then do max pooling</span></span>
<span id="cb128-25"><a href="#cb128-25" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.pool(F.relu(<span class="va">self</span>.conv2(x)))</span>
<span id="cb128-26"><a href="#cb128-26" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.pool(F.relu(<span class="va">self</span>.conv3(x)))</span>
<span id="cb128-27"><a href="#cb128-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-28"><a href="#cb128-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'x_shape:'</span>,x.shape)</span>
<span id="cb128-29"><a href="#cb128-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-30"><a href="#cb128-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">#DO NOT FORGET TO FLATTEN BEFORE LINEAR LAYERS</span></span>
<span id="cb128-31"><a href="#cb128-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-32"><a href="#cb128-32" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> torch.flatten(x,<span class="dv">1</span>)</span>
<span id="cb128-33"><a href="#cb128-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-34"><a href="#cb128-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'x_shape:'</span>,x.shape)</span>
<span id="cb128-35"><a href="#cb128-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-36"><a href="#cb128-36" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> F.relu(<span class="va">self</span>.fc1(x))</span>
<span id="cb128-37"><a href="#cb128-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-38"><a href="#cb128-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'x_shape:'</span>,x.shape)</span>
<span id="cb128-39"><a href="#cb128-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-40"><a href="#cb128-40" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> F.relu(<span class="va">self</span>.fc2(x))</span>
<span id="cb128-41"><a href="#cb128-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-42"><a href="#cb128-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'x_shape:'</span>,x.shape)</span>
<span id="cb128-43"><a href="#cb128-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-44"><a href="#cb128-44" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.fc3(x) <span class="co">#just return the output, no nonlinear lyaers</span></span>
<span id="cb128-45"><a href="#cb128-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-46"><a href="#cb128-46" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'x_shape:'</span>,x.shape)</span>
<span id="cb128-47"><a href="#cb128-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-48"><a href="#cb128-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x</span>
<span id="cb128-49"><a href="#cb128-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-50"><a href="#cb128-50" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> ConvNet().to(device)</span>
<span id="cb128-51"><a href="#cb128-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-52"><a href="#cb128-52" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb128-53"><a href="#cb128-53" aria-hidden="true" tabindex="-1"></a>torch.cuda.empty_cache()</span>
<span id="cb128-54"><a href="#cb128-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-55"><a href="#cb128-55" aria-hidden="true" tabindex="-1"></a>train(model, train_dataloader, optimizer, k_epochs <span class="op">=</span> <span class="dv">100</span>, print_every <span class="op">=</span> <span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co">#references https://arxiv.org/pdf/1512.03385.pdf, original resnet paper</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="co"># and https://blog.paperspace.com/writing-resnet-from-scratch-in-pytorch/ for pointers on code</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/microsoft/nni/blob/master/examples/trials/cifar10_pytorch/models/resnet.py</span></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Resnet(nn.Module):</span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">"""</span></span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a><span class="co">  for now I'm doing the 34 version</span></span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a><span class="co">  """</span></span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, num_classes):</span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">super</span>(Resnet,<span class="va">self</span>).<span class="fu">__init__</span>() <span class="co">#is (Resnet,self) necessary?</span></span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">#want to take matrix 224*224 to 112*112, padding 3 ensures that each kernel </span></span>
<span id="cb129-17"><a href="#cb129-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># centered on pixel in matrix, stride =2 makes it every other pixel, hence dimension is half</span></span>
<span id="cb129-18"><a href="#cb129-18" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.conv1 <span class="op">=</span> nn.Sequential(</span>
<span id="cb129-19"><a href="#cb129-19" aria-hidden="true" tabindex="-1"></a>      nn.Conv2d(in_channels <span class="op">=</span> <span class="dv">3</span>, out_channels <span class="op">=</span> <span class="dv">64</span>, kernel_size <span class="op">=</span> <span class="dv">7</span>, stride <span class="op">=</span> <span class="dv">2</span>, padding<span class="op">=</span><span class="dv">3</span>), </span>
<span id="cb129-20"><a href="#cb129-20" aria-hidden="true" tabindex="-1"></a>      nn.BatchNorm2d(num_features <span class="op">=</span> <span class="dv">64</span>),</span>
<span id="cb129-21"><a href="#cb129-21" aria-hidden="true" tabindex="-1"></a>      nn.ReLU()</span>
<span id="cb129-22"><a href="#cb129-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb129-23"><a href="#cb129-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">#now do 3 by 3 max pool, similarly need padding 1 to make sure kernel</span></span>
<span id="cb129-24"><a href="#cb129-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># centered on each pixel, stride=2 make it other pixel, dimension 56*56</span></span>
<span id="cb129-25"><a href="#cb129-25" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.maxpool <span class="op">=</span> nn.MaxPool2d(kernel_size <span class="op">=</span> <span class="dv">3</span>,stride<span class="op">=</span><span class="dv">2</span>,padding<span class="op">=</span><span class="dv">1</span>) <span class="co">#not sure why there is padding</span></span>
<span id="cb129-26"><a href="#cb129-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-27"><a href="#cb129-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">#each time we reduce the size of the matrix by half, hence stride of 2 (for conv2_x, maxpool reduced dimension)</span></span>
<span id="cb129-28"><a href="#cb129-28" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.conv2_x <span class="op">=</span> <span class="va">self</span>.make_conv_layer(<span class="dv">64</span>,<span class="dv">64</span>,kernel_size <span class="op">=</span> <span class="dv">3</span>, stride <span class="op">=</span> <span class="dv">1</span>, num_layers <span class="op">=</span> <span class="dv">3</span>)</span>
<span id="cb129-29"><a href="#cb129-29" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.conv3_x <span class="op">=</span> <span class="va">self</span>.make_conv_layer(<span class="dv">64</span>,<span class="dv">128</span>,kernel_size <span class="op">=</span> <span class="dv">3</span>, stride <span class="op">=</span> <span class="dv">2</span>, num_layers <span class="op">=</span> <span class="dv">4</span>)</span>
<span id="cb129-30"><a href="#cb129-30" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.conv4_x <span class="op">=</span> <span class="va">self</span>.make_conv_layer(<span class="dv">128</span>,<span class="dv">256</span>,kernel_size <span class="op">=</span> <span class="dv">3</span>, stride <span class="op">=</span> <span class="dv">2</span>, num_layers <span class="op">=</span> <span class="dv">6</span>)</span>
<span id="cb129-31"><a href="#cb129-31" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.conv5_x <span class="op">=</span> <span class="va">self</span>.make_conv_layer(<span class="dv">256</span>,<span class="dv">512</span>,kernel_size <span class="op">=</span> <span class="dv">3</span>, stride <span class="op">=</span> <span class="dv">2</span>, num_layers <span class="op">=</span> <span class="dv">3</span>)</span>
<span id="cb129-32"><a href="#cb129-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-33"><a href="#cb129-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">#size is now [512,7,7], want it to be [512,1,1] so kernel size 7</span></span>
<span id="cb129-34"><a href="#cb129-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">#self.avgpool = nn.AvgPool2d(kernel_size = 7,stride = 1) #no idea why this is 7</span></span>
<span id="cb129-35"><a href="#cb129-35" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.avgpool <span class="op">=</span> nn.AdaptiveAvgPool2d((<span class="dv">1</span>,<span class="dv">1</span>)) <span class="co">#this is what preloaded resnet34 has</span></span>
<span id="cb129-36"><a href="#cb129-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-37"><a href="#cb129-37" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.fc <span class="op">=</span> nn.Linear(<span class="dv">512</span>,num_classes)</span>
<span id="cb129-38"><a href="#cb129-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-39"><a href="#cb129-39" aria-hidden="true" tabindex="-1"></a>  <span class="co">#this is specific to resnet 34</span></span>
<span id="cb129-40"><a href="#cb129-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> make_conv_layer(<span class="va">self</span>,in_channels, out_channels, kernel_size, stride, num_layers):</span>
<span id="cb129-41"><a href="#cb129-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">#conv 1 - 64 out, conv2 - 64 in 64 out, 64 in 64 out, 64 in 64 out, conv3 - 64 in 128 out, 128 in 128 out</span></span>
<span id="cb129-42"><a href="#cb129-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-43"><a href="#cb129-43" aria-hidden="true" tabindex="-1"></a>    layer_list <span class="op">=</span> []</span>
<span id="cb129-44"><a href="#cb129-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-45"><a href="#cb129-45" aria-hidden="true" tabindex="-1"></a>    in_ch <span class="op">=</span> in_channels</span>
<span id="cb129-46"><a href="#cb129-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb129-47"><a href="#cb129-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># first block is input stride, reset are stride of 1</span></span>
<span id="cb129-48"><a href="#cb129-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-49"><a href="#cb129-49" aria-hidden="true" tabindex="-1"></a>    layer_list.append(ResidualBlock(in_ch,out_channels,kernel_size,stride))</span>
<span id="cb129-50"><a href="#cb129-50" aria-hidden="true" tabindex="-1"></a>    in_ch <span class="op">=</span> out_channels</span>
<span id="cb129-51"><a href="#cb129-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-52"><a href="#cb129-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>,num_layers):</span>
<span id="cb129-53"><a href="#cb129-53" aria-hidden="true" tabindex="-1"></a>      layer_list.append(ResidualBlock(in_ch,out_channels,kernel_size,stride<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb129-54"><a href="#cb129-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-55"><a href="#cb129-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> nn.Sequential(<span class="op">*</span>layer_list)</span>
<span id="cb129-56"><a href="#cb129-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-57"><a href="#cb129-57" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> forward(<span class="va">self</span>,x):</span>
<span id="cb129-58"><a href="#cb129-58" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.conv1(x)</span>
<span id="cb129-59"><a href="#cb129-59" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.maxpool(x)</span>
<span id="cb129-60"><a href="#cb129-60" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.conv2_x(x)</span>
<span id="cb129-61"><a href="#cb129-61" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.conv3_x(x)</span>
<span id="cb129-62"><a href="#cb129-62" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.conv4_x(x)</span>
<span id="cb129-63"><a href="#cb129-63" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.conv5_x(x)</span>
<span id="cb129-64"><a href="#cb129-64" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.avgpool(x)</span>
<span id="cb129-65"><a href="#cb129-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-66"><a href="#cb129-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">#x = torch.flatten(x)</span></span>
<span id="cb129-67"><a href="#cb129-67" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> x.view(x.size(<span class="dv">0</span>), <span class="op">-</span><span class="dv">1</span>) <span class="co">#not sure why but flatten doesn't work</span></span>
<span id="cb129-68"><a href="#cb129-68" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="va">self</span>.fc(x)</span>
<span id="cb129-69"><a href="#cb129-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x</span>
<span id="cb129-70"><a href="#cb129-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-71"><a href="#cb129-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-72"><a href="#cb129-72" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ResidualBlock(nn.Module):</span>
<span id="cb129-73"><a href="#cb129-73" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,in_channels,out_channels,kernel_size,stride):</span>
<span id="cb129-74"><a href="#cb129-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb129-75"><a href="#cb129-75" aria-hidden="true" tabindex="-1"></a><span class="co">    Some math, input kernel to conv2_x is [64,56,56], can just do stride 1, size maintained</span></span>
<span id="cb129-76"><a href="#cb129-76" aria-hidden="true" tabindex="-1"></a><span class="co">    Input kernel to conv3_x is [64,56,56] want [128,28,28], after convolutions x is [128,28,28] (stride 2 at first then stride 1),</span></span>
<span id="cb129-77"><a href="#cb129-77" aria-hidden="true" tabindex="-1"></a><span class="co">    But x is still [64,56,56], so no padding, use kernel size 1 with 128 outchannels and stride 2</span></span>
<span id="cb129-78"><a href="#cb129-78" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb129-79"><a href="#cb129-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-80"><a href="#cb129-80" aria-hidden="true" tabindex="-1"></a>    <span class="bu">super</span>(ResidualBlock,<span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb129-81"><a href="#cb129-81" aria-hidden="true" tabindex="-1"></a>    <span class="co">#again note padding here is 1 because kernel is 3 by 3</span></span>
<span id="cb129-82"><a href="#cb129-82" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.conv1 <span class="op">=</span> nn.Sequential(</span>
<span id="cb129-83"><a href="#cb129-83" aria-hidden="true" tabindex="-1"></a>        nn.Conv2d(in_channels <span class="op">=</span> in_channels, out_channels <span class="op">=</span> out_channels, kernel_size <span class="op">=</span> <span class="dv">3</span>, stride <span class="op">=</span> stride, padding <span class="op">=</span> <span class="dv">1</span>),</span>
<span id="cb129-84"><a href="#cb129-84" aria-hidden="true" tabindex="-1"></a>        nn.BatchNorm2d(num_features <span class="op">=</span> out_channels),</span>
<span id="cb129-85"><a href="#cb129-85" aria-hidden="true" tabindex="-1"></a>        nn.ReLU()</span>
<span id="cb129-86"><a href="#cb129-86" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb129-87"><a href="#cb129-87" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.conv2 <span class="op">=</span> nn.Sequential(</span>
<span id="cb129-88"><a href="#cb129-88" aria-hidden="true" tabindex="-1"></a>        nn.Conv2d(in_channels <span class="op">=</span> out_channels, out_channels <span class="op">=</span> out_channels, kernel_size <span class="op">=</span> <span class="dv">3</span>, stride <span class="op">=</span> <span class="dv">1</span>, padding <span class="op">=</span> <span class="dv">1</span>),</span>
<span id="cb129-89"><a href="#cb129-89" aria-hidden="true" tabindex="-1"></a>        nn.BatchNorm2d(num_features <span class="op">=</span> out_channels) <span class="co">#don't do ReLU here since we might downsample</span></span>
<span id="cb129-90"><a href="#cb129-90" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb129-91"><a href="#cb129-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-92"><a href="#cb129-92" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.skip_connection <span class="op">=</span> nn.Sequential() <span class="co">#identity</span></span>
<span id="cb129-93"><a href="#cb129-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-94"><a href="#cb129-94" aria-hidden="true" tabindex="-1"></a>    <span class="co">#idea here is that skip_connection will add the input x to itself</span></span>
<span id="cb129-95"><a href="#cb129-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># but if stride != 1 or in_channels != out_channels, we need to change dimensions of x</span></span>
<span id="cb129-96"><a href="#cb129-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># so that the dimensions of x after conv1 and conv2 applied</span></span>
<span id="cb129-97"><a href="#cb129-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> stride <span class="op">!=</span> <span class="dv">1</span> <span class="kw">or</span> in_channels <span class="op">!=</span> out_channels:</span>
<span id="cb129-98"><a href="#cb129-98" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.skip_connection <span class="op">=</span> nn.Sequential(</span>
<span id="cb129-99"><a href="#cb129-99" aria-hidden="true" tabindex="-1"></a>          nn.Conv2d(in_channels,out_channels,kernel_size<span class="op">=</span><span class="dv">1</span>,stride<span class="op">=</span>stride),</span>
<span id="cb129-100"><a href="#cb129-100" aria-hidden="true" tabindex="-1"></a>          nn.BatchNorm2d(num_features <span class="op">=</span> out_channels)</span>
<span id="cb129-101"><a href="#cb129-101" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb129-102"><a href="#cb129-102" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.ReLU <span class="op">=</span> nn.ReLU()</span>
<span id="cb129-103"><a href="#cb129-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-104"><a href="#cb129-104" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> forward(<span class="va">self</span>,x):</span>
<span id="cb129-105"><a href="#cb129-105" aria-hidden="true" tabindex="-1"></a>    x_layer <span class="op">=</span> <span class="va">self</span>.conv1(x)</span>
<span id="cb129-106"><a href="#cb129-106" aria-hidden="true" tabindex="-1"></a>    x_layer <span class="op">=</span> <span class="va">self</span>.conv2(x_layer)</span>
<span id="cb129-107"><a href="#cb129-107" aria-hidden="true" tabindex="-1"></a>    x_layer <span class="op">+=</span> <span class="va">self</span>.skip_connection(x)</span>
<span id="cb129-108"><a href="#cb129-108" aria-hidden="true" tabindex="-1"></a>    x_layer <span class="op">=</span> <span class="va">self</span>.ReLU(x_layer)</span>
<span id="cb129-109"><a href="#cb129-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x_layer</span>
<span id="cb129-110"><a href="#cb129-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-111"><a href="#cb129-111" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>